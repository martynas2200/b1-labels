// ==UserScript==
// @name              Label Generator for the items in b1.lt
// @namespace         http://tampermonkey.net/
// @homepage          https://github.com/martynas2200/b1-labels
// @version           1.2.0
// @description       Generate labels for the selected items on the b1.lt website
// @author            Martynas Miliauskas
// @match             https://www.b1.lt/*
// @icon              https://b1.lt/favicon.ico
// @connect           b1.lt
// @connect           raw.githubusercontent.com
// @downloadURL       https://raw.githubusercontent.com/martynas2200/b1-labels/main/dist/script.user.js
// @updateURL         https://raw.githubusercontent.com/martynas2200/b1-labels/main/dist/script.user.js
// @grant             GM.setValue
// @grant             GM.getValue
// @grant             unsafeWindow
// @grant             GM_xmlhttpRequest
// @license           GNU GPLv3
// ==/UserScript==

!function(){"use strict";function e(e){return e.replace(/ą/g,"1").replace(/č/g,"2").replace(/ę/g,"3").replace(/ė/g,"4").replace(/į/g,"5").replace(/š/g,"6").replace(/ų/g,"7").replace(/ū/g,"8").replace(/ž/g,"9")}const t={en:{aboutToCheckPackageCode:"A check for the package codes will be performed, this may take a while",add:"Add",addDescription:"Add Description",addManufacturer:"Add Manufacturer",ageLimit:"Age Limit",alternativeLabelFormat:"Enable alternative label format",apiKeyMissing:"API Key is missing!",askingForPackageCode:"Are there any selected items that have a package code?",attributeName:"Attribute Name",autoLogin:"Instant Login",autoPrint:"Auto Print",barcode:"Barcode",barcodeOrName:"Barcode or name",batchNumber:"Batch Number",cleanAll:"Clean All",clearAfterPrint:"Clear after print",clickToAdd:"Click on the item to add it to the print list",close:"Close",code:"Code",cost:"Cost",countryOfOriginName:"Country of Origin Name",defaultSaleService:"Default Sale Service",departmentNumber:"Department",deposit:"Deposit",description:"Description",discountPointsStatus:"Discount Points Status",discountStatus:"Discount Status",done:"Done",enterBarcode:"Enter the barcode",enterName:"Enter Name",error:"Error",expiryDate:"Expiry Date",fitRaso:"Fit Raso",freePrice:"Free Price",fullBarcode:"Full Barcode",fullName:"Full Name",grossWeight:"Gross Weight",groupName:"Group Name",help:"If you have any problems, contact Martynas",inactiveItem:"The item is inactive. Do you want to continue?",invalidBarcode:"Invalid barcode",isActive:"Is Active",isCommentRequired:"Is Comment Required",isQuantitative:"Is Quantitative",isRefundable:"Is Refundable",itemAdded:"Item added",itemDetails:"Item Details",itemNotFound:"Item not found!",itemsFound:"Items found",kiloPrice:"Price per kilo",labelsAndPrices:"Labels and Prices",leftover:"Leftover",login:"Login",loginDetailsNotFound:"Login details not found",manufacturerName:"Manufacturer Name",maxDiscount:"Max Discount",measurementUnitCanBeWeighed:"Measurement Unit Can Be Weighed",measurementUnitName:"Measurement Unit Name",minPriceWithVat:"Min Price With VAT",minQuantity:"Min Quantity",missingBarcode:"Missing barcode",missingElements:"Missing UI elements",missingName:"Missing name",missingWeight:"Missing weight",name:"Name",netWeight:"Net Weight",nlabelsToBePrinted:" labels to be printed",noData:"No data to print!",noItemsFound:"No items found",noItemsScanned:"No items scanned",noItemsSelected:"No items selected!",notAllItemsActive:"Not all selected items are active. Do you want to continue?",packageCode:"Package",packagedGoodsWillBeScanned:"Packaged goods will be scanned",packageQuantity:"Package Quantity",priceFrom:"Price From",priceMinQuantity:"Price Min Quantity",pricePerKg:"Price per kg",priceUntil:"Price Until",priceWithoutVat:"Price Without VAT",priceWithVat:"Price With VAT",print:"Print",printJobIsSent:"Print job is sent",readyForScan:"Ready for scan",resetForm:"Reset form",results:"Results",save:"Save",sayOutLoud:"Say out loud",scanOrEnterName:"Scan or enter the name",search:"Search",searchByBarcode:"Search by Barcode",searchByName:"Search by Name",searchingFor:"Searching for",searchSuccessful:"Search successful",showLoginOptions:"Other ways to login",simplifyForm:"Simplify Form",stock:"Stock",totalPrice:"Total Price",validFrom:"Valid From",validUntil:"Valid Until",vatRate:"VAT Rate",weight:"Weight",weightedItem:"Weighted item",weightedItemAdded:"Weighted item added",weightLabel:"Weight Label"},lt:{aboutToCheckPackageCode:"Bus atliekamas pakuotės kodų tikrinimas, tai gali užtrukti",add:"Pridėti",addDescription:"Pridėti aprašymą",addManufacturer:"Pridėti gamintoją",ageLimit:"Amžiaus limitas",alternativeLabelFormat:"Etiketėje tik brūkšninis kodas",apiKeyMissing:"Trūksta API rakto!",askingForPackageCode:"Ar yra pasirinktų prekių, kurios turi pakuotės kodą?",attributeName:"Atributo pavadinimas",autoLogin:"Prisijungti automatiškai",autoPrint:"Automatiškai spausdinti",barcode:"Brūkšninis kodas",barcodeOrName:"Brūkšninis kodas arba pavadinimas",batchNumber:"Serijos numeris",cleanAll:"Išvalyti",clearAfterPrint:"Išvalyti po spausdinimo",clickToAdd:"Paspauskite ant prekės, kad ją pridėtumėte į spausdinimo sąrašą",close:"Uždaryti",code:"Kodas",cost:"Savikaina",countryOfOriginName:"Kilmės šalies pavadinimas",defaultSaleService:"Numatytoji pardavimo paslauga",departmentNumber:"S",deposit:"Tara",description:"Aprašymas",discountPointsStatus:"Nuolaidų taškų statusas",discountStatus:"Nuolaidos statusas",done:"Atlikta",enterBarcode:"Įveskite brūkšninį kodą",enterName:"Įveskite prekės pavadinimą",error:"Įvyko klaida",expiryDate:"Galiojimo data",fitRaso:"Tinkamas RASO importui",freePrice:"Laisva kaina",fullBarcode:"Pilnas brūkšninis kodas",fullName:"Pilnas pavadinimas",grossWeight:"Bendras svoris",groupName:"Grupės pavadinimas",help:"Jei kyla problemų, kreiptis pas Martyną",inactiveItem:"Prekė yra neaktyvi. Ar norite tęsti?",invalidBarcode:"Neteisingas brūkšninis kodas",isActive:"Aktyvus",isCommentRequired:"Komentaro reikalavimas",isQuantitative:"Kiekinė",isRefundable:"Grąžinimo galimybė",itemAdded:"Prekė pridėta",itemDetails:"Prekės informacija",itemNotFound:"Prekė nerasta!",itemsFound:" rasta",kiloPrice:"Kilogramo kaina",labelsAndPrices:"Etiketės ir kainos",leftover:"Liko",login:"Prisijungimas darbo vietoje",loginDetailsNotFound:"Prisijungimo duomenys nerasti",manufacturerName:"Gamintojo pavadinimas",maxDiscount:"Max nuolaida",measurementUnitCanBeWeighed:"Prekė gali būti sveriama",measurementUnitName:"Matavimo vieneto pavadinimas",minPriceWithVat:"Min kaina su PVM",minQuantity:"Min kiekis",missingBarcode:"Trūksta brūkšninio kodo",missingElements:"Trūksta UI elementų",missingName:"Trūksta pavadinimo",missingWeight:"Trūksta svorio",name:"Pavadinimas",netWeight:"Neto svoris",nlabelsToBePrinted:" etiketės bus spausdinamos",noData:"Nepakanka duomenų spausdinimui!",noItemsFound:"Nieko nerasta",noItemsScanned:"Nėra skenuotų prekių",noItemsSelected:"Nėra pasirinktų prekių",notAllItemsActive:"Ne visos pasirinktos prekės yra aktyvios. Ar norite tęsti?",packageCode:"Pakuotė",packagedGoodsWillBeScanned:"Bus skenuojamos fasuotos/sveriamos prekės",packageQuantity:"Pakuotės kiekis",priceFrom:"Kaina nuo",priceMinQuantity:"Kaina min kiekis",pricePerKg:"Kaina už 1 kg",priceUntil:"Kaina iki",priceWithoutVat:"Kaina be PVM",priceWithVat:"Kaina su PVM",print:"Spausdinti",printJobIsSent:"Spausdinimo užduotis nusiųsta",readyForScan:"Pasiruošęs skenavimui",resetForm:"Atkurti formą",results:"Rezultatai",save:"Išsaugoti",sayOutLoud:"Sakyti kainas balsu",scanOrEnterName:"Skenuokite arba įveskite pavadinimą",search:"Ieškoti",searchByBarcode:"Ieškoti pagal brūkšninį kodą",searchByName:"Ieškoti pagal pavadinimą",searchingFor:"Ieškoma",searchSuccessful:"Paieška sėkminga",showLoginOptions:"Kiti prisijungimo būdai",simplifyForm:"Supaprastinti formą",stock:"Likutis",totalPrice:"Apskaičiuota kaina",validFrom:"Galioja nuo",validUntil:"Galioja iki",vatRate:"PVM tarifas",weight:"Svoris",weightedItem:"Sveriama prekė",weightedItemAdded:"Sveriama prekė pridėta",weightLabel:"Svorio etiketė"}};let i=navigator.language.split("-")[0];const a=window.location.pathname;/\/(en|ru)\//.test(a)&&(i="en");const n=null!=t[i]?i:"en",s=e=>t[n][e]??t.en[e]??e;class o{notificationService;constructor(){const e=document.querySelector("[ng-app]");if(null===e)throw new Error("Angular app not found");try{const t=angular.element(e).injector();this.notificationService=t.get("Notification")}catch(e){console.error("Failed to get Notification service",e),alert("Failed to get Notification service"),this.notificationService={info:e=>alert(e),error:e=>alert(e),success:e=>alert(e),warning:e=>alert(e),primary:e=>alert(e)}}}info(e){this.notificationService.info(e)}error(e){this.notificationService.error(e)}success(e){this.notificationService.success(e)}warning(e){this.notificationService.warning(e)}primary(e){this.notificationService.primary(e)}}class r{notification=new o;interfaceInUse=!1;isLoggedIn=!1;admin=!1;user;constructor(){this.user=null,this.checkLoginStatus()}checkLoginStatus(){return null!=currentUser?.name?(this.isLoggedIn=!0,this.user=currentUser,this.admin=null!=this.user&&this.user.typeId<=3,this.admin||this.limitPermissions(),!0):(null!=currentUser&&null==currentUser.name&&(this.isLoggedIn=!1),!1)}limitPermissions(){currentCompanyUser.permissions.crudKlientai={create:!1,read:!1,update:!1,delete:!1},currentCompanyUser.permissions.crudBankaisaskait={create:!1,read:!1,update:!1,delete:!1},currentCompanyUser.permissions.crudPardavim={create:!1,read:!1,update:!1,delete:!1},currentCompanyUser.permissions.crudPrekes={create:!1,read:!0,update:!1,delete:!1},currentCompanyUser.permissions.crudDokSer={create:!1,read:!1,update:!1,delete:!1}}addContainer(){document.querySelectorAll("h5").forEach((e=>{e.remove()}));const e=document.querySelector("form"),t=`\n      <h5 class="header blue">${s("login")}</h5>\n      <div class="form-group text-center">\n      <button class="btn btn-success-2 btn-block " type="button" id="auto-login"><i class="fa fa-sign-in"></i>${s("autoLogin")}</button>\n      <button class="btn-primary btn btn-block margin-top-8" type="button" id="show-login-options">${s("showLoginOptions")}</button>\n      </div>`;return null!==e?(e.insertAdjacentHTML("beforebegin",t),e.style.display="none",!0):(console.error("Form not found!"),!1)}addLoginOptions(){if(!this.addContainer())return!1;const e=document.querySelector("#show-login-options"),t=document.querySelector("#auto-login"),i=document.querySelector("form");return null!==e&&null!==t&&null!==i&&(e.addEventListener("click",(function(){i.style.display="block",e.style.display="none"})),t.addEventListener("click",(()=>{this.autoLogin()})),!0)}async autoLogin(){const e=document.querySelector('input[name="username"]'),t=document.querySelector('input[name="password"]');if(null===e||null===t)return this.notification.error(s("loginDetailsNotFound")),!1;const i=await GM.getValue("username",""),a=await GM.getValue("password","");if(""===i||""===a)return this.notification.error(s("loginDetailsNotFound")),"x"===e.value&&"x"===t.value&&this.saveLoginDetails(),!1;e.value=i,t.value=a,e.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("input",{bubbles:!0}));const n=document.querySelector("form");if(null===n)return this.notification.error(s("error")),!1;let o=n.getAttribute("ng-submit");if(null===o)return this.notification.error("Recaptcha key not found"),!1;const r=o.match(/"([^"]+)"/);return null===r?(this.notification.error("Recaptcha key not found"),!1):(o=r[1],angular.element(n).controller().signIn(o),!0)}async saveLoginDetails(){if(window.confirm("Do you want to save these login details?")){const e=window.prompt("Enter your username"),t=window.prompt("Enter your password");null!=e&&null!=t&&(await GM.setValue("username",e),await GM.setValue("password",t),alert("Login details saved"))}if(!window.confirm("Do you want to save API key?"))return;const e=window.prompt("Enter your API key");null!==e&&(await GM.setValue("api-key",e),alert("API key saved"))}}class l{items={};baseUrl="https://www.b1.lt";path="/reference-book/items/search";csrfToken;headers;constructor(){const e=document.querySelector('meta[name="csrf-token"]');this.csrfToken=null!=e?e.content:"",this.headers={accept:"application/json, text/plain, */*","accept-language":"en-GB,en;q=0.9,lt-LT;q=0.8,lt;q=0.7,en-US;q=0.6","content-type":"application/json;charset=UTF-8",origin:this.baseUrl,referer:`${this.baseUrl}/reference-book/items`,"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-origin","x-requested-with":"XMLHttpRequest","x-csrf-token":this.csrfToken,cookie:""}}async fetchData(e,t,i={}){if(""!==this.csrfToken){this.getCookies();try{const a=await fetch(`${this.baseUrl}${t}`,{method:e,headers:this.headers,body:JSON.stringify(i)});if(a.ok){return await a.json()}console.error("Request failed with status:",a.status)}catch(e){console.error("Error:",e)}}else console.error("CSRF token is missing")}getCookies(){document.cookie.split(";").map((e=>e.trim())).forEach((e=>{const[t,i]=e.split("=");["_fbp","YII_CSRF_TOKEN","b1-device_id","b1-session_id","b1-use-cookies","b1-wss_srv","_ga","b1-ref_url","_ga_F9V3KM1JRX"].includes(t.trim())&&(this.headers.cookie=this.headers.cookie.length>0?`${this.headers.cookie}; ${t}=${i}`:`${t}=${i}`)}))}isItDigits(e){return/^\d+$/.test(e)}async getItem(e){if(!this.isItDigits(e))return null;if(Object.keys(this.items).includes(e))return null!=this.items[e]?JSON.parse(JSON.stringify(this.items[e])):null;const t={pageSize:20,filters:{groupOp:"AND",rules:{barcode:{data:e,field:"barcode",op:"eq"}}},allSelected:!1,asString:"",page:1},i=await this.fetchData("POST",this.path,t);return null==i?null:(this.items[e]=i.data[0],i.data[0])}async getItemsByName(e){if(e.length<3)return[];const t={pageSize:20,filters:{groupOp:"AND",rules:{name:{data:e,field:"name",op:"cn"},isActive:{data:!0,field:"isActive",op:"eq"}}},allSelected:!1,asString:"",page:1},i=await this.fetchData("POST",this.path,t);return i.data.forEach((e=>{null!=e.barcode&&(this.items[e.barcode]=e)})),i.data}}class d{items=[];allItemsActive=!0;alternativeLabelFormat;constructor(e=void 0,t=!1){this.alternativeLabelFormat=t,null==e||(e instanceof Promise?e.then((e=>{this.items=e,this.print()})):(this.items=e,this.print()))}print(){this.items=this.items.filter((e=>1==e.isActive&&null!=e.barcode)),(this.isAllItemsActive()||confirm(s("notAllItemsActive")))&&(this.items.length>0?this.printLabelsUsingBrowser(this.items):alert(s("noData")))}isAllItemsActive(){return this.items.every((e=>e.isActive))}getBarcodeType(e){return 8===e.length?"8":13===e.length?"13":"code128"}makeUpperCaseBold(e){return e.replace(/("[^"]+"|[A-ZŽĄČĘĖĮŠŲŪ]{3,})/g,"<b>$1</b>")}generateLabel(e){const t=document.createElement("div");if(t.className="label",this.alternativeLabelFormat)t.classList.add("alternative");else if(null!=e.weight)return this.generateWeightLabel(e);const i=document.createElement("div");if(i.className="item",i.innerHTML=this.makeUpperCaseBold(e.name),null!=e.barcode){const i=document.createElement("div");i.className="barcode";const a=document.createElement("div");a.innerHTML=(null!=e.code?"<small>"+e.code+"</small>":"")+(null!=e.departmentNumber?"S"+e.departmentNumber+" ":"")+e.barcode;const n=document.createElement("img");n.src=`https://barcodeapi.org/api/${this.getBarcodeType(e.barcode)}/${e.barcode}`,i.appendChild(a),i.appendChild(n),t.appendChild(i)}if(0!=e.priceWithVat){const i=document.createElement("div");i.className="price","number"==typeof e.priceWithVat?i.textContent=e.priceWithVat.toFixed(2):i.textContent=parseFloat(e.priceWithVat).toFixed(2).toString(),t.appendChild(i)}if(null!=e.packageCode){const e=document.createElement("div");e.className="deposit",e.textContent="Tara +0,10",t.appendChild(e)}else if("kg"===e.measurementUnitName){const i=document.createElement("div");i.className="deposit",i.textContent="/ 1 "+e.measurementUnitName,t.appendChild(i)}return t.appendChild(i),t}generateWeightLabel(e){const t=document.createElement("div");if(null==e.weight||null==e.totalPrice||null==e.priceWithVat||null==e.barcode)return t;t.className="label";const i=document.createElement("div");i.className="weighted";const a=document.createElement("div");a.className="item",a.innerHTML=e.name,i.appendChild(a);const n=document.createElement("div");n.className="fprice",n.textContent=null!=e.totalPrice?e.totalPrice.toFixed(2)+" €":"",i.appendChild(n);const s=document.createElement("div");s.className="weight",s.textContent=e.weight.toFixed(3),i.appendChild(s);const o=document.createElement("div");o.className="kg-price",o.textContent=e.priceWithVat.toFixed(2),i.appendChild(o);const r=document.createElement("div");r.className="weight-text",r.textContent="kg",i.appendChild(r);const l=document.createElement("div");l.className="kg-text",l.textContent="€/kg",i.appendChild(l);const d=document.createElement("div");d.className="barcode";const c=document.createElement("img"),m="2200"+"0".repeat(13-e.barcode.length)+e.barcode+"0".repeat(5-e.weight.toFixed(3).length)+e.weight.toFixed(3).replace(".","");if(c.src=`https://barcodeapi.org/api/dm/${m}`,d.appendChild(c),i.appendChild(d),null!=e.expiryDate){const t=document.createElement("div");t.className="expiracy-text",t.textContent="Geriausia iki:",i.appendChild(t);const a=document.createElement("div");a.className="expiracy";const n=new Date(e.expiryDate);a.textContent=n.toLocaleDateString("lt-LT",{month:"2-digit",day:"2-digit"}),i.appendChild(a)}if(null!=e.batchNumber){const t=document.createElement("div");t.className="batch-no",t.textContent=`Partijos nr. ${e.batchNumber}`,i.appendChild(t)}if(1==e.addManufacturer&&null!=e.manufacturerName){const t=document.createElement("div");t.className="manufacturer",t.textContent=e.manufacturerName,i.appendChild(t)}if(1==e.addDescription&&null!=e.description){const t=document.createElement("div");t.className="description",t.textContent=e.description,i.appendChild(t)}return t.appendChild(i),t}async printLabelsUsingBrowser(e){const t=e.map((e=>this.generateLabel(e))),i=window.open("","_blank","width=700,height=700");if(null==i)return void alert("Please allow popups for this site");i.document.title=`${t.length} ${s("nlabelsToBePrinted")}`;const a=document.createElement("style");a.innerHTML='body{margin:0;padding:0}.label{position:relative;background:#fff;color:#000;height:31.75mm;width:57.15mm;border:.5px solid #ffdfd4;margin:0px;box-sizing:border-box;overflow:hidden}.item{height:19mm;overflow:hidden;padding:4px;font-family:Arial,sans-serif}.barcode{white-space:nowrap;position:absolute;bottom:0;z-index:3}.barcode div{font-size:10px;font-family:monospace;margin-left:10px;line-height:1em}.barcode div small{color:#888;font-size:8px;display:block}.barcode img{width:35mm;height:4mm;object-fit:cover;object-position:top}.deposit{position:absolute;right:2px;bottom:3px;font-family:math;font-size:16px;font-weight:700;z-index:10}.price{position:absolute;bottom:22px;font-size:50px;right:0;overflow:hidden;object-position:center;margin-right:3px;line-height:1em;font-family:"Book Antiqua",serif;padding-right:10px}.alternative .barcode{left:50%;transform:translateX(-50%)}.alternative .price,.alternative .deposit{display:none}.alternative .barcode img{width:50mm;height:12mm}.alternative .barcode div{margin-left:0;font-size:11px;display:flex;justify-content:space-between}.alternative .barcode div small{color:#000;font-size:9px}.weighted{display:grid;grid-template-columns:auto auto;grid-gap:2mm;align-items:center;justify-content:space-between;padding:5px;box-sizing:border-box;writing-mode:vertical-rl;grid-column-gap:4px;grid-row-gap:0px;font-family:"Arial"}.weighted .barcode{grid-column:1;position:static;width:12mm;height:12mm;grid-row:span 2}.weighted .barcode img{width:100%;height:100%;object-fit:cover;object-position:top}.weighted .item{grid-column:span 2;text-align:left;font-size:11pt;font-size:10pt;max-width:60pt;padding:0px;height:unset}.weighted .weighted *:not(.item,.manufacturer){font-family:"Book Antiqua",serif}.weighted .fprice{grid-row:2;grid-column:span 2;text-align:center;justify-self:center;align-self:center;font-size:15pt;font-weight:bold;line-height:1em;font-family:"Book Antiqua",serif;margin-right:5px;margin-left:5px}.weighted .kg-price{grid-column:2;justify-self:center;align-self:end}.weighted .kg-text{grid-column:2}.weighted .kg-text,.weighted .weight-text{justify-self:center;align-self:baseline;color:#999;font-size:.8em;line-height:.6}.weighted .weight-text{grid-column:1}.weighted .weight{grid-column:1;justify-self:center;align-self:end}.weighted .expiracy{grid-column:2;text-align:center;justify-self:center;align-self:baseline;line-height:.8}.weighted .manufacturer,.weighted .batch-no,.weighted .description{font-size:.7em;grid-column:span 2}.weighted .expiracy-text{grid-column:2;justify-self:center;align-self:end;font-size:.8em;text-align:center;color:#444;font-size:.8em;line-height:.8}',a.type="text/css",i.document.head.appendChild(a),t.forEach((e=>{i.document.body.appendChild(e)})),await new Promise((e=>{const t=i.document.querySelectorAll(".barcode img");let a=0;t.forEach((i=>{i.onload=()=>{a++,a===t.length&&e()}})),setTimeout(e,5e3)})),i.addEventListener("afterprint",(()=>{i.close()})),i.print()}}class c{notification=new o;req=new l;items=[];active=!1;settings;modals;loadingIndicator=null;mainInput=null;itemList=null;apiKey=null;constructor(){this.settings={alternativeLabelFormat:!1,autoPrint:!1,clearAfterPrint:!0,sayOutLoud:!0},this.checkApiKey()}async checkApiKey(){this.apiKey=await GM.getValue("api-key",null),null!=this.apiKey&&this.apiKey.length<20&&(this.apiKey=null,this.notification.error(s("invalidApiKey")))}isActive(){return this.active=null!==document.querySelector(".look-up-container"),this.active}init(){if(this.isActive())return!0;const e=document.querySelector(".main-container"),t=document.querySelector(".navbar-shortcuts"),i=document.querySelector(".footer");return null!=e&&null!=t&&null!=i&&(this.injectHtml(e),this.removeElements(t,i,e),this.hideDropdownMenuItems(),this.changeDocumentTitle(),this.cacheElements(),this.bindEvents(),!0)}hideDropdownMenuItems(){document.querySelectorAll(".dropdown-menu li").forEach(((e,t)=>{t<9&&(e.style.display="none")}))}removeElements(...e){e.forEach((e=>{e.remove()}))}injectHtml(e){e.insertAdjacentHTML("beforebegin",function(e){return`<div class="container look-up-container"> <div class="row"> <div class="col-md-4 form-section"> <h4 class="header">${e("labelsAndPrices")}</h4> <div class="form-group clearfix"> <label for="barcode" class="label-text">${e("barcodeOrName")}</label> <input type="text" class="form-control" id="barcode" placeholder="${e("scanOrEnterName")}" autocomplete="off"> <div class="ready-for-scan pull-right text-success">${e("readyForScan")}</div> </div> <div class="form-group"> <button type="button" class="btn btn-primary" id="searchButton">${e("search")}</button> <button type="button" class="btn btn-secondary" data-toggle="modal" data-target="#searchByNameModal" id="searchNameButton">${e("searchByName")}</button> </div> <div class="form-group"> <div class="checkbox-form hidden-sm"> <label> <input type="checkbox" class="ace" id="alternativeLabelFormat"> <span class="lbl display-inline">&nbsp;${e("alternativeLabelFormat")}</span> </label> </div> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="sayOutLoud" checked> <span class="lbl display-inline">&nbsp;${e("sayOutLoud")}</span> </label> </div> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="clearAfterPrint" checked> <span class="lbl display-inline">&nbsp;${e("clearAfterPrint")}</span> </label> </div> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="autoPrint"> <span class="lbl display-inline">&nbsp;${e("autoPrint")}</span> </label> </div> </div> <div class="clearfix margin-bottom-10"> <div class="pull-right"> <button type="button" class="btn btn-purple" id="printButton"> <i class="fa fa-print"></i>&nbsp;${e("print")}</button> <button type="button" class="btn btn-danger" id="cleanAllButton">${e("cleanAll")}</button> </div> </div> </div> <div class="col-md-8 load-data"> <div class="load-overlay" style="display:none" id="loadingOverlay"> <div> <i class="fa fa-5x fa-b1-loader blue"></i> </div> </div> <div class="item-list"> <div class="alert alert-info text-center">${e("noItemsScanned")}</div> <div class="alert-xs grey text-center">${e("help")}</div> </div> </div> </div>\n</div>\n</div>\n<div class="modal fade" id="searchByNameModal" tabindex="-1" role="dialog" aria-labelledby="searchByNameModalLabel" aria-hidden="true"> <div class="modal-dialog" role="document"> <div class="modal-content"> <div class="modal-header"> <h4 class="modal-title inline">${e("searchByName")}</h4> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> </div> <div class="modal-body"> <div class="form-group"> <label for="searchByName">${e("name")}</label> <input type="text" class="form-control" id="searchByName" placeholder="${e("enterName")}" autocomplete="off"> </div> <div id="search-results"></div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-dismiss="modal">${e("close")}</button> </div> </div> </div>\n</div> <div class="modal fade" id="itemDetails" tabindex="-1" role="dialog" aria-labelledby="itemDetailsLabel" aria-hidden="true"> <div class="modal-dialog" role="document"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title inline" id="itemDetailsLabel">${e("itemDetails")}</h5> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> </div> <div class="modal-body" data></div> <div class="modal-footer"> <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal">${e("close")}</button> </div> </div> </div>\n</div> <div class="modal fade" id="weightLabelModal" tabindex="-1" aria-labelledby="weightLabelModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> <h4 class="modal-title" id="weightLabelModalLabel">${e("weightLabel")}</h4> </div> <div class="modal-body"> <form> <div class="form-group"> <label for="productName">${e("name")}</label> <input type="text" class="form-control" id="productName" disabled> </div> <div class="form-group col-md-4 padding-0"> <label for="productWeight">${e("weight")} (g)</label> <input type="number" step="1" class="form-control" id="productWeight" min="0" required> </div> <div class="form-group col-md-4"> <label for="totalPrice">${e("totalPrice")} (EUR)</label> <input type="number" step="0.01" class="form-control" id="totalPrice" disabled> </div> <div class="form-group col-md-4 padding-0"> <label for="kgPrice">${e("pricePerKg")} (EUR)</label> <input type="number" step="0.01" class="form-control" id="kgPrice" disabled> </div> <div class="form-group col-md-6 padding-0 padding-right-10"> <label for="expiryDate">${e("expiryDate")}</label> <input type="date" class="form-control" id="expiryDate"> </div> <div class="form-group col-md-6 padding-0"> <label for="batchNumber">${e("batchNumber")}</label> <input type="text" class="form-control" id="batchNumber"> </div> <div class="form-group"> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="addManufacturer"> <span class="lbl display-inline">&nbsp;${e("addManufacturer")}&nbsp;</span> <span class="lbl display-inline" id="manufacturerField"> </label> </div> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="addDescription" ng-model="data.addDescription"> <span class="lbl display-inline">&nbsp;${e("addDescription")}</span> </label> </div> </div> <div class="form-group mt-2" id="descriptionField" style="display: none;" ng-show="data.addDescription"> <label for="productDescription">${e("description")}</label> <textarea class="form-control" id="description" rows="3"></textarea> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-dismiss="modal">${e("close")}</button> <button type="button" class="btn btn-primary" id="addWeightedItem">${e("add")}</button> <button type="button" class="btn btn-purple" id="printWeightLabel">${e("print")}</button> </div> </div> </div>\n</div>`}(s))}bindEvents(){if(document.getElementById("cleanAllButton")?.addEventListener("click",(()=>{this.cleanAll()})),document.getElementById("printButton")?.addEventListener("click",(()=>{this.print()})),null!=this.mainInput){this.mainInput.addEventListener("keypress",this.handleEnterPress(this.searchByBarcode.bind(this,this.mainInput))),document.getElementById("searchButton")?.addEventListener("click",this.searchByBarcode.bind(this,this.mainInput)),this.mainInput.focus(),document.getElementById("searchNameButton")?.addEventListener("click",this.searchByName.bind(this,this.mainInput));const e=document.getElementById("searchByName");e.addEventListener("keypress",this.handleEnterPress(this.searchByName.bind(this,e)));const t=document.querySelectorAll(".modal");document.addEventListener("click",(e=>{let i=!1;t.forEach((t=>{t.contains(e.target)&&(i=!0)})),i||null==this.mainInput||this.mainInput.focus()}))}this.modals?.weight.addDescription?.addEventListener("change",(()=>{null!=this.modals?.weight.descriptionField&&null!=this.modals.weight.addDescription&&(this.modals.weight.descriptionField.style.display=this.modals.weight.addDescription.checked?"block":"none")})),this.modals?.weight.addWeightedItem?.addEventListener("click",(()=>{this.addWeightItem()})),this.modals?.weight.printWeightLabel?.addEventListener("click",(()=>{this.printWeightLabel()})),this.modals?.weight.productWeight?.addEventListener("keypress",this.handleEnterPress((()=>{this.addWeightItem()}))),this.modals?.weight.productWeight?.addEventListener("input",this.handleWeightChange.bind(this)),this.bindCheckboxChange("alternativeLabelFormat","alternativeLabelFormat"),this.bindCheckboxChange("sayOutLoud","sayOutLoud"),this.bindCheckboxChange("clearAfterPrint","clearAfterPrint"),this.bindCheckboxChange("autoPrint","autoPrint")}handleEnterPress(e){return t=>{"Enter"==t.key&&e()}}bindCheckboxChange(e,t){document.getElementById(e)?.addEventListener("change",(e=>{e.target instanceof HTMLInputElement&&(this.settings[t]=e.target.checked)}))}cacheElements(){this.itemList=document.querySelector(".item-list"),this.mainInput=document.getElementById("barcode"),this.loadingIndicator=document.getElementById("loadingOverlay"),this.modals={weight:{currentItem:null,parent:document.getElementById("weightLabelModal"),productName:document.getElementById("productName"),productWeight:document.getElementById("productWeight"),kgPrice:document.getElementById("kgPrice"),description:document.getElementById("description"),expiryDate:document.getElementById("expiryDate"),batchNumber:document.getElementById("batchNumber"),addManufacturer:document.getElementById("addManufacturer"),addDescription:document.getElementById("addDescription"),manufacturerField:document.getElementById("manufacturerField"),descriptionField:document.getElementById("descriptionField"),printWeightLabel:document.getElementById("printWeightLabel"),addWeightedItem:document.getElementById("addWeightedItem"),totalPrice:document.getElementById("totalPrice")},itemDetails:document.getElementById("itemDetails"),searchResults:document.getElementById("search-results")}}showLoading(){null!=this.loadingIndicator&&(this.loadingIndicator.style.display="flex")}hideLoading(){null!=this.loadingIndicator&&(this.loadingIndicator.style.display="none")}print(e=this.settings.clearAfterPrint){this.items=this.items.filter((e=>e)),0!==this.items.length?(this.items.every((e=>1==e.isActive&&null!=e.barcode))||this.notification.warning(s("notAllItemsActive")),new d(this.items,this.settings.alternativeLabelFormat),e&&this.cleanAll(!0)):this.notification.error(s("noData"))}cleanAll(e=!1){this.items=[],null!=this.itemList?this.itemList.innerHTML=e?`<div class="alert alert-success text-center">${s("printJobIsSent")}. ${s("noItemsScanned")}</div>`:`<div class="alert alert-info text-center">${s("noItemsScanned")}</div>`:console.error("itemList is not defined")}async getAudioUrl(e){if(null==this.apiKey)return;const t=await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:{text:e},voice:{languageCode:"lt-LT",ssmlGender:"MALE"},audioConfig:{audioEncoding:"MP3"}})}),i=await t.json();if(null==i.audioContent)return void this.notification.error({title:s("error"),message:JSON.stringify(i)});const a=i.audioContent,n=new Blob([Uint8Array.from(atob(a),(e=>e.charCodeAt(0)))],{type:"audio/mp3"});return URL.createObjectURL(n)}createItemElement(e){const t=document.createElement("div");t.className="item",t.id=e.id??"",t.innerHTML=this.getItemHtml(e),null!=e.barcode&&0!=e.isActive||t.classList.add("inactive"),null!=e.weight&&t.classList.add("mark");const i=this.createItemButton("btn-yellow","fa-trash",(()=>{this.removeItem(t,e.id)}));if(t.appendChild(i),e.measurementUnitCanBeWeighed){const i=this.createItemButton("btn-pink","fa-balance-scale",(()=>{this.openWeightModal(e)}));t.appendChild(i)}return t.querySelector(".item-price")?.addEventListener("click",(()=>{this.showDetails(e)})),t}getItemHtml(e){return`\n      <div class="item-main">\n        ${e.priceWithVat>0?`<span class="item-price">${(e.totalPrice??e.priceWithVat).toFixed(2)}</span>`:""}\n        <span class="item-name">${e.name}</span>\n      </div>\n      <div class="item-labels">\n        ${this.getItemLabelsHtml(e)}\n      </div>`}getItemLabelsHtml(e){return["packageCode","weight","departmentNumber","packageQuantity"].map((t=>null!=e[t]?`<span>${s(t)}: ${e[t]}</span>`:"")).join("")+(null!=e.weight?`<span>${s("kiloPrice")}: ${e.priceWithVat}</span>`:"")+(e.measurementUnitCanBeWeighed?`<span>${s("weightedItem")}</span>`:"")}createItemButton(e,t,i){const a=document.createElement("button");a.addEventListener("click",i),a.className="btn btn-sm "+e,a.type="button";const n=document.createElement("i");return n.className="fa "+t,a.appendChild(n),a}removeItem(e,t){e.remove(),this.items=this.items.filter((e=>e.id!==t))}showDetails(e){const t=Object.fromEntries(Object.entries(e).filter((([e,t])=>null!==t&&!e.toString().toLowerCase().includes("id")&&!e.toString().includes("cost")))),i=Object.entries(t).map((([e,t])=>`<div class="row col-xs-12"><div class="col-sm-5">${s(e)}:</div><div class="col-sm-7">${t}</div></div>`)).join("");if(null!=this.modals?.itemDetails){const e=this.modals.itemDetails.querySelector(".modal-body");null!=e&&(e.innerHTML=`<div class="container width-auto">${i}</div>`)}$(this.modals?.itemDetails).modal("show")}addItemToView(e){const t=this.createItemElement(e);null!=this.itemList?(this.itemList.appendChild(t),t.scrollIntoView({behavior:"smooth",block:"end"})):this.notification.error(s("missingElements"))}newItem(e){e.id=this.generateItemId(),this.items.length>0&&this.items[this.items.length-1].barcode==e.barcode&&e.weight==this.items[this.items.length-1].weight?this.playAudio("Kaip ir sakiau, kaina yra "+this.digitsToPrice(e.totalPrice??e.priceWithVat)+(void 0!==e.weight?". Svoris "+this.numberToWords(e.weight)+" g.":"")+" Tai "+e.name):e.priceWithVat>0?this.playAudio("Kaina "+this.digitsToPrice(e.totalPrice??e.priceWithVat)):this.playAudio("Kaina nėra nustatyta"),0===this.items.length&&null!=this.itemList&&(this.itemList.innerHTML=""),this.items.push(e),this.addItemToView(e),this.settings.autoPrint&&this.print(!0)}async playAudio(e){if(!this.settings.sayOutLoud)return;new Audio(await this.getAudioUrl(e)).play()}numberToWords(e){const t=["","vienas","du","trys","keturi","penki","šeši","septyni","aštuoni","devyni"],i=["dešimt","vienuolika","dvylika","trylika","keturiolika","penkiolika","šešiolika","septyniolika","aštuoniolika","devyniolika"],a=["","","dvidešimt","trisdešimt","keturiasdešimt","penkiasdešimt","šešiasdešimt","septyniasdešimt","aštuoniasdešimt","devyniasdešimt"],n=["","šimtas","du šimtai","trys šimtai","keturi šimtai","penki šimtai","šeši šimtai","septyni šimtai","aštuoni šimtai","devyni šimtai"];let s=[];if(0===e)s.push("nulis");else{const o=e%10,r=Math.floor(e/10)%10,l=Math.floor(e/100);l>0&&s.push(n[l]),r>1&&s.push(a[r]),1===r?s.push(i[o]):s.push(t[o])}return s=s.filter((e=>e)),s.join(" ")}digitsToPrice(e){const t=Math.floor(e),i=Math.round(100*(e-t));let a=[];return t>0&&a.push(this.numberToWords(t)),i>0&&(0!==t&&(1===t||t%10==1&&t%100!=11?a.push("euras"):t%10==0||t%10>=10||t%100>=10&&t%100<=20?a.push("eurų"):a.push("eurai"),a.push("ir")),a.push(this.numberToWords(i)),1===i||i%10==1&&i%100!=11?a.push("centas"):i%10==0||i%10>=10||i%100>=10&&i%100<=20?a.push("centų"):a.push("centai")),a=a.filter((e=>e)),a.join(" ")}canItBePackaged(e){const t=parseInt(e.slice(0,2),10);return 13===e.toString().length&&t>20&&t<30&&parseInt(e.slice(8,12),10)<5e3}searchByBarcode(t){const i=e(t.value);t.value="",t.focus(),0!=i.length?"stop"!==i.toLowerCase()?this.canItBePackaged(i)?this.searchforAPackagedItem(i):this.searchItem(i):this.print():this.notification.error(s("missingBarcode"))}async searchByName(e){const t=e.value;if(null==t||0==t.length)return void this.notification.error(s("missingName"));if(null==this.modals?.searchResults)return this.active=!1,void this.notification.error(s("missingElements"));e.disabled=!0,this.notification.info(s("searchingFor")+" "+t);const i=await this.req.getItemsByName(t);this.modals.searchResults.innerHTML=i.length>0?`<div class="alert alert-info">${s("searchSuccessful")} "${t}". ${i.length} ${s("results")}`:`<div class="alert alert-warning">${s("noItemsFound")} "${t}"</div>`,i.forEach((e=>{null!=this.modals?.searchResults&&this.modals.searchResults.appendChild(this.createSearchResultItem(e))})),e.disabled=!1,e.value="",e.focus()}createSearchResultItem(e){const t=document.createElement("div");t.className="item";const i=document.createElement("span");i.className="item-price margin-right-5",i.textContent=e.priceWithVat.toString(),t.appendChild(i);const a=document.createElement("span");a.className="item-name",a.textContent=e.name,t.appendChild(a);const n=document.createElement("button");if(n.className="btn btn-info btn-xs margin-left-5",n.textContent=s("add"),t.appendChild(n),n.addEventListener("click",(()=>{this.newItem(e),t.style.backgroundColor="#b0d877"})),e.measurementUnitCanBeWeighed){const i=document.createElement("button");i.className="btn btn-pink btn-xs margin-left-5",i.textContent=s("weightLabel"),t.appendChild(i),i.addEventListener("click",(()=>{this.openWeightModal(e)}))}return t}async searchforAPackagedItem(e){let t=null;const i=e.slice(0,8);this.showLoading(),t=await this.req.getItem(i),this.hideLoading(),null!=t?(t.weight=parseInt(e.slice(8,12),10)/1e3,t.totalPrice=this.calculateTotalPrice(t),this.newItem(t)):this.notFound(e)}async searchItem(e){this.showLoading();const t=await this.req.getItem(e);this.hideLoading(),null!=t?this.newItem(t):this.notFound(e)}notFound(e){let t=new Object;t.name=s("itemNotFound")+" ("+s("barcode")+": "+e+")",t.barcode=e,t.isActive=!1,this.addItemToView(t)}openWeightModal(e){null!=this.modals?.weight.productName&&null!=this.modals.weight.productWeight&&null!=this.modals.weight.kgPrice&&null!=this.modals.weight.expiryDate&&null!=this.modals.weight.addManufacturer&&null!=this.modals.weight.manufacturerField&&null!=this.modals.weight.description&&(this.modals.weight.currentItem=JSON.parse(JSON.stringify(e)),this.modals.weight.productName.value=e.name,this.modals.weight.kgPrice.value=e.priceWithVat.toString(),this.modals.weight.description.value=e.description??"",this.modals.weight.expiryDate.min=(new Date).toISOString().split("T")[0],this.modals.weight.expiryDate.value="",this.modals.weight.addManufacturer.style.display=null!=e.manufacturerName?"block":"none",this.modals.weight.manufacturerField.innerHTML=e.manufacturerName??"",$(this.modals.weight.parent).modal("show"),this.modals.weight.productWeight.focus())}getWeightItem(){return null==this.modals?.weight.currentItem?.weight||isNaN(this.modals.weight.currentItem.weight)?(this.notification.error(s("missingWeight")),null):(this.modals.weight.currentItem.expiryDate=null!=this.modals.weight.expiryDate?.value&&this.modals.weight.expiryDate.value.length>0?this.modals.weight.expiryDate.value.slice(5):void 0,this.modals.weight.currentItem.batchNumber=null!=this.modals.weight.batchNumber?.value&&this.modals.weight.batchNumber.value.length>0?this.modals.weight.batchNumber.value:void 0,this.modals.weight.currentItem.addManufacturer=this.modals.weight.addManufacturer?.checked&&null!=this.modals.weight.currentItem.manufacturerName,this.modals.weight.currentItem.addDescription=this.modals.weight.addDescription?.checked&&null!=this.modals.weight.currentItem.description,this.modals.weight.currentItem.description=null!=this.modals.weight.description?.value&&this.modals.weight.description.value.length>0?this.modals.weight.description.value:"",this.notification.info(s("weightItemAdded")+": "+this.modals.weight.currentItem.weight+" kg"),this.modals.weight.currentItem=JSON.parse(JSON.stringify(this.modals.weight.currentItem)),this.modals.weight.currentItem)}addWeightItem(){const e=this.getWeightItem();null!=e&&this.newItem(e)}printWeightLabel(){const e=this.getWeightItem();null!=e&&new d([e],this.settings.alternativeLabelFormat)}calculateTotalPrice(e){if(null==e.weight)return 0;const t=e.priceWithVat*e.weight;return Math.round(100*(t+Number.EPSILON))/100}handleWeightChange(){null!=this.modals?.weight.currentItem&&(this.modals.weight.currentItem.weight=null!=this.modals.weight.productWeight?.value?parseInt(this.modals.weight.productWeight.value)/1e3:0,this.modals.weight.currentItem.totalPrice=this.calculateTotalPrice(this.modals.weight.currentItem),null!=this.modals.weight.totalPrice&&(this.modals.weight.totalPrice.value=this.modals.weight.currentItem.totalPrice.toFixed(2)))}addActivateButton(){const e=document.querySelector(".breadcrumbs");if(null!=e){const t=document.createElement("button");t.textContent=s("labelsAndPrices"),t.className="btn btn-sm",t.addEventListener("click",this.init.bind(this)),e.appendChild(t)}return null!=e}generateItemId(){return"i-"+Math.random().toString(36).substring(7)}changeDocumentTitle(){document.title=s("labelsAndPrices")}}class m{constructor(){const e=document.querySelector(".btn-ctrl");null!==e&&null===e.querySelector(".simplify-button")&&e.appendChild(this.createHideFieldsButton());const t=document.querySelector('input[name="barcode"]');null!==t&&(t.removeEventListener("input",(e=>{this.handleInputChange(e)})),t.addEventListener("input",(e=>{this.handleInputChange(e)})))}simplifyForm(){document.querySelector("ng-form")?.classList.add("simplified-form");["vatRate","minQuantity","netWeight","grossWeight","expenseCorrespondenceAccountCode","saleCorrespondenceAccountCode","purchaseCorrespondenceAccountCode","externalId","isCommentRequired","defaultSaleService","countryOfOriginName","intrastatShortDescription","intrastatCode","priceFrom","priceUntil","minPriceWithVat","priceMinQuantity","stock","discountStatus","maxDiscount","discountPointsStatus","ageLimit","certificateDate","certificateNumber","validFrom","validUntil","attribute1","attribute2","attribute3"].forEach((e=>{this.hideFormGroupByInputName(e)}));const e=this.findFormGroupByInputName("cost")?.parentElement,t=this.findFormGroupByInputName("manufacturerName")?.parentElement;null!=e&&null!=t&&t.parentElement?.appendChild(e)}findFormGroupByInputName(e){const t=e.includes("Status")?document.querySelector(`select[name="${e}"]`):document.querySelector(`input[name="${e}"]`);return t?.closest(".form-group")}hideFormGroupByInputName(e){const t=this.findFormGroupByInputName(e);if(null!=t){const e=t.closest(".form-group");if(null!=e){e.style.display="none";const t=e.parentElement;null==t||t.classList.contains("col-lg-12")||t.classList.contains("ng-pristine")||(t.style.display="none")}}}createHideFieldsButton(){const e=document.createElement("button");return e.className="btn btn-sm margin-left-5 simplify-button",e.type="button","true"===localStorage.getItem("simplifyForm")?(e.textContent=s("resetForm"),this.simplifyForm()):e.textContent=s("simplifyForm"),e.addEventListener("click",this.toggleFormLayout.bind(this)),e}toggleFormLayout(){const e=document.querySelector(".simplify-button"),t="true"===localStorage.getItem("simplifyForm")?"false":"true";localStorage.setItem("simplifyForm",t),"true"===t?(this.simplifyForm(),null!=e&&(e.textContent=s("resetForm"))):(document.querySelectorAll(".form-group").forEach((e=>{e.style.display="block";const t=e.parentElement;null!=t&&(t.style.display="block")})),null!=e&&(e.textContent=s("simplifyForm")))}handleInputChange(t){const i=t.target,a=i.value=e(i.value);/^\d+$/.test(a)?13===a.length||8===a.length?i.style.backgroundColor="lightgreen":a.length<13?i.style.backgroundColor="beige":i.style.backgroundColor="orangered":i.style.backgroundColor="orangered"}}class u{wasInterfaceButtonAdded=!1;pageReady=!1;notification=new o;user=new r;interface=new c;currentUrl;constructor(){this.currentUrl=window.location.pathname,this.init(),this.handleUrlChange(null,this.currentUrl),console.debug("LabelsUserscript initialized")}init(){this.overrideHistoryMethods(),this.setupPopStateListener(),this.addStyles()}overrideHistoryMethods(){const e=history.pushState;history.pushState=(t,i,a)=>{const n=this.currentUrl,s=e.apply(history,[t,i,a]);return this.currentUrl=window.location.pathname,this.handleUrlChange(n,this.currentUrl),s};const t=history.replaceState;history.replaceState=(e,i,a)=>{const n=this.currentUrl,s=t.apply(history,[e,i,a]);return this.currentUrl=window.location.pathname,this.handleUrlChange(n,this.currentUrl),s}}setupPopStateListener(){window.addEventListener("popstate",(()=>{const e=this.currentUrl;this.currentUrl=window.location.pathname,this.handleUrlChange(e,this.currentUrl)}))}async handleUrlChange(e,t,i=0){if(console.log("Url has changed"),this.pageReady=!1,this.user.isLoggedIn&&this.user.admin&&!this.interface.isActive()){!this.wasInterfaceButtonAdded&&this.interface.addActivateButton()&&(this.wasInterfaceButtonAdded=!0),new Promise((e=>setTimeout(e,200)));let e=!1;switch(this.currentUrl){case"/en/reference-book/items":case"/en/warehouse/purchases/edit":case"/reference-book/items":case"/warehouse/purchases/edit":e=this.addPrintButton(),e&&setTimeout((()=>{null==document.querySelector(".print")&&this.addPrintButton()}),1e3);break;case"/en/reference-book/items/edit":case"/reference-book/items/edit":e=this.addPrintButton(".btn-ctrl",!0),e&&new m;break;default:e=!0}e&&(this.pageReady=!0)}else!this.user.isLoggedIn||this.user.admin||this.interface.isActive()?this.user.isLoggedIn||"/login"!==this.currentUrl?this.pageReady=!0:this.pageReady=this.user.addLoginOptions():this.pageReady=this.interface.init();!this.pageReady&&i<5&&setTimeout((()=>{this.handleUrlChange(null,this.currentUrl,i+1)}),600)}getDataRows(){const e=document.querySelector(".data-rows");if(null==e)throw this.notification.error(s("error")),new Error("Data rows not found");return e}extractDataFromAngularItemList(){const e=this.getDataRows();return angular.element(e).controller().grid.data.filter((e=>e._select)).map((e=>({name:e.name,barcode:e.barcode,code:e.code,priceWithVat:e.priceWithVat,measurementUnitName:e.measurementUnitName,departmentNumber:e.departmentNumber,packageCode:e.packageCode,isActive:e.isActive,discountStatus:e.discountStatus})))}async extractDataFromAngularPurchaseView(){const e=this.getDataRows(),t=angular.element(e).controller().data.filter((e=>e._select)),i=[];if(confirm(s("askingForPackageCode"))){this.notification.primary(s("aboutToCheckPackageCode"));const e=t.map((e=>e.itemBarcode)),a=new l;for(const t of e){const e=await a.getItem(t);null!=e&&i.push(e),await new Promise((e=>setTimeout(e,200)))}}else t.forEach((e=>{i.push({name:e.itemName,barcode:e.itemBarcode,code:e.itemCode,priceWithVat:e.itemPriceWithVat,measurementUnitName:e.measurementUnitName,isActive:!0})}));return i}extractDataFromAngularItemView(){const e=document.querySelector("ng-form");if(null==e)return this.notification.error(s("error")),[];return[angular.element(e).controller().model]}processItemsfromAngular(){let e=[];switch(window.location.pathname){case"/en/reference-book/items":case"/reference-book/items":e=this.extractDataFromAngularItemList();break;case"/en/warehouse/purchases/edit":case"/warehouse/purchases/edit":e=this.extractDataFromAngularPurchaseView();break;case"/en/reference-book/items/edit":case"/reference-book/items/edit":e=this.extractDataFromAngularItemView()}new d(e)}addPrintButton(e=".buttons-left",t=!1){const i=document.querySelector(e);if(null==i)return!1;const a=document.createElement("div");a.className="print";const n=document.createElement("button");n.title=s("print"),n.type="button",n.className="btn btn-sm btn-purple";const o=document.createElement("i");if(o.className="fa fa-fw fa-print",n.appendChild(o),t){const e=document.createElement("span");e.className="margin-left-5",e.textContent=s("print"),n.appendChild(e)}else{const e=document.querySelector("i.fa-cloud-upload");if(null!=e){const t=e.parentElement?.parentElement;null!=t&&t.remove()}}return a.addEventListener("click",this.processItemsfromAngular.bind(this)),a.appendChild(n),i.appendChild(a),!0}addStyles(){const e=document.createElement("style");e.innerHTML="ng-form textarea.form-control.input-sm.ng-pristine.ng-untouched.ng-valid{height:50px}ng-form label:has(input[name=isActive]){margin-left:-0.5em}ng-form input[name=isActive].ace+span{background-color:#b74635;color:#fff;padding:.75em 5em .75em .5em;border-radius:4px}ng-form input[name=isActive].ace:checked+span{background-color:#fff;color:inherit}ng-form.simplified-form h5.header.blue,ng-form .alert.alert-warning{display:none}.navbar .navbar-shortcuts>ul>li:first-child{display:none}body:has(.look-up-container){background-color:#eee}body:has(.look-up-container) .navbar{background-color:var(--theme-blue--dark-bg)}body:has(.look-up-container) .navbar a.navbar-brand{filter:brightness(0) invert(1)}body:has(.look-up-container) .navbar .navbar-nav li.nav-user-dropdown img,body:has(.look-up-container) .navbar .navbar-nav li.nav-user-dropdown .divider{display:none}body:has(.look-up-container) .navbar .navbar-nav li.nav-user-dropdown a .nav-user-company{font-size:unset;line-height:unset}body:has(.look-up-container) .navbar .navbar-nav li.nav-user-dropdown a{padding:15px 10px}body:has(.look-up-container) .navbar .navbar-nav .nav-user-dropdown__title{color:#d9d9d9;padding-right:10px;font-size:15px;max-width:unset}body:has(.look-up-container) .navbar .navbar-nav .nav-user-dropdown__title .caret{color:#d9d9d9}body:has(.look-up-container) .navbar .navbar-nav .nav-user-dropdown__title *:first-child{display:none}.item{font-size:1.1em;background-color:#fff;border:1px solid #ddd;padding:10px;margin-bottom:4px;cursor:pointer;position:relative}.item .item-price{font-weight:bold;background-color:var(--theme-blue--dark-bg);color:#fff;padding:2px 8px}.look-up-container *:not(.header){border-radius:4px}.look-up-container .form-section,.look-up-container .item:not(.mark):not(.inactive){background-color:#fff}.look-up-container .load-data{padding:10px}.look-up-container .load-overlay{background-color:rgba(238,238,238,.7490196078)}.look-up-container .form-section{border:1px solid #ddd;margin-top:10px;background-color:#fff}.look-up-container .item-list{max-height:calc(100vh - 70px);overflow:auto}.look-up-container .item-list .item{transition:.5s;animation:highlight .5s ease-out;display:grid;grid-template-columns:auto min-content min-content;column-gap:5px}.look-up-container .item-list .item .item-main{grid-row:1;grid-column:1}.look-up-container .item-list .item .item-labels{grid-column:1;grid-row:2;align-self:center}.look-up-container .item-list .item .btn{grid-row:1/span 2;border:none}.look-up-container .item-list .item .btn-yellow{grid-column:3}.look-up-container .item-list .item:last-child{margin-bottom:30px;animation:highlight .5s ease-out,emphasizeItem .5s ease-in-out 5s backwards}.look-up-container .item-list .item.inactive{background-color:#f8d7da !important}.look-up-container .item-list .item.mark{background-color:#fcf8e3 !important}.look-up-container .item-list .item:hover{background-color:#f1f1f1 !important}.look-up-container .item-list .item *:empty:not(i){display:none}.look-up-container .item-list .item .item-price{margin-right:4px;border-radius:4px;transition:.5s}.look-up-container .item-list .item:last-child .item-price{animation:emphasizePrice .5s ease-in-out 5s backwards}.look-up-container .item-labels{font-size:.8em;color:#666}.look-up-container .item-labels span{margin-right:10px}.look-up-container .form-group{position:relative}.look-up-container .ready-for-scan{opacity:0;transition:.5s;position:absolute;right:0%;width:80px;text-align:right;color:var(--theme-orange--base-bg);padding-top:5px;text-transform:lowercase}.look-up-container #barcode:focus:placeholder-shown+.ready-for-scan{opacity:1}.container.width-auto>.row{padding:5px 0px;white-space:pre-line;border-bottom:1px solid #eee}#weightLabelModal *{border-radius:4px !important}#search-results *{border-radius:4px !important}#search-results .item{display:flex;justify-content:space-between;align-items:center}#search-results .item-price{align-self:center}#search-results .item-name{flex:1;margin-right:10px;word-wrap:break-word}.modal-backdrop{display:none}.modal{background-color:rgba(0,0,0,.5)}@keyframes emphasizeItem{from{font-size:1.2em}}@keyframes emphasizePrice{from{margin-left:-10px;padding-left:10px;border-radius:0px 5px 5px 0px;background-color:#000}}@keyframes highlight{from{background-color:#1b6aaa;color:#fff;filter:opacity(0.5)}}",document.head.appendChild(e)}}window.addEventListener("load",(()=>{new u,setTimeout((()=>{null!=window.clarity&&window.clarity("stop")}),500)}))}();
