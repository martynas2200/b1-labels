// ==UserScript==
// @name              Label Generator for the items in b1.lt
// @namespace         http://tampermonkey.net/
// @homepage          https://github.com/martynas2200/b1-labels
// @version           1.5.0
// @description       Generate labels for the selected items on the b1.lt website
// @author            Martynas Miliauskas
// @match             https://www.b1.lt/*
// @icon              https://b1.lt/favicon.ico
// @connect           b1.lt
// @connect           raw.githubusercontent.com
// @downloadURL       https://raw.githubusercontent.com/martynas2200/b1-labels/main/dist/script.user.js
// @updateURL         https://raw.githubusercontent.com/martynas2200/b1-labels/main/dist/script.user.js
// @grant             GM.setValue
// @grant             GM.getValue
// @grant             unsafeWindow
// @grant             GM_xmlhttpRequest
// @license           GNU GPLv3
// ==/UserScript==

!function(){"use strict";function e(e){return e.replace(/ą/g,"1").replace(/č/g,"2").replace(/ę/g,"3").replace(/ė/g,"4").replace(/į/g,"5").replace(/š/g,"6").replace(/ų/g,"7").replace(/ū/g,"8").replace(/ž/g,"9")}const t={en:{aboutToCheckPackageCode:"A check for the package codes will be performed, this may take a while",add:"Add",addDescription:"Add Description",addManufacturer:"Add Manufacturer",addPackageFeeNote:"Add Package Fee",ageLimit:"Age Limit",ago:"ago",alcohol:"Alcohol",alternativeLabelFormat:"Enable alternative label format",askingForPackageCode:"Are there any selected items that have a package code?",asMentioned:"As mentioned",attributeName:"Attribute Name",autoLogin:"Instant Login",barcode:"Barcode",barcodeOrName:"Barcode or name",batchNumber:"Batch Number",checked:"Checked",cleanAll:"Clean All",clearAfterPrint:"Clear after print",clickToAdd:"Click on the item to add it to the print list",close:"Close",code:"Code",cost:"Cost",countryOfOriginName:"Country of Origin Name",defaultSaleService:"Default Sale Service",departmentNumber:"Department",deposit:"Deposit",description:"Description",discount:"Discount",discountPointsStatus:"Discount Points Status",discountRate:"Discount Rate",discountStatus:"Discount Status",done:"Done",enterBarcode:"Enter the barcode",enterName:"Enter Name",enterNewPrice:"Enter new price",error:"Error",expiryDate:"Expiry Date",failedToCreateItem:"Failed to create item",failedToUpdateItem:"Failed to update item",fitRaso:"Fit Raso",freePrice:"Free Price",fullBarcode:"Full Barcode",fullName:"Full Name",grossWeight:"Gross Weight",groupName:"Group Name",help:"If you have any problems, reach out via GitHub",inactiveItem:"The item is inactive. Do you want to continue?",isActive:"Is Active",isCommentRequired:"Is Comment Required",isQuantitative:"Is Quantitative",isRefundable:"Is Refundable",itemCatalog:"Item Catalog",itemAdded:"Item added",itemCreated:"Item created",itemDetails:"Item Details",itemNotFound:"Item not found!",itemsFound:"Items found",itemUpdated:"Item updated",kiloPrice:"Price per kilo",labelsAndPrices:"Labels and Prices",leftover:"Leftover",login:"Login",loginDetailsNotFound:"Login details not found",manufacturerName:"Manufacturer Name",markdowns:"Markdowns",maxDiscount:"Max Discount",measurementUnitCanBeWeighed:"Measurement Unit Can Be Weighed",measurementUnitName:"Measurement Unit Name",minPriceWithVat:"Min Price With VAT",minQuantity:"Min Quantity",missingBarcode:"Missing barcode",missingElements:"Missing UI elements",missingName:"Missing name",missingWeight:"Missing weight",name:"Name",netWeight:"Net Weight",newDraft:"New Draft",newItem:"New Item",newPriceIs:"New price is: ",newWriteOff:"New Write Off",nItemsRemoved:" items removed",nlabelsToBePrinted:" labels to be printed",no:"No",noActiveInput:"No active input",noData:"No data to print!",noItemsFound:"No items found",noItemsScanned:"No items scanned",noItemsSelected:"No items selected!",notAllItemsActive:"Not all selected items are active. Do you want to continue?",onlyAvailableInPurchaseView:"This is not a purchase view. This feature is only available in the purchase view",packageCode:"Package",packageQuantity:"Package Quantity",pcs:"pcs",price:"Price",priceFrom:"Price From",priceMinQuantity:"Price Min Quantity",priceNotSet:"Price not set",pricePerKg:"Price per kg",priceUntil:"Price Until",priceWithoutVat:"Price Without VAT",priceWithVat:"Price With VAT",print:"Print",printJobIsSent:"Print job is sent",quantity:"Quantity",readyForScan:"Ready for scan",resetForm:"Reset form",results:"Results",save:"Save",sayOutLoud:"Say out loud",search:"Search",searchByBarcode:"Search by Barcode",searchByName:"Search by Name",searchingFor:"Searching for",searchSuccessful:"Search successful",show:"Show",showByDate:"Show by Date",showLoginOptions:"Other ways to login",showStock:"Show Stock",simplifyForm:"Simplify Form",stock:"Stock",thisIs:"This is",toggleKeyboard:"Toggle Keyboard",tooManyItems:"Too many items",totalPrice:"Total Price",uploadFile:"Upload File",validFrom:"Valid From",validUntil:"Valid Until",vatRate:"VAT Rate",weight:"Weight",weightedItem:"Weighted item",weightedItemAdded:"Weighted item added",weightLabel:"Weight Label",writeOff:"Write Off",writeOffItems:"Write Off Items",yes:"Yes",zero:"zero"},lt:{aboutToCheckPackageCode:"Bus atliekamas pakuotės kodų tikrinimas, tai gali užtrukti",add:"Pridėti",ago:"",addDescription:"Pridėti aprašymą",addManufacturer:"Pridėti gamintoją",addPackageFeeNote:"Pridėti pakuočių mokestį",ageLimit:"Amžiaus limitas",alcohol:"Alkoholis",alternativeLabelFormat:"Etiketėje tik brūkšninis kodas",askingForPackageCode:"Ar yra pasirinktų prekių, kurios turi pakuotės kodą?",asMentioned:"Kaip minėjau",attributeName:"Atributo pavadinimas",autoLogin:"Prisijungti automatiškai",barcode:"Brūkšninis kodas",barcodeOrName:"Brūkšninis kodas arba pavadinimas",batchNumber:"Partijos numeris",checked:"Tikrinta prieš",cleanAll:"Išvalyti",clearAfterPrint:"Išvalyti po spausdinimo",clickToAdd:"Paspauskite ant prekės, kad ją pridėtumėte į spausdinimo sąrašą",close:"Uždaryti",code:"Kodas",cost:"Savikaina",countryOfOriginName:"Kilmės šalies pavadinimas",defaultSaleService:"Numatytoji pardavimo paslauga",departmentNumber:"S",deposit:"Tara",description:"Aprašymas",discount:"Nuolaida",discountPointsStatus:"Nuolaidų taškų statusas",discountRate:"Nuolaidos dydis",discountStatus:"Nuolaidos statusas",done:"Atlikta",enterBarcode:"Įveskite brūkšninį kodą",enterName:"Įveskite prekės pavadinimą",enterNewPrice:"Įveskite naują kainą",error:"Įvyko klaida",expiryDate:"Galiojimo data",fitRaso:"Tinkamas RASO importui",freePrice:"Laisva kaina",fullBarcode:"Pilnas brūkšninis kodas",fullName:"Pilnas pavadinimas",grossWeight:"Bendras svoris",groupName:"Grupės pavadinimas",help:"Jei kyla problemų, kreiptis pas Martyną",inactiveItem:"Prekė yra neaktyvi. Ar norite tęsti?",isActive:"Aktyvus",isCommentRequired:"Komentaro reikalavimas",isQuantitative:"Kiekinė",isRefundable:"Grąžinimo galimybė",itemCatalog:"Prekių žinynas",itemAdded:"Prekė pridėta",itemCreated:"Prekė išsaugota",itemDetails:"Prekės informacija",itemNotFound:"Prekė nerasta!",itemsFound:" rasta",itemUpdated:"Prekė atnaujinta",kiloPrice:"Kilogramo kaina",labelsAndPrices:"Etiketės ir kainos",leftover:"Liko",login:"Prisijungimas darbo vietoje",loginDetailsNotFound:"Prisijungimo duomenys nerasti",manufacturerName:"Gamintojo pavadinimas",markdowns:"Nukainojimai",maxDiscount:"Max nuolaida",measurementUnitCanBeWeighed:"Prekė gali būti sveriama",measurementUnitName:"Matavimo vieneto pavadinimas",minPriceWithVat:"Min kaina su PVM",minQuantity:"Min kiekis",missingBarcode:"Trūksta brūkšninio kodo",missingElements:"Trūksta UI elementų",missingName:"Trūksta pavadinimo",missingWeight:"Trūksta svorio",name:"Pavadinimas",netWeight:"Neto svoris",newDraft:"Naujas juodraštis",newItem:"Nauja prekė",newPriceIs:"Nauja kaina: ",newWriteOff:"Naujas nurašymas",nItemsRemoved:" prekių įrašai pašalinti",nlabelsToBePrinted:" etiketės bus spausdinamos",no:"Ne",noActiveInput:"Nėra aktyvaus lauko",noData:"Nepakanka duomenų spausdinimui!",noItemsFound:"Nieko nerasta",noItemsScanned:"Nėra skenuotų prekių",noItemsSelected:"Nėra pasirinktų prekių",notAllItemsActive:"Ne visos pasirinktos prekės yra aktyvios. Ar norite tęsti?",onlyAvailableInPurchaseView:"Tai ne pirkimo peržiūra. Ši funkcija yra prieinama tik Pirkimai, atidarius vieną iš jų",packageCode:"Pakuotė",packageQuantity:"Pakuotės kiekis",pcs:"vnt.",price:"Kaina",priceFrom:"Kaina nuo",priceMinQuantity:"Kaina min kiekis",priceNotSet:"Kaina nėra nustatyta",pricePerKg:"Kaina už 1 kg",priceUntil:"Kaina iki",priceWithoutVat:"Kaina be PVM",priceWithVat:"Kaina su PVM",print:"Spausdinti",printJobIsSent:"Spausdinimo užduotis nusiųsta",quantity:"Kiekis",readyForScan:"Pasiruošęs skenavimui",resetForm:"Atkurti formą",results:"Rezultatai",save:"Išsaugoti",sayOutLoud:"Sakyti kainas balsu",search:"Ieškoti",searchByBarcode:"Ieškoti pagal brūkšninį kodą",searchByName:"Ieškoti pagal pavadinimą",searchingFor:"Ieškoma",searchSuccessful:"Paieška sėkminga",show:"Rodyti",showByDate:"Rodyti pagal datą",showLoginOptions:"Kiti prisijungimo būdai",showStock:"Rodyti likutį",simplifyForm:"Supaprastinti formą",stock:"Likutis",thisIs:"Tai",toggleKeyboard:"Klaviatūra",tooManyItems:"Per daug prekių",totalPrice:"Apskaičiuota kaina",uploadFile:"Įkelti failą",validFrom:"Galioja nuo",validUntil:"Galioja iki",vatRate:"PVM tarifas",weight:"Svoris",weightedItem:"Sveriama prekė",weightedItemAdded:"Sveriama prekė pridėta",weightLabel:"Svorio etiketė",writeOff:"Nurašymas",writeOffItems:"Prekių nurašymas",yes:"Taip",zero:"nulis"}};let i=navigator.language.split("-")[0];const a=window.location.pathname;/\/(en|ru)\//.test(a)&&(i="en");const n=null!=t[i]?i:"en",r=e=>t[n][e]??t.en[e]??e;class o{notificationService;constructor(){const e=document.querySelector("[ng-app]");if(null===e)throw new Error("Angular app not found");try{const t=angular.element(e).injector();this.notificationService=t.get("Notification")}catch(e){console.error("Failed to get Notification service",e),alert("Failed to get Notification service"),this.notificationService={info:e=>alert(e),error:e=>alert(e),success:e=>alert(e),warning:e=>alert(e),primary:e=>alert(e)}}}info(e){this.notificationService.info(e)}error(e){this.notificationService.error(e)}success(e){this.notificationService.success(e)}warning(e){this.notificationService.warning(e)}primary(e){this.notificationService.primary(e)}}class s{notification=new o;interfaceInUse=!1;isLoggedIn=!1;admin=!1;user;constructor(){this.user=null,this.checkLoginStatus()}checkLoginStatus(){return null!=currentUser?.name?(this.isLoggedIn=!0,this.user=currentUser,this.admin=null!=this.user&&this.user.typeId<=3,this.admin||this.limitPermissions(),!0):(null!=currentUser&&null==currentUser.name&&(this.isLoggedIn=!1),!1)}limitPermissions(){currentCompanyUser.permissions.crudKlientai={create:!1,read:!1,update:!1,delete:!1},currentCompanyUser.permissions.crudBankaisaskait={create:!1,read:!1,update:!1,delete:!1},currentCompanyUser.permissions.crudPardavim={create:!0,read:!0,update:!0,delete:!0},currentCompanyUser.permissions.crudPrekes={create:!1,read:!0,update:!1,delete:!1},currentCompanyUser.permissions.crudDokSer={create:!1,read:!1,update:!1,delete:!1}}addContainer(){document.querySelectorAll("h5").forEach((e=>{e.remove()}));const e=document.querySelector("form"),t=`\n      <h5 class="header blue">${r("login")}</h5>\n      <div class="form-group text-center">\n      <button class="btn btn-success-2 btn-block " type="button" id="auto-login"><i class="fa fa-sign-in"></i>${r("autoLogin")}</button>\n      <button class="btn-primary btn btn-block margin-top-8" type="button" id="show-login-options">${r("showLoginOptions")}</button>\n      </div>`;return null!==e?(e.insertAdjacentHTML("beforebegin",t),e.style.display="none",!0):(console.error("Form not found!"),!1)}addLoginOptions(){if(!this.addContainer())return!1;const e=document.querySelector("#show-login-options"),t=document.querySelector("#auto-login"),i=document.querySelector("form");return null!==e&&null!==t&&null!==i&&(e.addEventListener("click",(function(){i.style.display="block",e.style.display="none"})),t.addEventListener("click",(()=>{this.autoLogin()})),!0)}async autoLogin(){const e=document.querySelector('input[name="username"]'),t=document.querySelector('input[name="password"]');if(null===e||null===t)return this.notification.error(r("loginDetailsNotFound")),!1;const i=await GM.getValue("username",""),a=await GM.getValue("password","");if(""===i||""===a)return this.notification.error(r("loginDetailsNotFound")),"x"===e.value&&"x"===t.value&&this.saveLoginDetails(),!1;e.value=i,t.value=a,e.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("input",{bubbles:!0}));const n=document.querySelector("form");if(null===n)return this.notification.error(r("error")),!1;let o=n.getAttribute("ng-submit");if(null===o)return this.notification.error("Recaptcha key not found"),!1;const s=o.match(/"([^"]+)"/);return null===s?(this.notification.error("Recaptcha key not found"),!1):(o=s[1],angular.element(n).controller().signIn(o),!0)}async saveLoginDetails(){if(window.confirm("Do you want to save these login details?")){const e=window.prompt("Enter your username"),t=window.prompt("Enter your password");null!=e&&null!=t&&(await GM.setValue("username",e),await GM.setValue("password",t),alert("Login details saved"))}if(!window.confirm("Do you want to save API key?"))return;const e=window.prompt("Enter your API key");null!==e&&(await GM.setValue("api-key",e),alert("API key saved"))}}class l{text;constructor(e){this.text=e}encode(){var e,t,i,a=3,n=[],r=[];for(e=0;e<this.text.length;e++){if(i=this.text.charCodeAt(e),2!=a){for(t=0;t+e<this.text.length&&!(this.text.charCodeAt(e+t)-48>>>0>9);t++);(t>1&&0==e||t>3&&(e+t<this.text.length||!(1&t)))&&(n.push(0==e?105:99),a=2)}if(2==a&&(i-48>>>0<10&&e+1<this.text.length&&this.text.charCodeAt(e+1)-48>>>0<10?n.push(+this.text.substr(e++,2)):a=3),2!=a){if(a>2||(127&i)<32&&a||(127&i)>95&&!a){for(t=a>2?e:e+1;t<this.text.length&&!(this.text.charCodeAt(t)-32&64);t++);t=t==this.text.length||96&this.text.charCodeAt(t)?1:0,n.push(0==e?103+t:t!=a?101-t:98),a=t}i>127&&n.push(101-a),n.push((64+(127&i))%96)}}for(0==e&&n.push(103),t=n[0],e=1;e<n.length;e++)t+=e*n[e];for(n.push(t%103),n.push(106),i=[358,310,307,76,70,38,100,98,50,292,290,274,206,110,103,230,118,115,313,302,295,370,314,439,422,406,403,434,410,409,364,355,283,140,44,35,196,52,49,324,276,273,220,199,55,236,227,59,443,327,279,372,369,375,428,419,395,436,433,397,445,289,453,152,134,88,67,22,19,200,194,104,97,26,25,265,296,477,266,61,158,94,79,242,122,121,466,458,457,367,379,475,188,143,47,244,241,468,465,239,247,431,471,322,328,334,285],a=e=0;e<n.length;e++,a++)for(r[a++]=1,t=256;t>0;t>>=1,a++)i[n[e]]&t&&(r[a]=1);return r[a++]=r[a]=1,[r]}toHtml(e,t=3,i=5){Array.isArray(t)||(t=[t||3,t||3]);let a,n,r="barcode"+t[0]+t[1],o="<style> ."+r+" div {float:left; margin:0; height:"+t[1]+"px}";i=i||5;for(var s=0;s<i;s++)for(var l=0;l<i;l++)o+="."+r+" .bar"+l+s+" {border-left:"+l*t[0]+"px solid; margin-right:"+s*t[0]+"px}";for(o+="</style><div class="+r+" style='line-height:"+t[1]+"px; display:inline-block'>",s=0;s<e.length;s++)for(l=0;l<e[s].length;){for(s&&!l&&(o+="<br style='clear:both' />"),a=0;l<e[s].length&&(e[s][l]&&a+1!=i);a++,l++);for(n=0;l<e[s].length&&(!e[s][l]&&n+1!=i);n++,l++);o+="<div class=bar"+a+n+"></div>"}return o+"</div>"}}class c{items=[];alternativeLabelFormat;constructor(e=void 0,t=!1){this.alternativeLabelFormat=t,null==e||(e instanceof Promise?e.then((e=>{this.items=e,this.print()})):(this.items=e,this.print()))}print(){this.items=this.items.filter((e=>1==e.isActive&&null!=e.barcode)),(this.isAllItemsActive()||confirm(r("notAllItemsActive")))&&(this.items.length>0?this.printLabelsUsingBrowser(this.items):alert(r("noData")))}isAllItemsActive(){return this.items.every((e=>e.isActive))}makeUpperCaseBold(e){return e.replace(/("[^"]+"|[A-ZŽĄČĘĖĮŠŲŪ]{3,})/g,"<b>$1</b>")}generateLabel(e){const t=document.createElement("div");if(t.className="label",this.alternativeLabelFormat)t.classList.add("alternative");else if(null!=e.weight)return this.generateWeightLabel(e);const i=document.createElement("div");if(i.className="item",i.innerHTML=this.makeUpperCaseBold(e.name),null!=e.barcode){const i=document.createElement("div");i.className="barcode";const a=document.createElement("div");a.innerHTML=(null!=e.departmentNumber?"S"+e.departmentNumber+" ":"")+e.barcode,i.appendChild(a);const n=new l(e.barcode),r=document.createElement("p");r.innerHTML=n.toHtml(n.encode(),this.alternativeLabelFormat?[1,50]:[1,15]),i.appendChild(r),t.appendChild(i)}if(0!=e.priceWithVat){const i=document.createElement("div");i.className="price","number"==typeof e.priceWithVat?i.textContent=e.priceWithVat.toFixed(2):i.textContent=parseFloat(e.priceWithVat).toFixed(2).toString(),t.appendChild(i)}if(null!=e.packageCode){const e=document.createElement("div");e.className="deposit",e.textContent="Tara +0.10",t.appendChild(e)}else if(1==e.measurementUnitCanBeWeighed){const i=document.createElement("div");i.className="deposit",i.textContent="/ 1 "+e.measurementUnitName,t.appendChild(i)}return t.appendChild(i),t}generateWeightLabel(e){const t=document.createElement("div");if(null==e.weight||null==e.totalPrice||null==e.priceWithVat||null==e.barcode||e.barcode.length>13)return t;t.className="label";const i=document.createElement("div");i.className="weighted";const a=document.createElement("div");a.className="item",a.innerHTML=e.name,i.appendChild(a);const n=document.createElement("div");n.className="fprice",n.textContent=null!=e.totalPrice?e.totalPrice.toFixed(2)+" €":"",i.appendChild(n);const r=document.createElement("div");r.className="weight",1==e.measurementUnitCanBeWeighed?r.textContent=e.weight.toFixed(3):r.textContent=e.weight.toString(),i.appendChild(r);const o=document.createElement("div");o.className="kg-price",o.textContent=e.priceWithVat.toFixed(2),i.appendChild(o);const s=document.createElement("div");s.className="weight-text",s.textContent=e.measurementUnitName,i.appendChild(s);const l=document.createElement("div");l.className="kg-text",l.textContent="€/"+e.measurementUnitName,i.appendChild(l);const c=document.createElement("div");c.className="barcode";const d=(1==e.addPackageFeeNote?"1102\n":"")+"2200"+"0".repeat(13-e.barcode.length)+e.barcode+"0".repeat(5-e.weight.toFixed(3).length)+e.weight.toFixed(3).replace(".",""),u="http://www.w3.org/2000/svg",m=document.createElementNS(u,"svg"),h=document.createElementNS(u,"path");if(h.setAttribute("transform","scale(1)"),m.appendChild(h),c.appendChild(m),h.setAttribute("d",(e=>{var t,i,a="";for(e.forEach((function(e){e.unshift(0)})),e.push([]),e.unshift([]);;){for(i=0;i+2<e.length&&!((t=e[i+1].indexOf(1)-1)>=0||(t=e[i+1].indexOf(5)-1)>=0);i++);if(i+2==e.length||a.length>1e7)return a;for(var n=e[i+1][t+1]>>2,r="",o=t,s=i,l=1;r.length<1e6;){do{t+=2*l-1}while((e[i][t+l]^e[i+1][t+l])&e[i+l][t+l]&1);l^=1&e[i+l][t+l];do{e[l?++i:i--][t+1]^=2}while((e[i+l][t]^e[i+l][t+1])&e[i+l][t+1-l]&1);if(t==o&&i==s)break;l^=1^1&e[i+l][t+1-l],n?r="V"+i+"H"+t+r:r+="H"+t+"V"+i}for(a+="M"+t+" "+i+r+(n?"V"+i:"H"+t)+"Z",l=0,i=1;i<e.length-1;i++)for(t=1;t<e[i].length;t++)l^=e[i][t]>>1&1,e[i][t]=5*l^5&e[i][t]}})(((e,t=!1)=>{var i=[],a=0,n=0;function r(e){a=40*a+e,2==n++&&(i.push(++a>>8),i.push(255&a),n=a=0)}var o,s,l,c=[function(e){return(e-48&255)<10?6:e<128?12:24},function(e){return(e-48&255)<10||(e-65&255)<26||32==e?8:e<128?16:16+c[1](127&e)},function(e){return(e-48&255)<10||(e-97&255)<26||32==e?8:e<128?16:16+c[2](127&e)},function(e){return(e-48&255)<10||(e-65&255)<26||32==e||13==e||62==e||42==e?8:1e9},function(e){return e>=32&&e<95?9:1e9},function(e){return 12}],d=[0,24,24,24,21,25],u=[0,12,12,12,12,25],m=0,h=0,p=[];for(p[e.length]=u.slice(),l=e.length;l-- >0;){for(o=1e9,s=0;s<u.length;s++)u[s]+=c[s](e.charCodeAt(l)),o=Math.min(o,12*Math.ceil(u[s]/12));for(c[0](e.charCodeAt(l))>6&&(u[0]=12*Math.ceil(u[0]/12)),s=0;s<u.length;s++)o+d[s]<u[s]&&(u[s]=o+d[s]);p[l]=u.slice()}for(l=0;;m=h){if(o=p[l][m]-d[m],l+[0,2,2,2,3,0][m]>=e.length)h=0;else for(s=c.length;s-- >0;)12*Math.ceil((p[l+1][s]+c[s](e.charCodeAt(l)))/12)==o&&(h=s);if(m!=h&&m>0)if(m<4)i.push(254);else if(4==m)i.push(31|255&a);else for(n>249&&i.push(n/250+250+149*(i.length+1)%255&255),i.push(n%250+149*(i.length+1)%255+1&255);n>0;n--)i.push(e.charCodeAt(l-n)+149*(i.length+1)%255+1&255);if(l>=e.length)break;if(m!=h&&(a=n=0),m!=h&&h>0&&i.push([230,239,238,240,231][h-1]),0==h)(s=(o=e.charCodeAt(l++))-48&255)<10&&l<e.length&&(e.charCodeAt(l)-48&255)<10?i.push(10*s+e.charCodeAt(l++)-48+130):(o>127&&i.push(235),i.push(1+(127&o))),(4==m||n<0)&&n--;else if(h<4){var g=[[31,0,32,119,47,133,57,179,64,173,90,207,95,277,127,386,255,1],[31,0,32,119,47,133,57,179,64,173,90,258,95,277,122,335,127,386,255,1],[13,55,32,119,42,167,57,179,62,243,90,207,255,3]][h-1];do{for((o=e.charCodeAt(l++))>127&&(r(1),r(30),o&=127),s=0;o>g[s];s+=2);(3&g[s+1])<3&&r(3&g[s+1]),r(o-(g[s+1]>>2))}while(n>0)}else if(4==h){for(n>0&&i.push(255&a+(63&e.charCodeAt(l++))),a=n=0;n<3;n++)a=64*(a+(63&e.charCodeAt(l++)));i.push(a>>16),i.push(a>>8&255)}else l++,n++}var b,f,y,v,k,w,I,x,C=i.length,N=1,S=1,P=-1,L=1;if((-1==n||m&&m<5)&&(h=1),t&&C-h<50){x=[16,7,28,11,24,14,32,18,32,24,44,28];do{k=(f=x[++P])*(b=6+(12&P))/8}while(k-x[++P]<C-h);f>25&&(N=2)}else{f=b=6,s=2,x=[5,7,10,12,14,18,20,24,28,36,42,48,56,68,84,112,144,192,224,272,336,408,496,620];do{if(++P==x.length)return[];f>11*s&&(s=4+s&12),k=(f=b+=s)*b>>3}while(k-x[P]<C-h);f>27&&(S=N=2*Math.floor(f/54)+2),k>255&&(L=2*(k>>9)+2)}for(k-(I=x[P])+1==C&&h>0&&(C--,-1==n&&(i[C-1]^=31^i[C]-1&63)),y=f/N,v=b/S,C<k-I&&(i[C++]=129);C<k-I;)i[C++]=(149*C%253+130)%254;I/=L;var A=new Array(70),E=new Array(70),B=new Array(256),F=new Array(255);for(P=1,s=0;s<255;s++)F[s]=P,B[P]=s,(P+=P)>255&&(P^=301);for(A[I]=0,s=1;s<=I;s++)for(A[P=I-s]=1;P<I;P++)A[P]=A[P+1]^F[(B[A[P]]+s)%255];for(o=0;o<L;o++){for(s=0;s<=I;s++)E[s]=0;for(s=o;s<C;s+=L)for(P=0,x=E[0]^i[s];P<I;P++)E[P]=E[P+1]^(x?F[(B[A[P]]+B[x])%255]:0);for(s=0;s<I;s++)i[C+o+s*L]=E[s]}var W=Array(b+2*S).fill(null).map((function(){return[]}));for(s=0;s<f+2*N;s+=y+2)for(P=0;P<b;P++)W[P+2*(P/v|0)+1][s]=1,1&~P||(W[P+2*(P/v|0)][s+y+1]=1);for(s=0;s<b+2*S;s+=v+2)for(P=0;P<f+2*N;P++)W[s+v+1][P]=1,1&P||(W[s][P]=1);for(I=2,o=0,w=4,s=0;s<k;w-=I,o+=I){if(w==b-3&&-1==o)x=[f,6-b,f,5-b,f,4-b,f,3-b,f-1,3-b,3,2,2,2,1,2];else if(w!=b+1||1!=o||7&f||6!=(7&b)){if(0==w&&o==f-2&&3&f)continue;if(w<0||o>=f||w>=b||o<0)for(w+=2+(I=-I)/2,o+=2-I/2;w<0||o>=f||w>=b||o<0;)w-=I,o+=I;if(w==b-2&&0==o&&3&f)x=[f-1,3-b,f-1,2-b,f-2,2-b,f-3,2-b,f-4,2-b,0,1,0,0,0,-1];else if(w==b-2&&0==o&&4==(7&f))x=[f-1,5-b,f-1,4-b,f-1,3-b,f-1,2-b,f-2,2-b,0,1,0,0,0,-1];else{if(!(1!=w||o!=f-1||7&f||6!=(7&b)))continue;x=[0,0,-1,0,-2,0,0,-1,-1,-1,-2,-1,-1,-2,-2,-2]}}else x=[f-2,-b,f-3,-b,f-4,-b,f-2,-1-b,f-3,-1-b,f-4,-1-b,f-2,-2,-1,-2];for(C=i[s++],P=0;C>0;P+=2,C>>=1)if(1&C){var T=o+x[P],M=w+x[P+1];T<0&&(T+=f,M+=4-(f+4&7)),M<0&&(M+=b,T+=4-(b+4&7)),W[M+2*(M/v|0)+1][T+2*(T/y|0)+1]=1}}for(s=f;3&s;s--)W[s][s]=1;return W})(d))),m.setAttribute("class","datamatrix"),m.setAttribute("viewBox","0 0 18 18"),i.appendChild(c),null!=e.expiryDate){const t=document.createElement("div");t.className="expiracy",t.textContent="Geriausia iki ";const a=document.createElement("span");a.textContent=new Date(e.expiryDate).toLocaleDateString("lt-LT",{month:"2-digit",day:"2-digit"}),t.appendChild(a),i.appendChild(t)}if(null!=e.batchNumber){const t=document.createElement("div");t.className="batch-no",t.textContent=`Part. nr. ${e.batchNumber}`,i.appendChild(t)}if(1==e.addManufacturer&&null!=e.manufacturerName){const t=document.createElement("div");t.className="manufacturer",t.textContent=e.manufacturerName,i.appendChild(t)}if(1==e.addPackageFeeNote){const e=document.createElement("div");e.className="package",e.textContent="+ 0,01 (fas. maišelis)",i.appendChild(e)}return t.appendChild(i),t}async printLabelsUsingBrowser(e){const t=e.map((e=>this.generateLabel(e))),i=window.open("","_blank","width=700,height=700");if(null==i)return void alert("Please allow popups for this site");i.document.title=`${t.length} ${r("nlabelsToBePrinted")}`;const a=document.createElement("style");a.innerHTML='body{margin:0;padding:0}.label{position:relative;background:#fff;color:#000;height:31.75mm;width:57.15mm;border:.5px solid #ffdfd4;margin:0px;box-sizing:border-box;overflow:hidden}.item{height:19mm;overflow:hidden;padding:4px;font-family:Arial,sans-serif}.barcode{white-space:nowrap;position:absolute;bottom:0;z-index:3}.barcode div{font-size:10px;font-family:monospace;margin-left:6px;line-height:1em}.barcode p{margin:0}.deposit{position:absolute;right:2px;bottom:3px;font-family:serif;font-size:18px;font-weight:500;z-index:10}.price{position:absolute;bottom:22px;font-size:50px;right:0;overflow:hidden;object-position:center;margin-right:3px;line-height:1em;font-family:"Book Antiqua",serif;padding-right:10px}.alternative .barcode{left:50%;transform:translateX(-50%) scale(1.4);width:max-content}.alternative .barcode div{margin-left:0;font-size:7px}.alternative .price,.alternative .deposit{display:none}.weighted{display:grid;grid-template-columns:auto auto;align-items:center;justify-content:space-between;padding:5px;box-sizing:border-box;writing-mode:vertical-rl;grid-column-gap:4px;grid-row-gap:0px;font-family:"Arial";width:100%;height:100%}.weighted .barcode{grid-column:1;position:static;width:11mm;height:11mm}.weighted .item{grid-column:span 2;text-align:left;font-size:11pt;font-size:10pt;max-width:60pt;padding:0px;height:unset}.weighted .fprice{grid-row:2;grid-column:span 2;text-align:center;justify-self:center;align-self:end;font-size:16pt;font-weight:bold;line-height:1em;font-family:"Book Antiqua",serif;margin-right:4px}.weighted .kg-price{grid-column:2;justify-self:center;align-self:end}.weighted .kg-text{grid-column:2}.weighted .kg-text,.weighted .weight-text{justify-self:center;align-self:baseline;color:#999;font-size:.8em;line-height:.6}.weighted .weight-text{grid-column:1}.weighted .weight{grid-column:1;justify-self:center;align-self:end}.weighted .expiracy{grid-column:2;text-align:center;justify-self:center;align-self:center;line-height:.9;color:#444;font-size:.8em}.weighted .expiracy span{color:#000}.weighted .manufacturer,.weighted .batch-no,.weighted .description,.weighted .package{font-size:.7em;grid-column:span 2}.weighted .package{grid-row:3;grid-column:span 2;text-align:center;justify-self:center;align-self:center;margin-right:-5px;margin-left:5px;color:#444;font-size:10px;line-height:.8em}',i.document.head.appendChild(a),t.forEach((e=>{i.document.body.appendChild(e)})),i.addEventListener("afterprint",(()=>{i.close()})),i.print()}}class d{req;barcode;priceWithVat=0;priceWithoutVat=0;packageQuantity=0;modal;constructor(e){this.req=e,this.barcode=null,this.modal={nameInput:document.querySelector("#newItemName"),barcode:document.querySelector("#newItemBarcode"),price:document.querySelector("#newItemPrice"),packages:document.querySelector("#newItemPackageQuantity"),canBeWeighed:document.querySelector("#newItemCanBeWeighed"),alcohol:document.querySelector("#newItemAlcohol"),saveButton:document.querySelector("#saveNewItem")},this.bindEvents()}bindEvents(){this.modal.saveButton.addEventListener("click",this.save.bind(this))}calculatePriceWithoutVat(){const e=this.priceWithVat/1.21;return Math.round(1e4*(e+Number.EPSILON))/1e4}openModal(e){null==e.id&&(this.barcode=e.barcode,this.modal.barcode.value=e.barcode,this.modal.nameInput.value="",this.modal.price.value="",this.modal.packages.value="0",this.modal.canBeWeighed.checked=!1,this.modal.alcohol.checked=!1,$("#newItemModal").modal("show"))}save(){if(null==this.barcode)return;let e=new Object;e.name=this.modal.nameInput.value.length>2?this.modal.nameInput.value:r("newItem")+" "+this.barcode,this.priceWithVat=parseFloat(this.modal.price.value.replace(",",".")),this.priceWithVat>0&&(e.priceWithVat=this.priceWithVat,e.priceWithoutVat=this.calculatePriceWithoutVat()),this.packageQuantity=parseInt(this.modal.packages.value),this.packageQuantity>0&&(e.packageQuantity=this.packageQuantity,e.packageCode="1100"),this.modal.alcohol.checked&&(e.departmentNumber=2),this.modal.canBeWeighed.checked?e.measurementUnitId=6:e.measurementUnitId=3,e.isActive=!0,e.vatRate=21,e.attributeId=1,e.barcode=this.barcode,e.description=r("itemAdded")+" "+(new Date).toLocaleString(),this.modal.alcohol.checked&&(e.departmentNumber=2),console.info(e),$("#newItemModal").modal("hide"),this.req.createItem(e)}}class u{language;notifier;apiKey=null;numbers;languages={"lt-LT":{units:["","vienas","du","trys","keturi","penki","šeši","septyni","aštuoni","devyni"],teens:["dešimt","vienuolika","dvylika","trylika","keturiolika","penkiolika","šešiolika","septyniolika","aštuoniolika","devyniolika"],tens:["","","dvidešimt","trisdešimt","keturiasdešimt","penkiasdešimt","šešiasdešimt","septyniasdešimt","aštuoniasdešimt","devyniasdešimt"],hundreds:["","šimtas","du šimtai","trys šimtai","keturi šimtai","penki šimtai","šeši šimtai","septyni šimtai","aštuoni šimtai","devyni šimtai"]},"en-GB":{units:["","one","two","three","four","five","six","seven","eight","nine"],teens:["ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],tens:["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],hundreds:["","one hundred","two hundred","three hundred","four hundred","five hundred","six hundred","seven hundred","eight hundred","nine hundred"]}};constructor(e){this.language=window.navigator.language.split("-")[0],"lt"==this.language?this.language="lt-LT":this.language="en-GB",this.numbers=this.languages[this.language],this.notifier=e,this.checkApiKey()}async checkApiKey(){this.apiKey=await GM.getValue("api-key",null),null!=this.apiKey&&this.apiKey.length<20&&(this.apiKey=null,this.notifier.error(r("invalidApiKey")))}async speak(e){new Audio(await this.getAudioUrl(e)).play()}async getAudioUrl(e){if(null==this.apiKey)return;const t=await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:{text:e},voice:{languageCode:this.language,ssmlGender:"MALE"},audioConfig:{audioEncoding:"MP3"}})}),i=await t.json();if(null==i.audioContent)return void this.notifier.error({title:r("error"),message:JSON.stringify(i)});const a=i.audioContent,n=new Blob([Uint8Array.from(atob(a),(e=>e.charCodeAt(0)))],{type:"audio/mp3"});return URL.createObjectURL(n)}numberToWords(e){let t=[];if(0===e)t.push(r("zero"));else{const i=e%10,a=Math.floor(e/10)%10,n=Math.floor(e/100);n>0&&t.push(this.numbers.hundreds[n]),a>1&&t.push(this.numbers.tens[a]),1===a?t.push(this.numbers.teens[i]):t.push(this.numbers.units[i])}return t=t.filter((e=>e)),t.join(" ")}digitsToPrice(e){const t=Math.floor(e),i=Math.round(100*(e-t));let a=[];return t>0&&a.push(this.numberToWords(t)),i>0&&(0!==t&&"lt-LT"==this.language?(1===t||t%10==1&&t%100!=11?a.push("euras"):t%10==0||t%10>=10||t%100>=10&&t%100<=20?a.push("eurų"):a.push("eurai"),a.push("ir")):t>1&&"en-GB"==this.language?a.push("euros"):1===t&&"en-GB"==this.language&&a.push("euro"),a.push(this.numberToWords(i)),"en-GB"==this.language&&1===i?a.push("cent"):"en-GB"==this.language?a.push("cents"):1===i||i%10==1&&i%100!=11?a.push("centas"):i%10==0||i%10>=10||i%100>=10&&i%100<=20?a.push("centų"):a.push("centai")),a=a.filter((e=>e)),a.join(" ")}}class m{loadButton=document.getElementById("loadMarkdowns");table=document.getElementById("markdownTable");request;constructor(e){this.request=e,this.bindEvents()}bindEvents(){this.loadButton.addEventListener("click",this.load.bind(this))}async showSaleItems(e,t){const i=await this.request.getSaleItems(e);this.table.innerHTML=null==i?"No data found":"";const a=this.table.insertRow().insertCell();a.colSpan=4,a.textContent=t;const n=this.table.insertRow();n.insertCell().textContent=r("name");n.insertCell().textContent=r("quantity");n.insertCell().textContent=r("discount");n.insertCell().textContent=r("discountRate"),i.data.forEach((e=>{if(0!=e.discount){const t=this.table.insertRow();t.insertCell().textContent=e.virtualName+" (ID: "+e.itemId+")";t.insertCell().textContent=e.quantity;t.insertCell().textContent=e.discount;t.insertCell().textContent=e.discountRate+"%"}}))}async load(){const e=await this.request.getSales("nur");null==e&&(this.table.innerHTML="No data found"),this.render(e)}render(e){this.table.innerHTML="",e.data.forEach((e=>{const t=this.table.insertRow();t.insertCell().textContent=e.series+e.number;t.insertCell().textContent=e.saleDate;t.insertCell().textContent=e.discount,t.addEventListener("click",(()=>{this.showSaleItems(e.id,e.saleDate)}))}))}}class h{addManufacturer=document.getElementById("addManufacturer");addPackageFeeNote=document.getElementById("addPackageFeeNote");addButton=document.getElementById("addWeightedItem");batchNumber=document.getElementById("batchNumber");expiryDate=document.getElementById("expiryDate");kgPrice=document.getElementById("kgPrice");manufacturerField=document.getElementById("manufacturerField");parent=document.getElementById("weightLabelModal");printButton=document.getElementById("printWeightLabel");productName=document.getElementById("productName");productWeight=document.getElementById("productWeight");totalPrice=document.getElementById("totalPrice");keyboard=document.getElementById("keyboard");toggleButton=document.getElementById("toggleKeyboard");keys=document.querySelectorAll(".key");quantityLabel=document.getElementById("quantityLabel");activeInput=this.productWeight;currentItem=null;notifier;interface;constructor(e,t){this.notifier=e,this.interface=t,this.bindEvents()}bindEvents(){this.addButton.addEventListener("click",this.add.bind(this)),this.printButton.addEventListener("click",this.print.bind(this)),this.productWeight.addEventListener("keypress",this.interface.handleEnterPress((()=>{this.add()}))),this.productWeight.addEventListener("input",this.handleWeightChange.bind(this)),this.toggleButton.addEventListener("click",this.toggleKeyboard.bind(this));[this.productWeight,this.batchNumber].forEach((e=>{e.addEventListener("click",(()=>{this.activeInput=e}))})),this.keys.forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-key");null!=this.activeInput||null!=t?(null!=this.activeInput&&"del"==t&&this.activeInput?.value.length>0?this.activeInput.value=this.activeInput.value.slice(0,-1):null!=this.activeInput&&(this.activeInput.value+=t),this.handleWeightChange()):this.notifier.error(r("noActiveInput"))}))})),this.expiryDate.addEventListener("click",(()=>{this.expiryDate.showPicker()}))}openWeightModal(e){null!=e&&null!=this.productWeight&&null!=this.kgPrice&&null!=this.expiryDate&&null!=this.addManufacturer&&null!=this.manufacturerField?(this.currentItem=JSON.parse(JSON.stringify(e)),this.productWeight.value="",this.quantityLabel.innerHTML=this.currentItem?.measurementUnitCanBeWeighed?r("weight"):r("quantity")+" ("+this.currentItem?.measurementUnitName+")",this.productName.value=e.name,this.kgPrice.value=e.priceWithVat.toString(),this.expiryDate.min=(new Date).toISOString().split("T")[0],this.expiryDate.value="",this.addManufacturer.style.display=null!=e.manufacturerName?"block":"none",this.manufacturerField.innerHTML=e.manufacturerName??"",$(this.parent).modal("show"),this.productWeight.focus()):this.notifier.error(r("missingElements"))}getWeightItem(){return null==this.currentItem?.weight||isNaN(this.currentItem.weight)?(this.notifier.error(r("missingWeight")),null):this.currentItem?.weight>9.999?(this.notifier.error(r("maxWeight")),null):(this.currentItem.expiryDate=null!=this.expiryDate?.value&&this.expiryDate.value.length>0?this.expiryDate.value.slice(5):void 0,this.currentItem.batchNumber=null!=this.batchNumber?.value&&this.batchNumber.value.length>0?this.batchNumber.value:void 0,this.currentItem.addManufacturer=this.addManufacturer?.checked&&null!=this.currentItem.manufacturerName,this.currentItem.addPackageFeeNote=this.addPackageFeeNote?.checked,this.notifier.info({title:r("weightedItemAdded"),message:this.currentItem.weight+this.currentItem.measurementUnitName}),this.currentItem=JSON.parse(JSON.stringify(this.currentItem)),this.currentItem)}add(){const e=this.getWeightItem();null!=e&&this.interface.proccessItem(e)}print(){const e=this.getWeightItem();null!=e&&new c([e],this.interface.settings.alternativeLabelFormat)}debounce(e,t){let i;return(...a)=>{clearTimeout(i),i=setTimeout((()=>e.apply(this,a)),t)}}handleWeightChange(){null!=this.currentItem&&(this.currentItem.weight=null!=this.productWeight?.value?parseInt(this.productWeight.value)/1e3:0,this.currentItem.totalPrice=this.interface.calculateTotalPrice(this.currentItem),null!=this.totalPrice&&(this.totalPrice.value=this.currentItem.totalPrice.toFixed(2)))}toggleKeyboard(){null!=this.keyboard&&this.keyboard.classList.toggle("hidden"),null!=this.productWeight&&this.productWeight.focus()}}class p{items={};baseUrl="https://www.b1.lt";path="/reference-book/items/search";csrfToken;headers;notifier;constructor(e){const t=document.querySelector('meta[name="csrf-token"]');this.csrfToken=null!=t?t.content:"",this.notifier=e,this.headers={accept:"application/json, text/plain, */*","accept-language":"en-GB,en;q=0.9,lt-LT;q=0.8,lt;q=0.7,en-US;q=0.6","content-type":"application/json;charset=UTF-8",origin:this.baseUrl,referer:this.baseUrl,"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-origin","x-requested-with":"XMLHttpRequest","x-csrf-token":this.csrfToken,cookie:""}}async fetchData(e,t,i){if(""===this.csrfToken)return console.error("CSRF token is missing"),void this.notifier.error("CSRF token is missing");const a=t.split("/");a.pop(),this.headers.referer=`${this.baseUrl}${a.join("/")}`,this.getCookies();try{const a=await fetch(`${this.baseUrl}${t}`,{method:e,headers:this.headers,body:JSON.stringify(i)});if(a.ok){return await a.json()}console.error("Request failed with status:",a.status),this.notifier.error({title:r("error"),message:a.statusText})}catch(e){console.error("Error:",e),this.notifier.error("Error: "+e)}}getCookies(){document.cookie.split(";").map((e=>e.trim())).forEach((e=>{const[t,i]=e.split("=");["_fbp","YII_CSRF_TOKEN","b1-device_id","b1-session_id","b1-use-cookies","b1-wss_srv","_ga","b1-ref_url","_ga_F9V3KM1JRX"].includes(t.trim())&&(this.headers.cookie=this.headers.cookie.length>0?`${this.headers.cookie}; ${t}=${i}`:`${t}=${i}`)}))}isItDigits(e){return/^\d+$/.test(e)}removeLeadingZeros(e){return e.replace(/^0+/,"")}async getItem(e){if(!this.isItDigits(e))return this.notifier.error("Invalid barcode"),null;if(Object.keys(this.items).includes(e)){const t=this.items[e].retrievedAt;if(null!=t&&e.length>10&&(new Date).getTime()-t.getTime()<1e4)return JSON.parse(JSON.stringify(this.items[e]));if(null!=t&&e.length<10&&(new Date).getTime()-t.getTime()<3e4)return JSON.parse(JSON.stringify(this.items[e]))}const t={pageSize:20,filters:{groupOp:"AND",rules:{barcode:{data:this.removeLeadingZeros(e),field:"barcode",op:"eq"}}},allSelected:!1,asString:"",page:1},i=await this.fetchData("POST",this.path,t);return null==i||null==i.data[0]?null:(i.data[0].retrievedAt=new Date,this.items[e]=i.data[0],i.data[0])}async saveItem(e,t){if(!this.isItDigits(e))return this.notifier.error(r("invalidId")),!1;const i=await this.fetchData("POST",`/reference-book/items/update?id=${e}`,t);return 200===i.code?this.notifier.success({title:r("itemUpdated"),message:r("newPriceIs")+t.priceWithVat,delay:15e3}):this.notifier.error({title:r("failedToUpdateItem"),message:i.message}),200===i.code}async createItem(e){const t=await this.fetchData("POST","/reference-book/items/create",e);return 200===t.code?(this.notifier.success(r("itemCreated")),setTimeout((()=>{this.saveItem(t.data.id,{isActive:!0})}),400)):this.notifier.error({title:r("failedToCreateItem"),message:t.message}),200===t.code}async getSales(e){const t={sort:{saleDate:"desc"},page:1,pageSize:20,allSelected:!1,asString:"",filters:{rules:{operationTypeName:{data:e,field:"operationTypeName",op:"cn"}}}};return this.fetchData("POST","/warehouse/light-sales/search",t)}getSaleItems(e){const t={page:1,pageSize:-1,filters:{rules:{lightSaleId:{field:"lightSaleId",op:"eq",data:e}}}};return this.fetchData("POST","/warehouse/light-sale-items/search",t)}clearCache(){const e=Object.keys(this.items).length;this.items={},this.notifier.info({title:r("cacheCleared"),message:e+r("nItemsRemoved")})}}class g{notification=new o;req=new p(this.notification);textToVoice=new u(this.notification);items=[];active=!1;settings={alternativeLabelFormat:!1,clearAfterPrint:!0,sayOutLoud:!0,showStock:!1};modals;loadingIndicator=null;mainInput=null;itemList=null;constructor(){}isActive(){return this.active=null!==document.querySelector(".look-up-container"),this.active}init(){if(this.isActive())return!0;const e=document.querySelector(".main-container"),t=document.querySelector(".navbar-shortcuts"),i=document.querySelector(".footer");return null!=t&&null!=i&&null!=e&&(this.injectHtml(e),this.removeElements(i,e),this.simplifyPage(),this.cacheElements(),this.bindEvents(),!0)}simplifyPage(e=!0){return this.hideDropdownMenuItems(),this.changeDocumentTitle(),this.addNavItems(e),document.body.classList.add("labeler-interface"),!0}hideDropdownMenuItems(){document.querySelectorAll(".dropdown-menu li").forEach(((e,t)=>{t<9&&(e.style.display="none")}))}removeElements(...e){e.forEach((e=>{e.remove()}))}injectHtml(e){e.insertAdjacentHTML("beforebegin",function(e){return`<div class="container look-up-container"> <div class="row"> <div class="col-md-4 form-section"> <h4 class="header">${e("labelsAndPrices")}</h4> <div class="form-group input-group"> <input type="text" class="form-control" id="barcode" placeholder="${e("enterBarcode")}" autocomplete="off"> <div class="ready-for-scan pull-right text-success">${e("readyForScan")}</div> <button type="button" class="btn btn-info" id="searchButton">${e("code")}</button> </div> <div class="form-group"> <div class="checkbox-form hidden-sm"> <label> <input type="checkbox" class="ace" id="alternativeLabelFormat"> <span class="lbl display-inline">&nbsp;${e("alternativeLabelFormat")}</span> </label> </div> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="sayOutLoud" checked> <span class="lbl display-inline">&nbsp;${e("sayOutLoud")}</span> </label> </div> <div class="checkbox-form hidden-sm"> <label> <input type="checkbox" class="ace" id="clearAfterPrint" checked> <span class="lbl display-inline">&nbsp;${e("clearAfterPrint")}</span> </label> </div> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="showStock"> <span class="lbl display-inline">&nbsp;${e("showStock")}</span> </label> </div> </div> <div class="clearfix margin-bottom-10"> <div class="pull-right"> <button type="button" class="btn btn-purple" id="printButton"> <i class="fa fa-print"></i>&nbsp;${e("print")}</button> <button type="button" class="btn btn-danger" id="cleanAllButton">${e("cleanAll")}</button> </div> </div> </div> <div class="col-md-8 load-data"> <div class="load-overlay" style="display:none" id="loadingOverlay"> <div> <i class="fa fa-5x fa-b1-loader blue"></i> </div> </div> <div class="item-list"> <div class="alert alert-info text-center">${e("noItemsScanned")}</div> <div class="alert-xs grey text-center">${e("help")}</div> </div> </div> </div>\n</div> <div class="modal fade" id="itemDetails" tabindex="-1" role="dialog" aria-labelledby="itemDetailsLabel" aria-hidden="true"> <div class="modal-dialog" role="document"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title inline" id="itemDetailsLabel">${e("itemDetails")}</h5> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> </div> <div class="modal-body" data></div> <div class="modal-footer"> <button type="button" class="btn btn-primary btn-sm" data-dismiss="modal">${e("close")}</button> </div> </div> </div>\n</div> <div class="modal fade" id="weightLabelModal" tabindex="-1" aria-labelledby="weightLabelModalLabel" aria-hidden="true"> <div class="modal-dialog"> <div class="modal-content"> <div class="modal-header"> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> <h4 class="modal-title" id="weightLabelModalLabel">${e("weightLabel")}</h4> </div> <div class="modal-body"> <div class="form"> <div class="form-group"> <label for="productName">${e("name")}</label> <input type="text" class="form-control" id="productName" disabled> </div> <div class="row"> <div class="form-group col-sm-4"> <label for="productWeight" id="quantityLabel">${e("weight")} (g)</label> <input type="number" step="1" class="form-control" id="productWeight" min="0" required> </div> <div class="form-group col-sm-4"> <label for="totalPrice">${e("totalPrice")} (EUR)</label> <input type="number" step="0.01" class="form-control" id="totalPrice" disabled> </div> <div class="form-group col-sm-4"> <label for="kgPrice">${e("pricePerKg")} (EUR)</label> <input type="number" step="0.01" class="form-control" id="kgPrice" disabled> </div> </div> <div class="row"> <div class="col-sm-6"> <div class="form-group"> <label for="expiryDate">${e("expiryDate")}</label> <input type="date" class="form-control" id="expiryDate"> </div> <div class="form-group"> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="addManufacturer"> <span class="lbl display-inline">&nbsp;${e("addManufacturer")}&nbsp;</span> <span class="lbl display-inline" id="manufacturerField"> </label> </div> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="addPackageFeeNote" checked> <span class="lbl display-inline">&nbsp;${e("addPackageFeeNote")}</span> </label> </div> </div> </div> <div class="col-sm-6"> <div class="form-group"> <label for="batchNumber">${e("batchNumber")}</label> <input type="text" class="form-control" id="batchNumber"> </div> <div id="keyboard" class="keyboard"> <button class="key btn" data-key="1">1</button> <button class="key btn" data-key="2">2</button> <button class="key btn" data-key="3">3</button> <button class="key btn" data-key="4">4</button> <button class="key btn" data-key="5">5</button> <button class="key btn" data-key="6">6</button> <button class="key btn" data-key="7">7</button> <button class="key btn" data-key="8">8</button> <button class="key btn" data-key="9">9</button> <button class="key btn" data-key="0">0</button> <button class="key btn" data-key="-">-</button> <button class="key btn btn-danger backspace" data-key="del">⌫</button> </div> </div> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" id="toggleKeyboard">${e("toggleKeyboard")}</button> <button type="button" class="btn btn-secondary" data-dismiss="modal">${e("close")}</button> <button type="button" class="btn btn-primary" id="addWeightedItem">${e("add")}</button> <button type="button" class="btn btn-purple" id="printWeightLabel">${e("print")}</button> </div> </div> </div>\n</div>\n<div class="modal fade" id="markdownModal" tabindex="-1" role="dialog" aria-labelledby="markdownModal" aria-hidden="true"> <div class="modal-dialog" role="document"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title inline">${e("markdowns")}</h5> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> </div> <div class="modal-body"> <div class="form-group"> <button class="btn btn-white" id="loadMarkdowns"> <i class="fa fa-refresh"></i>&nbsp; ${e("showByDate")} </button> </div> <div class="table-responsive"> <table class="table table-striped table-bordered table-hover" id="markdownTable"></table> </div> </div> <div class="modal-footer"> <button type="button" class="btn" data-dismiss="modal">${e("close")}</button> </div> </div> </div>\n</div> <div class="modal fade" id="newItemModal" tabindex="-1" role="dialog" aria-labelledby="newItemModalLabel" aria-hidden="true"> <div class="modal-dialog" role="document"> <div class="modal-content"> <div class="modal-header"> <h5 class="modal-title inline" id="newItemModalLabel">${e("newItem")}</h5> <button type="button" class="close" data-dismiss="modal" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> </div> <div class="modal-body"> <div class="form-group"> <label for="newItemBarcode">${e("barcode")}</label> <input type="text" class="form-control" id="newItemBarcode" disabled </div> <div class="form-group"> <label for="newItemName">${e("name")}</label> <input type="text" class="form-control" id="newItemName" placeholder="${e("enterName")}"> </div> <div class="row"> <div class="form-group col-sm-6"> <label for="newItemPrice">${e("price")}</label> <input type="number" step="0.01" class="form-control" id="newItemPrice" placeholder="${e("enterPrice")}"> </div> <div class="form-group col-sm-6"> <label for="newItemPackages">${e("packageQuantity")} (${e("deposit")})</label> <input type="number" step="1" class="form-control" id="newItemPackageQuantity" placeholder="${e("enterPackages")}" required> </div> </div> <div class="form-group"> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="newItemCanBeWeighed"> <span class="lbl display-inline">&nbsp;${e("measurementUnitCanBeWeighed")}</span> </label> </div> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="newItemAlcohol"> <span class="lbl display-inline">&nbsp;${e("alcohol")}</span> </label> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" data-dismiss="modal">${e("close")}</button> <button type="button" class="btn btn-primary" id="saveNewItem">${e("save")}</button> </div> </div> </div> </div>`}(r))}createNavItem(e,t,i){const a=document.createElement("li"),n=document.createElement("a");n.className="navbar-shortcut",n.href="#",n.addEventListener("click",t);const r=document.createElement("i");return r.className="fa fa-fw "+i,n.appendChild(r),n.appendChild(document.createTextNode(e)),a.appendChild(n),a}addNavItems(e=!0){const t=document.querySelector(".navbar-shortcuts"),i=null!=t&&null!=t.querySelector(".fa-upload");if(null==t)return;t.innerHTML="";const a=document.createElement("ul");if(t.appendChild(a),e){const e=this.createNavItem(r("markdowns"),(()=>{}),"fa-book");e.setAttribute("data-toggle","modal"),e.setAttribute("data-target","#markdownModal"),a.appendChild(e);const t=this.createNavItem(r("itemCatalog"),(()=>{window.location.href="/reference-book/items"}),"fa-folder-open");a.appendChild(t)}else{const e=this.createNavItem(r("labelsAndPrices"),(()=>{window.location.href="/"}),"fa-arrow-left");a.appendChild(e)}const n=this.createNavItem(r("uploadFile"),(()=>{this.uploadFile()}),"fa-upload");a.appendChild(n);const o=document.querySelectorAll(".nav-user-dropdown__title");null==o||i||o.forEach((e=>{const t=document.createElement("i");t.className="fa fa-fw fa-power-off",e.appendChild(t);e.querySelector(".nav-user-company").style.display="none"}))}uploadFile(){const e=document.createElement("input");e.type="file",e.accept=".pdf",e.addEventListener("change",(e=>{this.handleFile(e)})),e.click()}async handleFile(e){const t=e.target;if(null==t.files||0===t.files.length)return void this.notification.error(r("noFileSelected"));const i=angular.element(document.body).injector(),a=i.get("$uibModal"),n=i.get("$controller"),o=i.get("$rootScope").$new(),s=n("AccountFileUpload",{$translate:i.get("$translate"),$uibModal:a,$confirm:i.get("$confirm"),util:i.get("util"),notification:this.notification,accountFileUpload:i.get("accountFileUpload"),$scope:o,socket:i.get("socket")}),l=Array.from(t.files);console.info(l),s.uploadToCompany(l,currentCompanyUser.company.id),await new Promise((e=>setTimeout(e,5e3)))}bindEvents(){if(document.getElementById("cleanAllButton")?.addEventListener("click",(()=>{this.cleanAll()})),document.getElementById("printButton")?.addEventListener("click",(()=>{this.print()})),null!=this.mainInput){this.mainInput.addEventListener("keypress",this.handleEnterPress(this.searchByBarcode.bind(this,this.mainInput))),document.getElementById("searchButton")?.addEventListener("click",this.searchByBarcode.bind(this,this.mainInput)),this.mainInput.focus();const e=document.querySelectorAll(".modal");document.addEventListener("click",(t=>{let i=!1;e.forEach((e=>{e.contains(t.target)&&(i=!0)})),i||null==this.mainInput||this.mainInput.focus()}))}this.bindCheckboxChange("alternativeLabelFormat","alternativeLabelFormat"),this.bindCheckboxChange("sayOutLoud","sayOutLoud"),this.bindCheckboxChange("clearAfterPrint","clearAfterPrint"),this.bindCheckboxChange("showStock","showStock")}handleEnterPress(e){return t=>{"Enter"==t.key&&e()}}bindCheckboxChange(e,t){document.getElementById(e)?.addEventListener("change",(e=>{e.target instanceof HTMLInputElement&&(this.settings[t]=e.target.checked)}))}cacheElements(){this.itemList=document.querySelector(".item-list"),this.mainInput=document.getElementById("barcode"),this.loadingIndicator=document.getElementById("loadingOverlay"),this.modals={itemDetails:document.getElementById("itemDetails"),newItem:new d(this.req),weight:new h(this.notification,this),markdown:new m(this.req)}}showLoading(){null!=this.loadingIndicator&&(this.loadingIndicator.style.display="flex")}hideLoading(){null!=this.loadingIndicator&&(this.loadingIndicator.style.display="none")}print(e=this.settings.clearAfterPrint){this.items=this.items.filter((e=>e)),0!==this.items.length?(this.items.every((e=>1==e.isActive&&null!=e.barcode))||this.notification.warning(r("notAllItemsActive")),new c(this.items,this.settings.alternativeLabelFormat),e&&this.cleanAll(!0)):this.notification.error(r("noData"))}cleanAll(e=!1){this.items=[],null!=this.itemList?this.itemList.innerHTML=e?`<div class="alert alert-success text-center">${r("printJobIsSent")}. ${r("noItemsScanned")}</div>`:`<div class="alert alert-info text-center">${r("noItemsScanned")}</div>`:console.error("itemList is not defined")}createItemElement(e){const t=document.createElement("div");t.className="item",t.id=e.id??"",t.innerHTML=this.getItemHtml(e,!0),null==e.barcode||0==e.isActive?t.classList.add("inactive"):null!=e.weight&&t.classList.add("mark");const i=this.createItemButton("btn-yellow","fa-trash",(()=>{this.removeItem(t,e.id)}));if(t.appendChild(i),e.measurementUnitCanBeWeighed){const i=this.createItemButton("btn-pink","fa-balance-scale",(()=>{this.modals?.weight.openWeightModal(e)}));t.appendChild(i)}else if(null==e.id){const i=this.createItemButton("btn-info","fa-plus",(()=>{this.modals?.newItem.openModal(e)}));t.appendChild(i)}if(e.priceWithVat>0)t.querySelector(".item-price")?.addEventListener("click",(()=>{this.showDetails(e)}));else if(null!=e.id){const i=this.createItemButton("btn-danger","fa-euro",(()=>{this.quickPriceChange(e)}));t.appendChild(i)}return t}getItemHtml(e,t){return`\n      <div class="item-main">\n        ${(e.priceWithVat>0?`<span class="item-price">${(e.totalPrice??e.priceWithVat).toFixed(2)}</span>`:"")+(this.settings.showStock?`<span class="item-stock text-primary"><i class="fa fa-home margin-right-5"></i>${e.stock||"0"}</span>`:"")}\n        <span class="item-name">${e.name}</span>\n      </div>`+(t?`<div class="item-labels">${this.getItemLabelsHtml(e)}</div>`:"")}getItemLabelsHtml(e){const t=this.getSeconds(e.retrievedAt??new Date);return["packageCode","weight","departmentNumber","packageQuantity"].map((t=>null!=e[t]?`<span>${r(t)}: ${e[t]}</span>`:"")).join("")+(null!=e.weight?`<span>${r("kiloPrice")}: <b>${e.priceWithVat.toFixed(3)}</b></span>`:"")+(e.measurementUnitCanBeWeighed?`<span>${r("weightedItem")}</span>`:"")+`<span class="text-primary">${this.getAgoText(t)}</span>`}getSeconds(e){if(null==e)return 0;return Math.floor(((new Date).getTime()-new Date(e).getTime())/1e3)}getAgoText(e){return 0===e?"":r("checked")+" "+e+" s "+r("ago")}createItemButton(e,t,i){const a=document.createElement("button");a.addEventListener("click",i),a.className="btn btn-sm "+e,a.type="button";const n=document.createElement("i");return n.className="fa "+t,a.appendChild(n),a}removeItem(e,t){e.remove(),this.items=this.items.filter((e=>e.id!==t))}showDetails(e){const t=Object.fromEntries(Object.entries(e).filter((([e,t])=>null!==t&&!e.toString().toLowerCase().includes("id")))),i=Object.entries(t).map((([e,t])=>`<div class="row col-xs-12 ${e.includes("price")?"price":""}"><div class="col-sm-5">${r(e)}:</div><div class="col-sm-7">${t}</div></div>`)).join("");if(null!=this.modals?.itemDetails){const t=this.modals.itemDetails.querySelector(".modal-body");null!=t&&(t.innerHTML=`<div class="container width-auto">${i}</div>`);this.modals.itemDetails.querySelectorAll(".price").forEach((t=>t.addEventListener("click",(()=>{this.quickPriceChange(e)}))))}$(this.modals?.itemDetails).modal("show")}quickPriceChange(e){let t=prompt(r("enterNewPrice"),e.priceWithVat.toString());if(null==t||null==e.id)return void this.notification.info(r("error"));let i=new Object;i.id=e.id.split("-")[0],i.isActive=!0,i.priceWithVat=parseFloat(t.replace(",",".")),i.priceWithVat<=0?this.notification.error(r("missingPrice")):(i.priceWithoutVat=i.priceWithVat/1.21,i.priceWithoutVat=Math.round(1e4*(i.priceWithoutVat+Number.EPSILON))/1e4,e.priceWithVat=i.priceWithVat,e.priceWithoutVat=i.priceWithoutVat,this.req.saveItem(i.id,i),$(this.modals?.itemDetails).modal("hide"),this.cleanAll())}addItemToView(e){const t=this.createItemElement(e);null!=this.itemList?(this.itemList.appendChild(t),t.scrollIntoView({behavior:"smooth",block:"end"})):this.notification.error(r("missingElements"))}proccessItem(e){e.id=this.generateItemId(e.id),this.settings.sayOutLoud&&(this.items.length>0&&e.priceWithVat>0&&this.items[this.items.length-1].barcode==e.barcode&&e.weight==this.items[this.items.length-1].weight?this.textToVoice.speak(r("asMentioned")+", "+r("price")+" "+this.textToVoice.digitsToPrice(e.totalPrice??e.priceWithVat)+(void 0!==e.weight?". "+r("weight")+this.textToVoice.numberToWords(e.weight)+e.measurementUnitName:"")+" "+r("thisIs")+" "+e.name):e.priceWithVat>0?this.textToVoice.speak(r("price")+" "+this.textToVoice.digitsToPrice(e.totalPrice??e.priceWithVat)):this.textToVoice.speak(r("priceNotSet"))),0===this.items.length&&null!=this.itemList&&(this.itemList.innerHTML=""),this.items.push(e),this.addItemToView(e)}canItBePackaged(e){const t=parseInt(e.slice(0,2),10);return(13===e.toString().length||21===e.toString().length)&&t>20&&t<30}searchByBarcode(t){const i=e(t.value);t.value="",t.focus(),0!=i.length?"stop"!==i.toLowerCase()?this.canItBePackaged(i)?this.searchforAPackagedItem(i):this.searchItem(i):this.print():this.notification.error(r("missingBarcode"))}async searchforAPackagedItem(e){let t=null;const i=e.length>13?e.slice(4,17):e.slice(0,8);this.showLoading(),t=await this.req.getItem(i),this.hideLoading(),null!=t?(t.weight=parseInt(e.length>13?e.slice(17,21):e.slice(8,12),10)/1e3,t.totalPrice=this.calculateTotalPrice(t),this.proccessItem(t)):this.notFound(e)}async searchItem(e){this.showLoading();const t=await this.req.getItem(e);this.hideLoading(),null!=t?this.proccessItem(t):this.notFound(e)}notFound(e){let t=new Object;t.name=r("itemNotFound")+" ("+r("barcode")+": "+e+")",t.barcode=e,t.isActive=!1,this.addItemToView(t)}calculateTotalPrice(e){if(null==e.weight)return 0;const t=e.priceWithVat*e.weight;return Math.round(100*(t+Number.EPSILON))/100}addActivateButton(){const e=document.querySelector(".breadcrumbs");if(null!=e){const t=document.createElement("button");t.textContent=r("labelsAndPrices"),t.className="btn btn-sm",t.addEventListener("click",this.init.bind(this)),e.appendChild(t)}return null!=e}generateItemId(e){return e+"-"+Math.random().toString(36).substring(7)}changeDocumentTitle(){document.title=r("labelsAndPrices")}}class b{constructor(){const e=document.querySelector(".btn-ctrl");null!==e&&null===e.querySelector(".simplify-button")&&e.appendChild(this.createHideFieldsButton());const t=document.querySelector('input[name="barcode"]');null!==t&&(t.removeEventListener("input",(e=>{this.handleInputChange(e)})),t.addEventListener("input",(e=>{this.handleInputChange(e)})))}simplifyForm(){document.querySelector("ng-form")?.classList.add("simplified-form");["vatRate","minQuantity","netWeight","grossWeight","expenseCorrespondenceAccountCode","saleCorrespondenceAccountCode","purchaseCorrespondenceAccountCode","externalId","isCommentRequired","defaultSaleService","countryOfOriginName","intrastatShortDescription","intrastatCode","priceFrom","priceUntil","minPriceWithVat","priceMinQuantity","discountStatus","maxDiscount","discountPointsStatus","ageLimit","certificateDate","certificateNumber","validFrom","validUntil","attribute1","attribute2","attribute3"].forEach((e=>{this.hideFormGroupByInputName(e)}));const e=this.findFormGroupByInputName("cost")?.parentElement,t=this.findFormGroupByInputName("manufacturerName")?.parentElement;null!=e&&null!=t&&t.parentElement?.appendChild(e)}findFormGroupByInputName(e){const t=e.includes("Status")?document.querySelector(`select[name="${e}"]`):document.querySelector(`input[name="${e}"]`);return t?.closest(".form-group")}hideFormGroupByInputName(e){const t=this.findFormGroupByInputName(e);if(null!=t){const e=t.closest(".form-group");if(null!=e){e.style.display="none";const t=e.parentElement;null==t||t.classList.contains("col-lg-12")||t.tagName.includes("FORM")||(t.style.display="none")}}}createHideFieldsButton(){const e=document.createElement("button");return e.className="btn btn-sm margin-left-5 simplify-button",e.type="button","true"===localStorage.getItem("simplifyForm")?(e.textContent=r("resetForm"),this.simplifyForm()):e.textContent=r("simplifyForm"),e.addEventListener("click",this.toggleFormLayout.bind(this)),e}toggleFormLayout(){const e=document.querySelector(".simplify-button"),t="true"===localStorage.getItem("simplifyForm")?"false":"true";localStorage.setItem("simplifyForm",t),"true"===t?(this.simplifyForm(),null!=e&&(e.textContent=r("resetForm"))):(document.querySelectorAll(".form-group").forEach((e=>{e.style.display="block";const t=e.parentElement;null!=t&&(t.style.display="block")})),null!=e&&(e.textContent=r("simplifyForm")))}handleInputChange(t){const i=t.target,a=i.value=e(i.value);/^\d+$/.test(a)?13===a.length||8===a.length?i.style.backgroundColor="lightgreen":a.length<13?i.style.backgroundColor="beige":i.style.backgroundColor="orangered":i.style.backgroundColor="orangered"}}class f{wereButtonsAdded=!1;pageReady=!1;notification=new o;user=new s;interface=new g;currentUrl;constructor(){this.currentUrl=window.location.pathname,this.init(),this.handleUrlChange(null,this.currentUrl),console.debug("LabelsUserscript initialized")}init(){this.overrideHistoryMethods(),this.setupPopStateListener(),this.addStyles()}overrideHistoryMethods(){const e=history.pushState;history.pushState=(t,i,a)=>{const n=this.currentUrl,r=e.apply(history,[t,i,a]);return this.currentUrl=window.location.pathname,this.handleUrlChange(n,this.currentUrl),r};const t=history.replaceState;history.replaceState=(e,i,a)=>{const n=this.currentUrl,r=t.apply(history,[e,i,a]);return this.currentUrl=window.location.pathname,this.handleUrlChange(n,this.currentUrl),r}}setupPopStateListener(){window.addEventListener("popstate",(()=>{const e=this.currentUrl;this.currentUrl=window.location.pathname,this.handleUrlChange(e,this.currentUrl)}))}async handleUrlChange(e,t,i=0){if(console.info("Url has changed"),this.pageReady=!1,this.user.isLoggedIn&&this.user.admin&&!this.interface.isActive()){!this.wereButtonsAdded&&this.interface.addActivateButton()&&(this.wereButtonsAdded=!0),new Promise((e=>setTimeout(e,200)));let e=!1;switch(this.currentUrl){case"/en/reference-book/items":case"/en/warehouse/purchases/edit":case"/reference-book/items":case"/warehouse/purchases/edit":e=this.addPrintButton(),e&&setTimeout((()=>{null==document.querySelector(".print")&&this.addPrintButton()}),1e3);break;case"/en/reference-book/items/edit":case"/reference-book/items/edit":e=this.addPrintButton(".btn-ctrl",!0),e&&new b;break;default:e=!0}e&&(this.pageReady=!0)}else if(!this.user.isLoggedIn||this.user.admin||this.interface.isActive())this.user.isLoggedIn||"/login"!==this.currentUrl?this.pageReady=!0:this.pageReady=this.user.addLoginOptions();else switch(this.currentUrl){case"/en/warehouse/light-sales/edit":case"/warehouse/light-sales/edit":this.pageReady=this.interface.simplifyPage(!1);break;case"/en/reference-book/items":case"/en/warehouse/purchases/edit":case"/reference-book/items":case"/en/reference-book/items/edit":case"/reference-book/items/edit":this.pageReady=this.interface.simplifyPage(!1)&&this.addPrintButton(".buttons-left",!0)&&this.addFilters();break;default:this.pageReady=this.interface.init()}!this.pageReady&&i<5&&setTimeout((()=>{this.handleUrlChange(null,this.currentUrl,i+1)}),600)}getDataRows(){const e=document.querySelector(".data-rows");if(null==e)throw this.notification.error(r("error")),new Error("Data rows not found");return e}extractDataFromAngularItemList(){const e=this.getDataRows();return angular.element(e).controller().grid.data.filter((e=>e._select))}async extractDataFromAngularPurchaseView(){const e=this.getDataRows(),t=angular.element(e).controller().data.filter((e=>e._select)),i=[];if(confirm(r("askingForPackageCode"))){this.notification.primary(r("aboutToCheckPackageCode"));const e=t.map((e=>e.itemBarcode)),a=new p(this.notification);for(const t of e){const e=await a.getItem(t);null!=e&&i.push(e),await new Promise((e=>setTimeout(e,200)))}}else t.forEach((e=>{i.push({name:e.itemName,barcode:e.itemBarcode,code:e.itemCode,priceWithVat:e.itemPriceWithVat,measurementUnitName:e.measurementUnitName,isActive:!0})}));return i}extractDataFromAngularItemView(){const e=document.querySelector("ng-form");if(null==e)return this.notification.error(r("error")),[];return[angular.element(e).controller().model]}processItemsfromAngular(){let e=[];switch(window.location.pathname){case"/en/reference-book/items":case"/reference-book/items":e=this.extractDataFromAngularItemList();break;case"/en/warehouse/purchases/edit":case"/warehouse/purchases/edit":e=this.extractDataFromAngularPurchaseView();break;case"/en/reference-book/items/edit":case"/reference-book/items/edit":e=this.extractDataFromAngularItemView()}new c(e)}addPrintButton(e=".buttons-left",t=!1){const i=document.querySelector(e);if(null==i)return!1;const a=document.querySelector("i.fa-cloud-upload");if(null!=a){const e=a.parentElement?.parentElement;null!=e&&e.remove()}let n=document.createElement("div");n.className="print";let o=document.createElement("button");o.title=r("print"),o.type="button",o.className="btn btn-sm btn-purple";let s=document.createElement("i");if(s.className="fa fa-fw fa-print",o.appendChild(s),t){let e=document.createElement("span");e.className="margin-left-5",e.textContent=r("print"),o.appendChild(e)}if(o.addEventListener("click",this.processItemsfromAngular.bind(this)),n.appendChild(o),i.appendChild(n),o=document.createElement("button"),o.title=r("weightLabel"),o.type="button",o.className="btn btn-sm btn-pink",s=document.createElement("i"),s.className="fa fa-fw fa-balance-scale",o.appendChild(s),t){let e=document.createElement("span");e.className="margin-left-5",e.textContent=r("weightLabel"),o.appendChild(e)}return o.addEventListener("click",this.goToWeightLabelModal.bind(this)),n=document.createElement("div"),n.appendChild(o),i.appendChild(n),!0}goToWeightLabelModal(){const e=this.extractDataFromAngularItemList();e.length<1?this.notification.error(r("noItemsSelected")):e.length>1?this.notification.error(r("tooManyItems")):"kg"!==e[0].measurementUnitName||e[0].priceWithVat<0||null==e[0].priceWithVat?this.notification.error(r("error")):(this.interface.init(),this.interface.modals?.weight.openWeightModal(e[0]))}addFilters(){if("/en/reference-book/items"!==window.location.pathname&&"/reference-book/items"!==window.location.pathname)return!1;const e=document.querySelector(".data-rows");if(null==e)return!1;const t=angular.element(e).controller().grid;return t.filter.asString="[Aktyvi?:true] ",t.filter.filters.rules.isActive={data:!0,field:"isActive",op:"eq"},t.filter.sort={id:"desc"},setTimeout((()=>{t.provider.refresh(),this.notification.info({message:r("show")+": "+t.filter.asString,positionY:"bottom"})}),700),!0}addStyles(){const e=document.createElement("style");e.innerHTML='body.labeler-interface{background-color:#eee}body.labeler-interface .sidebar{display:none !important;pointer-events:none}body.labeler-interface .input-group{display:flex}body.labeler-interface .main-content *{border-radius:4px !important}body.labeler-interface .main-content table.table.table-bordered *{border-radius:unset !important}body.labeler-interface .main-content .btn-ctrl:has(.fa-print) button.btn.btn-sm:has(.fa-print),body.labeler-interface .main-content span.resizer{filter:contrast(0.6);pointer-events:none}body.labeler-interface .main-content .breadcrumbs,body.labeler-interface .main-content .nav-tabs,body.labeler-interface .main-content .no-border,body.labeler-interface .main-content .form-group:has(.fa-star),body.labeler-interface .main-content .table-responsive thead tr>:nth-child(4),body.labeler-interface .main-content .table-responsive thead tr>:nth-child(6),body.labeler-interface .main-content .table-responsive thead tr>:nth-child(7),body.labeler-interface .main-content .table-responsive tbody tr>:nth-child(4),body.labeler-interface .main-content .table-responsive tbody tr>:nth-child(6),body.labeler-interface .main-content .table-responsive tbody tr>:nth-child(7),body.labeler-interface .main-content .uib-typeahead-match .tt-suggestion>:nth-child(2),body.labeler-interface .main-content .uib-typeahead-match .tt-suggestion>:nth-child(3),body.labeler-interface .main-content .uib-typeahead-match .tt-suggestion>:nth-child(4),body.labeler-interface .main-content .uib-typeahead-match .tt-suggestion>:nth-child(5),body.labeler-interface .main-content .form-horizontal:nth-child(3)>:nth-child(2)>:nth-child(2),body.labeler-interface .main-content .form-horizontal:nth-child(3)>:nth-child(2)>:nth-child(3),body.labeler-interface .main-content .form-horizontal:nth-child(3)>:nth-child(5),body.labeler-interface .main-content .form-horizontal:nth-child(1)>:nth-child(2)>:nth-child(1)>:nth-child(2)>:nth-child(2),body.labeler-interface .main-content .form-horizontal:nth-child(1)>:nth-child(2)>:nth-child(3)>:nth-child(2)>:nth-child(2),body.labeler-interface .main-content .extd-grid-control .extd-grid-buttons.buttons-right,body.labeler-interface .main-content tr.sub-grid-row,body.labeler-interface .main-content td.sub-grid,body.labeler-interface .main-content .extd-grid-title,body.labeler-interface .main-content td[ng-if="config.subGrid"]{display:none !important;pointer-events:none}body.labeler-interface .main-content td[extd-touch-resize],body.labeler-interface .main-content a{-webkit-user-drag:none;user-drag:none}body.labeler-interface .main-content .input-group-addon,body.labeler-interface .main-content .input-group-btn{display:table-column}body.labeler-interface .main-content .sticky{background:rgba(0,0,0,0)}body.labeler-interface .main-content .sticky .btn-ctrl>div{border:unset;padding:unset}body.labeler-interface .main-content input[ng-model="filter.page"]{width:30px}body.labeler-interface .main-content .pagination-wrap button.btn.btn-sm.btn-transparent{background:#fff !important}body.labeler-interface .navbar{background-color:var(--theme-blue--dark-bg)}body.labeler-interface .navbar .navbar-header .navbar-brand{padding-left:1em;filter:brightness(0) invert(1)}body.labeler-interface .navbar .navbar-header .navbar-toggle{display:none}body.labeler-interface .navbar a.navbar-shortcut{color:#eee}body.labeler-interface .navbar a.navbar-shortcut i{font-size:1.2em;margin:0 2px;text-align:center}body.labeler-interface .navbar li:has(.navbar-shortcut):hover{background:rgba(0,0,0,.3607843137)}body.labeler-interface .navbar .navbar-nav>*:not(:last-child){display:none}body.labeler-interface .navbar .navbar-nav>*:nth-last-child(2),body.labeler-interface .navbar .navbar-nav>*:nth-last-child(4),body.labeler-interface .navbar .navbar-nav>*:nth-last-child(5),body.labeler-interface .navbar .navbar-nav>*:nth-last-child(7){display:block}body.labeler-interface .navbar .navbar-collapse-2 img,body.labeler-interface .navbar .navbar-collapse-2 .divider{display:none}body.labeler-interface .navbar .navbar-collapse-2 .nav-user-shortcut{height:100%}body.labeler-interface .navbar .navbar-nav li.nav-user-dropdown img,body.labeler-interface .navbar .navbar-nav li.nav-user-dropdown .divider{display:none}body.labeler-interface .navbar .navbar-nav li.nav-user-dropdown a .nav-user-company{font-size:unset !important;line-height:unset !important}body.labeler-interface .navbar .navbar-nav li.nav-user-dropdown a{padding:15px 10px}body.labeler-interface .navbar .nav-user-dropdown__title{color:#d9d9d9;padding-right:10px;font-size:15px;max-width:unset}body.labeler-interface .navbar .nav-user-dropdown__title .caret{color:#d9d9d9}body.labeler-interface .navbar .nav-user-dropdown__title *:first-child{display:none}.look-up-container *:not(.header){border-radius:4px}.look-up-container .load-data{padding:10px}@media screen and (max-width: 992px){.look-up-container .load-data{padding:10px 0 !important}}.look-up-container .load-overlay{background-color:rgba(238,238,238,.7490196078)}.look-up-container .form-section{border:1px solid #ddd;margin-top:10px;box-shadow:0 0px 8px rgba(0,0,0,.1)}.look-up-container .item-list{max-height:calc(100vh - 70px);overflow:auto}.look-up-container .item-list .item:not(.mark):not(.inactive){background-color:#fff}.look-up-container .item-list .item{transition:.5s;animation:highlight .5s ease-out;display:grid;grid-template-columns:auto min-content min-content;column-gap:5px;font-size:1.1em;border:1px solid #ddd;padding:10px;margin-bottom:4px;cursor:pointer;position:relative}.look-up-container .item-list .item .item-price,.look-up-container .item-list .item .item-stock{font-weight:bold;background-color:var(--theme-blue--dark-bg);color:#fff;padding:2px 8px;margin-right:4px}.look-up-container .item-list .item .item-stock{background-color:#777}.look-up-container .item-list .item .item-main{grid-row:1;grid-column:1}.look-up-container .item-list .item .item-labels{grid-column:1;grid-row:2;align-self:center}.look-up-container .item-list .item .btn{grid-row:1/span 2;border:none}.look-up-container .item-list .item .btn-yellow{grid-column:3}.look-up-container .item-list .item:last-child{margin-bottom:30px;animation:highlight .5s ease-out,emphasizeItem .5s ease-in-out 5s backwards}.look-up-container .item-list .item.inactive{background-color:#f8d7da !important}.look-up-container .item-list .item.mark{background-color:#fcf8e3 !important}.look-up-container .item-list .item:hover{background-color:#f1f1f1 !important}.look-up-container .item-list .item *:empty:not(i){display:none}.look-up-container .item-list .item .item-price{margin-right:4px;border-radius:4px;transition:.5s}.look-up-container .item-list .item:last-child .item-price{animation:emphasizePrice .5s ease-in-out 5s backwards}.look-up-container .item-labels{font-size:.8em;color:#666}.look-up-container .item-labels span{margin-right:10px}.look-up-container .form-group{position:relative}.look-up-container .ready-for-scan{opacity:0;transition:.5s;position:absolute;right:0%;width:80px;text-align:right;color:var(--theme-orange--base-bg);padding-top:35px;text-transform:lowercase}.look-up-container #barcode:focus:placeholder-shown+.ready-for-scan{opacity:1}.container.width-auto>.row{padding:5px 0px;white-space:pre-line;border-bottom:1px solid #eee}#weightLabelModal *{border-radius:4px !important}#weightLabelModal .keyboard{display:grid;background-color:#f5f5f5;padding:10px;grid-template-columns:repeat(3, 1fr);gap:10px;width:200px;margin:0px auto}#weightLabelModal .keyboard>*{padding:10px;font-size:18px}.modal-backdrop{display:none}.modal{background-color:rgba(0,0,0,.5)}@keyframes emphasizeItem{from{font-size:1.2em}}@keyframes emphasizePrice{from{margin-left:-10px;padding-left:10px;border-radius:0px 5px 5px 0px;background-color:#000}}@keyframes highlight{from{background-color:#1b6aaa;color:#fff;filter:opacity(0.5)}}',document.head.appendChild(e)}}window.addEventListener("load",(()=>{new f,setTimeout((()=>{null!=window.clarity&&window.clarity("stop")}),500)}))}();
