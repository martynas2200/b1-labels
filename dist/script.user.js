// ==UserScript==
// @name              Label Generator for the items in b1.lt
// @namespace         http://tampermonkey.net/
// @homepage          https://github.com/martynas2200/b1-labels
// @version           1.7.0
// @description       Generate labels for the selected items on the b1.lt website
// @author            Martynas Miliauskas
// @match             https://www.b1.lt/*
// @icon              https://b1.lt/favicon.ico
// @connect           b1.lt
// @connect           raw.githubusercontent.com
// @downloadURL       https://raw.githubusercontent.com/martynas2200/b1-labels/main/dist/script.user.js
// @updateURL         https://raw.githubusercontent.com/martynas2200/b1-labels/main/dist/script.user.js
// @grant             GM.setValue
// @grant             GM.getValue
// @grant             unsafeWindow
// @grant             GM_xmlhttpRequest
// @license           GNU GPLv3
// ==/UserScript==

!function(){"use strict";const e={en:{normal:"Normal",half:"Half",add:"Add",addManufacturer:"Add Manufacturer",addPackageFee:"Add Package Fee",addToList:"Add to List",ageLimit:"Age Limit",ago:"ago",barcodeOnly:"Barcode only",fridge:"Fridge",alcohol:"Alcohol",asMentioned:"As mentioned",attributeName:"Attribute Name",autoLogin:"Instant Login",barcode:"Barcode",checked:"Checked",chooseLabelType:"Choose label type",chooseLabelTypeDescription:"Choose the type of label you want to print",cleanAll:"Clean All",close:"Close",code:"Code",cost:"Cost",countryOfOriginName:"Country of Origin Name",date:"Date",defaultSaleService:"Default Sale Service",departmentNumber:"Department",description:"Description",discount:"Discount",discountPointsStatus:"Discount Points Status",discountRate:"Discount Rate",discountStatus:"Discount Status",done:"Done",enterBarcode:"Enter the barcode",enterName:"Enter Name",enterNewPrice:"Enter new price",error:"Error",expiryDate:"Expiry Date",files:"Files",fitRaso:"Fit Raso",freePrice:"Free Price",fullBarcode:"Full Barcode",fullName:"Full Name",grossWeight:"Gross Weight",groupName:"Group Name",help:"If you have any problems, reach out via GitHub",inactiveItem:"The item is inactive. Do you want to continue?",isActive:"Is Active",isCommentRequired:"Is Comment Required",isQuantitative:"Is Quantitative",isRefundable:"Is Refundable",itemAdded:"Item added",itemCatalog:"Item Catalog",itemCreated:"Item created",itemDetails:"Item Details",itemNotFound:"Item not found!",itemsFound:"Items found",itemUpdated:"Item updated",kiloPrice:"Price per kilo",labelsAndPrices:"Labels and Prices",leftover:"Leftover",loading:"Loading...",login:"Login",loginDetailsNotFound:"Login details not found",manufacturerName:"Manufacturer Name",markdowns:"Markdowns",maxDiscount:"Max Discount",measurementUnitCanBeWeighed:"Measurement Unit Can Be Weighed",measurementUnitName:"Measurement Unit Name",minPriceWithVat:"Min Price With VAT",minQuantity:"Min Quantity",missingBarcode:"Missing barcode",missingElements:"Missing UI elements",missingName:"Missing name",missingWeight:"Missing weight",multipleItemsFound:"Multiple items found!",name:"Name",netWeight:"Net Weight",newItem:"New Item",newPriceIs:"New price is: ",nItemsRemoved:" items removed",nlabelsToBePrinted:" labels to be printed",no:"No",noActiveInput:"No active input",noData:"No data to print!",noItemsFound:"No items found",noItemsScanned:"No items scanned",noItemsSelected:"No items selected!",notAllItemsActive:"Not all selected items are active. Do you want to continue?",number:"Number",oddNumberOfItems:"Odd number of labels. Do you want to continue?",onlyAvailableInPurchaseView:"This is not a purchase view. This feature is only available in the purchase view",packageCode:"Package",packageQuantity:"Package Quantity",pcs:"pcs",price:"Price",priceFrom:"Price From",priceMinQuantity:"Price Min Quantity",priceNotSet:"Price not set",pricePerKg:"Price per kg",priceUntil:"Price Until",priceWithoutVat:"Price Without VAT",priceWithVat:"Price With VAT",print:"Print",printJobIsSent:"Print job is sent",quantity:"Quantity",readyForScan:"Ready for scan",resetForm:"Reset form",results:"Results",save:"Save",sayOutLoud:"Say out loud",search:"Search",searchByBarcode:"Search by Barcode",searchByName:"Search by Name",searchingFor:"Searching for",searchSuccessful:"Search successful",show:"Show",showByDate:"Show by Date",showLoginOptions:"Other ways to login",showStock:"Show Stock",simplifyForm:"Simplify Form",stock:"Stock",thisIs:"This is",toggleKeyboard:"Toggle Keyboard",tooManyItems:"Too many items",total:"Total",totalPrice:"Total Price",validFrom:"Valid From",validUntil:"Valid Until",vatRate:"VAT Rate",weight:"Weight",weightedItem:"Weighted item",weightedItemAdded:"Weighted item added",weightLabel:"Weight Label",weightModalLabelInfo:'To print small weight labels, keep on clicking "Add" until you have added all the items you want to print, close the dialog, select "half" in the list and click "Print"',yes:"Yes",zero:"zero"},lt:{normal:"Normali",half:"Pusė",fridge:"Trumpa (šaldytuvui)",barcodeOnly:"Tik brūkšninis kodas",add:"Pridėti",ago:"",addManufacturer:"Pridėti gamintoją",addPackageFee:"Pridėti fasavimo maišelį",addToList:"Pridėti į sąrašą",ageLimit:"Amžiaus limitas",alcohol:"Alkoholis",asMentioned:"Kaip minėjau",attributeName:"Atributo pavadinimas",autoLogin:"Prisijungti automatiškai",barcode:"Brūkšninis kodas",checked:"Tikrinta prieš",chooseLabelType:"Pasirinkite etiketės tipą",chooseLabelTypeDescription:"Pasirinkite etiketės tipą, kurį norite spausdinti",cleanAll:"Išvalyti",close:"Uždaryti",code:"Kodas",cost:"Savikaina",countryOfOriginName:"Kilmės šalies pavadinimas",date:"Data",defaultSaleService:"Numatytoji pardavimo paslauga",departmentNumber:"S",description:"Aprašymas",discount:"Nuolaida",discountPointsStatus:"Nuolaidų taškų statusas",discountRate:"Nuolaidos dydis",discountStatus:"Nuolaidos statusas",done:"Atlikta",enterBarcode:"Įveskite brūkšninį kodą",enterName:"Įveskite prekės pavadinimą",enterNewPrice:"Įveskite naują kainą",error:"Įvyko klaida",expiryDate:"Galiojimo data",files:"Failai",fitRaso:"Tinkamas RASO importui",freePrice:"Laisva kaina",fullBarcode:"Pilnas brūkšninis kodas",fullName:"Pilnas pavadinimas",grossWeight:"Bendras svoris",groupName:"Grupės pavadinimas",help:"Jei kyla problemų, kreiptis pas Martyną",inactiveItem:"Prekė yra neaktyvi. Ar norite tęsti?",isActive:"Aktyvus",isCommentRequired:"Komentaro reikalavimas",isQuantitative:"Kiekinė",isRefundable:"Grąžinimo galimybė",itemCatalog:"Prekių žinynas",itemAdded:"Prekė pridėta",itemCreated:"Prekė išsaugota",itemDetails:"Prekės informacija",itemNotFound:"Prekė nerasta!",itemsFound:" rasta",itemUpdated:"Prekė atnaujinta",kiloPrice:"Kilogramo kaina",labelsAndPrices:"Etiketės ir kainos",leftover:"Liko",loading:"Kraunama...",login:"Prisijungimas darbo vietoje",loginDetailsNotFound:"Prisijungimo duomenys nerasti",manufacturerName:"Gamintojo pavadinimas",markdowns:"Nukainojimai",maxDiscount:"Max nuolaida",measurementUnitCanBeWeighed:"Prekė gali būti sveriama",measurementUnitName:"Matavimo vieneto pavadinimas",minPriceWithVat:"Min kaina su PVM",minQuantity:"Min kiekis",missingBarcode:"Trūksta brūkšninio kodo",missingElements:"Trūksta UI elementų",missingName:"Trūksta pavadinimo",missingWeight:"Trūksta svorio",multipleItemsFound:"Rasta daugiau nei viena prekė!",name:"Pavadinimas",netWeight:"Neto svoris",newItem:"Nauja prekė",newPriceIs:"Nauja kaina: ",nItemsRemoved:" prekių įrašai pašalinti",nlabelsToBePrinted:" etiketės bus spausdinamos",no:"Ne",noActiveInput:"Nėra aktyvaus lauko",noData:"Nepakanka duomenų spausdinimui!",noItemsFound:"Nieko nerasta",noItemsScanned:"Nėra skenuotų prekių",noItemsSelected:"Nėra pasirinktų prekių",notAllItemsActive:"Ne visos pasirinktos prekės yra aktyvios. Ar norite tęsti?",number:"Numeris",oddNumberOfItems:"Nelyginis etikečių skaičius. Ar norite tęsti?",onlyAvailableInPurchaseView:"Tai ne pirkimo peržiūra. Ši funkcija yra prieinama tik Pirkimai, atidarius vieną iš jų",packageCode:"Pakuotė",packageQuantity:"Pakuotės kiekis",pcs:"vnt.",price:"Kaina",priceFrom:"Kaina nuo",priceMinQuantity:"Kaina min kiekis",priceNotSet:"Kaina nėra nustatyta",pricePerKg:"Kaina už 1 kg",priceUntil:"Kaina iki",priceWithoutVat:"Kaina be PVM",priceWithVat:"Kaina su PVM",print:"Spausdinti",printJobIsSent:"Spausdinimo užduotis nusiųsta",quantity:"Kiekis",readyForScan:"Pasiruošęs skenavimui",resetForm:"Atkurti formą",results:"Rezultatai",save:"Išsaugoti",sayOutLoud:"Sakyti kainas balsu",search:"Ieškoti",searchByBarcode:"Ieškoti pagal brūkšninį kodą",searchByName:"Ieškoti pagal pavadinimą",searchingFor:"Ieškoma",searchSuccessful:"Paieška sėkminga",show:"Rodyti",showByDate:"Rodyti pagal datą",showLoginOptions:"Kiti prisijungimo būdai",showStock:"Rodyti likutį",simplifyForm:"Supaprastinti formą",stock:"Likutis",thisIs:"Tai",toggleKeyboard:"Klaviatūra",tooManyItems:"Per daug prekių",total:"Bendra suma",totalPrice:"Apskaičiuota kaina",validFrom:"Galioja nuo",validUntil:"Galioja iki",vatRate:"PVM tarifas",weight:"Svoris",weightedItem:"Sveriama prekė",weightedItemAdded:"Sveriama prekė pridėta",weightLabel:"Svorio etiketė",weightModalLabelInfo:'Norėdami spausdinti mažas svorio etiketes, spauskite "Pridėti", kol pridėsite visas svorius, kuriuos norite spausdinti, uždarykite dialogą, pasirinkite tipą "pusė"  ir spauskite "Spausdinti"',yes:"Taip",zero:"nulis"}};let t=navigator.language.split("-")[0];const i=window.location.pathname;/\/(en|ru)\//.test(i)&&(t="en");const a=null!=e[t]?t:"en",n=t=>e[a][t]??e.en[t]??t;class o{notificationService;constructor(){const e=document.querySelector("[ng-app]");if(null===e)throw new Error("Angular app not found");try{const t=angular.element(e).injector();this.notificationService=t.get("Notification")}catch(e){console.error("Failed to get Notification service",e),alert("Failed to get Notification service"),this.notificationService={info:e=>alert(e),error:e=>alert(e),success:e=>alert(e),warning:e=>alert(e),primary:e=>alert(e)}}}info(e){this.notificationService.info(e)}error(e){this.notificationService.error(e)}success(e){this.notificationService.success(e)}warning(e){this.notificationService.warning(e)}primary(e){this.notificationService.primary(e)}}class s{notification=new o;interfaceInUse=!1;isLoggedIn=!1;admin=!1;user;defaultPermissions={create:!1,read:!1,update:!1,delete:!1};readPermissions={create:!1,read:!0,update:!1,delete:!1};constructor(){this.user=null,this.checkLoginStatus()}checkLoginStatus(){return null!=currentUser?.name?(this.isLoggedIn=!0,this.user=currentUser,this.admin=null!=this.user&&this.user.typeId<=3,this.admin||this.limitPermissions(),!0):(null!=currentUser&&null==currentUser.name&&(this.isLoggedIn=!1),!1)}limitPermissions(){currentCompanyUser.permissions.crudBankaisaskait={...this.defaultPermissions},currentCompanyUser.permissions.crudKlientai={...this.defaultPermissions},currentCompanyUser.permissions.crudDokSer={...this.defaultPermissions},currentCompanyUser.permissions.crudPardavim={...this.readPermissions},currentCompanyUser.permissions.crudPrekes={...this.readPermissions},currentCompanyUser.permissions["warehouse-tempFiles"].delete=!1}addContainer(){document.querySelectorAll("h5").forEach((e=>{e.remove()}));const e=document.querySelector("form"),t=`\n      <h5 class="header blue">${n("login")}</h5>\n      <div class="form-group text-center">\n      <button class="btn btn-success-2 btn-block " type="button" id="auto-login"><i class="fa fa-sign-in"></i>${n("autoLogin")}</button>\n      <button class="btn-primary btn btn-block margin-top-8" type="button" id="show-login-options">${n("showLoginOptions")}</button>\n      </div>`;return null!==e?(e.insertAdjacentHTML("beforebegin",t),e.style.display="none",!0):(console.error("Form not found!"),!1)}addLoginOptions(){if(!this.addContainer())return!1;const e=document.querySelector("#show-login-options"),t=document.querySelector("#auto-login"),i=document.querySelector("form");return null!==e&&null!==t&&null!==i&&(e.addEventListener("click",(function(){i.style.display="block",e.style.display="none"})),t.addEventListener("click",(()=>{this.autoLogin()})),!0)}async autoLogin(){const e=document.querySelector('input[name="username"]'),t=document.querySelector('input[name="password"]');if(null===e||null===t)return this.notification.error(n("loginDetailsNotFound")),!1;const i=await GM.getValue("username",""),a=await GM.getValue("password","");if(""===i||""===a)return this.notification.error(n("loginDetailsNotFound")),"x"===e.value&&"x"===t.value&&this.saveLoginDetails(),!1;e.value=i,t.value=a,e.dispatchEvent(new Event("input",{bubbles:!0})),t.dispatchEvent(new Event("input",{bubbles:!0}));const o=document.querySelector("form");if(null===o)return this.notification.error(n("error")),!1;let s=o.getAttribute("ng-submit");if(null===s)return this.notification.error("Recaptcha key not found"),!1;const r=s.match(/"([^"]+)"/);return null===r?(this.notification.error("Recaptcha key not found"),!1):(s=r[1],angular.element(o).controller().signIn(s),!0)}async saveLoginDetails(){if(window.confirm("Do you want to save these login details?")){const e=window.prompt("Enter your username"),t=window.prompt("Enter your password");null!=e&&null!=t&&(await GM.setValue("username",e),await GM.setValue("password",t),alert("Login details saved"))}if(!window.confirm("Do you want to save API key?"))return;const e=window.prompt("Enter your API key");null!==e&&(await GM.setValue("api-key",e),alert("API key saved"))}}class r{text;constructor(e){this.text=e}encode(){var e,t,i,a=3,n=[],o=[];for(e=0;e<this.text.length;e++){if(i=this.text.charCodeAt(e),2!=a){for(t=0;t+e<this.text.length&&!(this.text.charCodeAt(e+t)-48>>>0>9);t++);(t>1&&0==e||t>3&&(e+t<this.text.length||!(1&t)))&&(n.push(0==e?105:99),a=2)}if(2==a&&(i-48>>>0<10&&e+1<this.text.length&&this.text.charCodeAt(e+1)-48>>>0<10?n.push(+this.text.substr(e++,2)):a=3),2!=a){if(a>2||(127&i)<32&&a||(127&i)>95&&!a){for(t=a>2?e:e+1;t<this.text.length&&!(this.text.charCodeAt(t)-32&64);t++);t=t==this.text.length||96&this.text.charCodeAt(t)?1:0,n.push(0==e?103+t:t!=a?101-t:98),a=t}i>127&&n.push(101-a),n.push((64+(127&i))%96)}}for(0==e&&n.push(103),t=n[0],e=1;e<n.length;e++)t+=e*n[e];for(n.push(t%103),n.push(106),i=[358,310,307,76,70,38,100,98,50,292,290,274,206,110,103,230,118,115,313,302,295,370,314,439,422,406,403,434,410,409,364,355,283,140,44,35,196,52,49,324,276,273,220,199,55,236,227,59,443,327,279,372,369,375,428,419,395,436,433,397,445,289,453,152,134,88,67,22,19,200,194,104,97,26,25,265,296,477,266,61,158,94,79,242,122,121,466,458,457,367,379,475,188,143,47,244,241,468,465,239,247,431,471,322,328,334,285],a=e=0;e<n.length;e++,a++)for(o[a++]=1,t=256;t>0;t>>=1,a++)i[n[e]]&t&&(o[a]=1);return o[a++]=o[a]=1,[o]}toHtml(e,t=3,i=5){Array.isArray(t)||(t=[t||3,t||3]);let a,n,o="barcode"+t[0]+t[1],s="<style> ."+o+" div {float:left; margin:0; height:"+t[1]+"px}";i=i||5;for(var r=0;r<i;r++)for(var l=0;l<i;l++)s+="."+o+" .bar"+l+r+" {border-left:"+l*t[0]+"px solid; margin-right:"+r*t[0]+"px}";for(s+="</style><div class="+o+" style='line-height:"+t[1]+"px; display:inline-block'>",r=0;r<e.length;r++)for(l=0;l<e[r].length;){for(r&&!l&&(s+="<br style='clear:both' />"),a=0;l<e[r].length&&(e[r][l]&&a+1!=i);a++,l++);for(n=0;l<e[r].length&&(!e[r][l]&&n+1!=i);n++,l++);s+="<div class=bar"+a+n+"></div>"}return s+"</div>"}}class l{items=[];success=!1;type;constructor(e=void 0,t="normal"){this.type=t,null==e||(e instanceof Promise?e.then((e=>{this.items=e,this.print()})):(this.items=e,this.print()))}print(){this.items=this.items.filter((e=>null!=e.barcode)),(this.isAllItemsActive()||confirm(n("notAllItemsActive")))&&("half"!=this.type||this.items.length%2==0||confirm(n("oddNumberOfItems")))&&(this.items.length>0?this.printLabelsUsingBrowser(this.items):alert(n("noData")))}isAllItemsActive(){return this.items.every((e=>e.isActive))}makeUpperCaseBold(e){return e.replace(/("[^"]+"|[A-ZŽĄČĘĖĮŠŲŪ]{3,})/g,"<b>$1</b>")}pricePerUnit(e){const t=/(?:(\d+)\s*x\s*)?(\d+(\.\d+)?(?:,\d+)?)[\s]*(k?g|m?l|vnt|pak|rul)\b/i,i=e.name.match(t);if(i){if(e.name.replace(i[0],"").match(t))return null;const a=i[1]?parseInt(i[1]):1,n=parseFloat(i[2].replace(",","."))*a,o=i[4].replace(".","").toLowerCase();let s;return s="g"===o||"ml"===o?(e.priceWithVat/(n/1e3)).toFixed(2)+("ml"===o?" €/l":" €/kg"):(e.priceWithVat/n).toFixed(2)+" €/"+o,parseFloat(s)<.5||parseFloat(s)>25||parseFloat(s)===e.priceWithVat?null:s}return null}generateLabel(e,t=this.type){const i=document.createElement("div");return i.className="label",null!=e.weight?this.generateWeightLabel(e,"half"===t):("normal"!==t&&i.classList.add(t),i.appendChild(this.createDivWithClass("item",this.makeUpperCaseBold(e.name),!0)),null!=e.barcode&&"half"!==t?i.appendChild(this.createCode123Div(e)):null!=e.barcode&&i.appendChild(this.createDMDiv(e)),i.appendChild(this.createDivWithClass("price",this.getItemPrice(e))),null!=e.packageCode?i.appendChild(this.createDivWithClass("subtext","Tara +0.10")):1==e.measurementUnitCanBeWeighed&&i.appendChild(this.createDivWithClass("subtext","/ 1 "+e.measurementUnitName)),i)}getItemPrice(e){return null==e.priceWithVat||0===e.priceWithVat?"":"number"==typeof e.priceWithVat?e.priceWithVat.toFixed(2):parseFloat(e.priceWithVat).toFixed(2).toString()}createCode123Div(e){const t=document.createElement("div");t.className="barcode";const i=this.pricePerUnit(e);e.measurementUnitCanBeWeighed||null==i||t.appendChild(this.createDivWithClass("price-per-unit",i)),t.appendChild(this.createDivWithClass("barcode-text",e.barcode));const a=new r(e.barcode),n=document.createElement("p");return n.innerHTML=a.toHtml(a.encode(),"barcodeOnly"==this.type?[1,50]:[1,15]),t.appendChild(n),t}generateWeightLabel(e,t=!1){const i=document.createElement("div");if(null==e.weight||null==e.totalPrice||null==e.priceWithVat||null==e.barcode||e.barcode.length>13)return i;i.className="label weight"+(t?" half":"");const a=[{className:"item",text:e.name},{className:"price",text:t&&e.addPackageFee?(e.totalPrice+.01).toFixed(2):e.totalPrice.toFixed(2)},{className:"weight",text:(e.measurementUnitCanBeWeighed?e.weight.toFixed(3):e.weight.toString())+(t?" "+e.measurementUnitName:"")},{className:"kg-price",text:e.priceWithVat.toFixed(2)+(t?" €/kg":"")},{className:"weight-text",text:e.measurementUnitName},{className:"kg-text",text:"€/"+e.measurementUnitName}];if(e.addPackageFee&&!t&&a.push({className:"package",text:"+ 0,01 (fas. maišelis)"}),a.forEach((({className:e,text:t})=>{i.appendChild(this.createDivWithClass(e,t))})),i.appendChild(this.createDMDiv(e)),null!=e.expiryDate){const t=new Date(e.expiryDate).toLocaleDateString("lt-LT",{month:"2-digit",day:"2-digit"});i.appendChild(this.createDivWithClass("expiry",t))}return 1==e.addManufacturer&&null!=e.manufacturerName&&i.appendChild(this.createDivWithClass("manufacturer",e.manufacturerName)),i}createDivWithClass(e,t,i=!1){const a=document.createElement("div");return a.className=e,i?a.innerHTML=t:a.textContent=t,a}createDMDiv(e){const t=document.createElement("div");if(t.className="barcode dm",null==e.barcode)return t;let i=e.barcode;null!=e.weight&&(i=(1==e.addPackageFee?"1102\r\n":"")+"2200"+"0".repeat(13-e.barcode.length)+e.barcode+"0".repeat(5-e.weight.toFixed(3).length)+e.weight.toFixed(3).replace(".",""));const a="http://www.w3.org/2000/svg",n=document.createElementNS(a,"svg"),o=document.createElementNS(a,"path");return o.setAttribute("transform","scale(1)"),n.appendChild(o),o.setAttribute("d",(e=>{var t,i,a="";for(e.forEach((function(e){e.unshift(0)})),e.push([]),e.unshift([]);;){for(i=0;i+2<e.length&&!((t=e[i+1].indexOf(1)-1)>=0||(t=e[i+1].indexOf(5)-1)>=0);i++);if(i+2==e.length||a.length>1e7)return a;for(var n=e[i+1][t+1]>>2,o="",s=t,r=i,l=1;o.length<1e6;){do{t+=2*l-1}while((e[i][t+l]^e[i+1][t+l])&e[i+l][t+l]&1);l^=1&e[i+l][t+l];do{e[l?++i:i--][t+1]^=2}while((e[i+l][t]^e[i+l][t+1])&e[i+l][t+1-l]&1);if(t==s&&i==r)break;l^=1^1&e[i+l][t+1-l],n?o="V"+i+"H"+t+o:o+="H"+t+"V"+i}for(a+="M"+t+" "+i+o+(n?"V"+i:"H"+t)+"Z",l=0,i=1;i<e.length-1;i++)for(t=1;t<e[i].length;t++)l^=e[i][t]>>1&1,e[i][t]=5*l^5&e[i][t]}})(((e,t=!1)=>{var i=[],a=0,n=0;function o(e){a=40*a+e,2==n++&&(i.push(++a>>8),i.push(255&a),n=a=0)}var s,r,l,c=[function(e){return(e-48&255)<10?6:e<128?12:24},function(e){return(e-48&255)<10||(e-65&255)<26||32==e?8:e<128?16:16+c[1](127&e)},function(e){return(e-48&255)<10||(e-97&255)<26||32==e?8:e<128?16:16+c[2](127&e)},function(e){return(e-48&255)<10||(e-65&255)<26||32==e||13==e||62==e||42==e?8:1e9},function(e){return e>=32&&e<95?9:1e9},function(e){return 12}],d=[0,24,24,24,21,25],h=[0,12,12,12,12,25],u=0,m=0,p=[];for(p[e.length]=h.slice(),l=e.length;l-- >0;){for(s=1e9,r=0;r<h.length;r++)h[r]+=c[r](e.charCodeAt(l)),s=Math.min(s,12*Math.ceil(h[r]/12));for(c[0](e.charCodeAt(l))>6&&(h[0]=12*Math.ceil(h[0]/12)),r=0;r<h.length;r++)s+d[r]<h[r]&&(h[r]=s+d[r]);p[l]=h.slice()}for(l=0;;u=m){if(s=p[l][u]-d[u],l+[0,2,2,2,3,0][u]>=e.length)m=0;else for(r=c.length;r-- >0;)12*Math.ceil((p[l+1][r]+c[r](e.charCodeAt(l)))/12)==s&&(m=r);if(u!=m&&u>0)if(u<4)i.push(254);else if(4==u)i.push(31|255&a);else for(n>249&&i.push(n/250+250+149*(i.length+1)%255&255),i.push(n%250+149*(i.length+1)%255+1&255);n>0;n--)i.push(e.charCodeAt(l-n)+149*(i.length+1)%255+1&255);if(l>=e.length)break;if(u!=m&&(a=n=0),u!=m&&m>0&&i.push([230,239,238,240,231][m-1]),0==m)(r=(s=e.charCodeAt(l++))-48&255)<10&&l<e.length&&(e.charCodeAt(l)-48&255)<10?i.push(10*r+e.charCodeAt(l++)-48+130):(s>127&&i.push(235),i.push(1+(127&s))),(4==u||n<0)&&n--;else if(m<4){var g=[[31,0,32,119,47,133,57,179,64,173,90,207,95,277,127,386,255,1],[31,0,32,119,47,133,57,179,64,173,90,258,95,277,122,335,127,386,255,1],[13,55,32,119,42,167,57,179,62,243,90,207,255,3]][m-1];do{for((s=e.charCodeAt(l++))>127&&(o(1),o(30),s&=127),r=0;s>g[r];r+=2);(3&g[r+1])<3&&o(3&g[r+1]),o(s-(g[r+1]>>2))}while(n>0)}else if(4==m){for(n>0&&i.push(255&a+(63&e.charCodeAt(l++))),a=n=0;n<3;n++)a=64*(a+(63&e.charCodeAt(l++)));i.push(a>>16),i.push(a>>8&255)}else l++,n++}var b,f,y,v,k,w,x,I,S=i.length,C=1,P=1,L=-1,A=1;if((-1==n||u&&u<5)&&(m=1),t&&S-m<50){I=[16,7,28,11,24,14,32,18,32,24,44,28];do{k=(f=I[++L])*(b=6+(12&L))/8}while(k-I[++L]<S-m);f>25&&(C=2)}else{f=b=6,r=2,I=[5,7,10,12,14,18,20,24,28,36,42,48,56,68,84,112,144,192,224,272,336,408,496,620];do{if(++L==I.length)return[];f>11*r&&(r=4+r&12),k=(f=b+=r)*b>>3}while(k-I[L]<S-m);f>27&&(P=C=2*Math.floor(f/54)+2),k>255&&(A=2*(k>>9)+2)}for(k-(x=I[L])+1==S&&m>0&&(S--,-1==n&&(i[S-1]^=31^i[S]-1&63)),y=f/C,v=b/P,S<k-x&&(i[S++]=129);S<k-x;)i[S++]=(149*S%253+130)%254;x/=A;var N=new Array(70),M=new Array(70),T=new Array(256),E=new Array(255);for(L=1,r=0;r<255;r++)E[r]=L,T[L]=r,(L+=L)>255&&(L^=301);for(N[x]=0,r=1;r<=x;r++)for(N[L=x-r]=1;L<x;L++)N[L]=N[L+1]^E[(T[N[L]]+r)%255];for(s=0;s<A;s++){for(r=0;r<=x;r++)M[r]=0;for(r=s;r<S;r+=A)for(L=0,I=M[0]^i[r];L<x;L++)M[L]=M[L+1]^(I?E[(T[N[L]]+T[I])%255]:0);for(r=0;r<x;r++)i[S+s+r*A]=M[r]}var D=Array(b+2*P).fill(null).map((function(){return[]}));for(r=0;r<f+2*C;r+=y+2)for(L=0;L<b;L++)D[L+2*(L/v|0)+1][r]=1,1&~L||(D[L+2*(L/v|0)][r+y+1]=1);for(r=0;r<b+2*P;r+=v+2)for(L=0;L<f+2*C;L++)D[r+v+1][L]=1,1&L||(D[r][L]=1);for(x=2,s=0,w=4,r=0;r<k;w-=x,s+=x){if(w==b-3&&-1==s)I=[f,6-b,f,5-b,f,4-b,f,3-b,f-1,3-b,3,2,2,2,1,2];else if(w!=b+1||1!=s||7&f||6!=(7&b)){if(0==w&&s==f-2&&3&f)continue;if(w<0||s>=f||w>=b||s<0)for(w+=2+(x=-x)/2,s+=2-x/2;w<0||s>=f||w>=b||s<0;)w-=x,s+=x;if(w==b-2&&0==s&&3&f)I=[f-1,3-b,f-1,2-b,f-2,2-b,f-3,2-b,f-4,2-b,0,1,0,0,0,-1];else if(w==b-2&&0==s&&4==(7&f))I=[f-1,5-b,f-1,4-b,f-1,3-b,f-1,2-b,f-2,2-b,0,1,0,0,0,-1];else{if(!(1!=w||s!=f-1||7&f||6!=(7&b)))continue;I=[0,0,-1,0,-2,0,0,-1,-1,-1,-2,-1,-1,-2,-2,-2]}}else I=[f-2,-b,f-3,-b,f-4,-b,f-2,-1-b,f-3,-1-b,f-4,-1-b,f-2,-2,-1,-2];for(S=i[r++],L=0;S>0;L+=2,S>>=1)if(1&S){var W=s+I[L],$=w+I[L+1];W<0&&(W+=f,$+=4-(f+4&7)),$<0&&($+=b,W+=4-(b+4&7)),D[$+2*($/v|0)+1][W+2*(W/y|0)+1]=1}}for(r=f;3&r;r--)D[r][r]=1;return D})(i))),n.setAttribute("class","datamatrix"),n.setAttribute("viewBox","0 0 18 18"),t.appendChild(n),t}isItInAppMode(){return window.matchMedia("(display-mode: standalone)").matches||window.matchMedia("(display-mode: fullscreen)").matches}async printLabelsUsingBrowser(e){const t=e.map((e=>this.generateLabel(e))),i=window.open("","_blank",this.isItInAppMode()?"width=250,height=300":"width=800,height=600");null!=i?(i.document.title=`${t.length} ${n("nlabelsToBePrinted")}`,i.document.head.appendChild(this.createStyleElement()),t.forEach((e=>{i.document.body.appendChild(e)})),this.success=!0,i.addEventListener("afterprint",(()=>{i.close()})),i.print()):alert("Please allow popups for this site")}createStyleElement(){const e=document.createElement("style");return e.innerHTML="\ufeff.is_a_bug{display:none}@media print{body{margin:0;padding:0;max-width:58.3mm;display:inline-flex;flex-wrap:wrap}}.label{all:revert;position:relative;background:#fff;color:#000;height:31.75mm;width:57.15mm;border:.5px solid #ffdfd4;margin:0px;box-sizing:border-box;overflow:hidden}.item{height:19mm;overflow:hidden;padding:4px;font-family:Arial,sans-serif;font-size:initial;line-height:initial}.barcode{white-space:nowrap;position:absolute;bottom:0;z-index:3}.barcode div{font-size:10px;font-family:monospace;margin-left:6px;line-height:1em}.barcode p{margin:0}.dm{width:6mm;height:6mm;transform:rotate(270deg);padding:3px;fill:#333}.subtext{position:absolute;right:2px;bottom:3px;font-family:serif;font-size:18px;font-weight:500;z-index:10;line-height:1em}.price{position:absolute;bottom:21px;font-size:50px;right:0;overflow:hidden;object-position:center;margin-right:3px;line-height:1em;font-family:\"Book Antiqua\",serif;padding-right:10px;background:hsla(0,0%,100%,.9098039216);border-radius:5px}.price-per-unit{color:#777}.barcodeOnly .item{font-size:.9em;margin-right:15px}.barcodeOnly .barcode{left:50%;transform:translateX(-50%) scale(1.4);width:max-content}.barcodeOnly .barcode>div{margin-left:0;font-size:8px;writing-mode:vertical-lr;position:absolute;right:-1.2em;bottom:1.2em}.barcodeOnly .price,.barcodeOnly .price-per-unit,.barcodeOnly .subtext{display:none}.label.fridge::before{content:\"\";display:block;position:absolute;border-top:.5px dashed #ff9b79;width:100%;bottom:7mm}.label.fridge .item{font-size:15px;height:12mm}.label.fridge .barcode p,.label.fridge .price-per-unit{display:none}.label.fridge .subtext{font-family:\"Book Antiqua\",serif;font-size:1em;bottom:11mm;left:0;right:unset;background:#888;color:#fff;padding:0px 3px;margin-left:6px;border-radius:3px;padding-top:2px}.label.fridge .price,.label.fridge .barcode{bottom:8mm;line-height:.9em}.label.half{width:28.575mm;display:block;border-right:.5px dashed #ff9b79}.label.half .item{font-size:.75em;font-size:12px;text-align:center}.label.half .subtext{padding:0px 3px;border-radius:3px;font-size:.95em}.label.half .price{right:0;left:0;margin:0px 3px;padding:0px;text-align:center;font-size:38px}.label.half .barcode div{font-size:8px;margin:0px;padding:0px;bottom:0}.label.half .barcode p{display:none}.label.weight{display:grid;grid-template-columns:min-content 1fr;align-items:center;justify-content:space-between;padding:5px;box-sizing:border-box;writing-mode:vertical-rl;grid-column-gap:2px;grid-row-gap:0px;font-family:\"Arial\"}.label.weight .barcode{grid-column:1;position:static;width:8mm;height:8mm;transform:unset}.label.weight .item{grid-column:span 2;text-align:left;font-size:11pt;font-size:10pt;max-width:60pt;padding:0px;height:unset}.label.weight .price{all:revert;grid-row:2;grid-column:span 2;text-align:center;justify-self:center;align-self:end;font-size:16pt;font-weight:bold;line-height:1em;font-family:\"Book Antiqua\",serif;margin-right:4px}.label.weight .price::after{content:\"  €\"}.label.weight .kg-price{grid-column:2;justify-self:center;align-self:end}.label.weight .kg-text{grid-column:2}.label.weight .kg-text,.label.weight .weight-text{justify-self:center;align-self:baseline;color:#999;font-size:.8em;line-height:.6}.label.weight .weight-text{grid-column:1}.label.weight .weight{grid-column:1;justify-self:center;align-self:end}.label.weight .expiry{grid-column:2;text-align:center;justify-self:center;align-self:center;line-height:.9;font-size:.8em;color:#000}.label.weight .expiry::before{content:\"Geriausia iki \";color:#444;display:inline;font-family:Arial}.label.weight.half{display:grid;writing-mode:unset}.label.weight.half .price{font-size:18px}.label.weight.half *:not(.price){font-size:9pt}.label.weight.half .item{max-width:unset;max-height:11mm}.label.weight.half .dm{grid-row:3/span 3}.label.weight.half .weight{grid-column:2}.label.weight.half .expiry::before{content:\" \";display:inline-block;position:static;background-repeat:no-repeat;background-image:url(\"data:image/svg+xml,%3Csvg fill='%23000000' version='1.1' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='15px' height='15px' viewBox='0 0 612 612' xml:space='preserve'%3E%3Cg%3E%3Cg%3E%3Cpath d='M612,463.781c0-70.342-49.018-129.199-114.75-144.379c-10.763-2.482-21.951-3.84-33.469-3.84 c-3.218,0-6.397,0.139-9.562,0.34c-71.829,4.58-129.725,60.291-137.69,131.145c-0.617,5.494-0.966,11.073-0.966,16.734 c0,10.662,1.152,21.052,3.289,31.078C333.139,561.792,392.584,612,463.781,612C545.641,612,612,545.641,612,463.781z M463.781,561.797c-54.133,0-98.016-43.883-98.016-98.016s43.883-98.016,98.016-98.016s98.016,43.883,98.016,98.016 S517.914,561.797,463.781,561.797z'/%3E%3Cpolygon points='482.906,396.844 449.438,396.844 449.438,449.438 396.844,449.438 396.844,482.906 482.906,482.906 482.906,449.438 482.906,449.438 '/%3E%3Cpath d='M109.969,0c-9.228,0-16.734,7.507-16.734,16.734v38.25v40.641c0,9.228,7.506,16.734,16.734,16.734h14.344 c9.228,0,16.734-7.507,16.734-16.734V54.984v-38.25C141.047,7.507,133.541,0,124.312,0H109.969z'/%3E%3Cpath d='M372.938,0c-9.228,0-16.734,7.507-16.734,16.734v38.25v40.641c0,9.228,7.507,16.734,16.734,16.734h14.344 c9.228,0,16.734-7.507,16.734-16.734V54.984v-38.25C404.016,7.507,396.509,0,387.281,0H372.938z'/%3E%3Cpath d='M38.25,494.859h236.672c-2.333-11.6-3.572-23.586-3.572-35.859c0-4.021,0.177-7.999,0.435-11.953H71.719 c-15.845,0-28.688-12.843-28.688-28.688v-229.5h411.188v88.707c3.165-0.163,6.354-0.253,9.562-0.253 c11.437,0,22.61,1.109,33.469,3.141V93.234c0-21.124-17.126-38.25-38.25-38.25h-31.078v40.641c0,22.41-18.23,40.641-40.641,40.641 h-14.344c-22.41,0-40.641-18.231-40.641-40.641V54.984H164.953v40.641c0,22.41-18.231,40.641-40.641,40.641h-14.344 c-22.41,0-40.641-18.231-40.641-40.641V54.984H38.25C17.126,54.984,0,72.111,0,93.234v363.375 C0,477.733,17.126,494.859,38.25,494.859z'/%3E%3Ccircle cx='134.774' cy='260.578' r='37.954'/%3E%3Ccircle cx='248.625' cy='260.578' r='37.954'/%3E%3Ccircle cx='362.477' cy='260.578' r='37.954'/%3E%3Ccircle cx='248.625' cy='375.328' r='37.953'/%3E%3Ccircle cx='134.774' cy='375.328' r='37.953'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\");height:15px;width:15px}.label.weight.half .expiry{display:flex;align-items:center}.label.weight.half .manufacturer,.label.weight.half .weight-text,.label.weight.half .kg-text,.label.weight.half .package{display:none}.label.weight .manufacturer,.label.weight .description{font-size:.7em;grid-column:span 2}.label.weight .package{font-size:.7em;grid-column:span 2}.label.weight .package{grid-row:3;grid-column:span 2;text-align:center;justify-self:center;align-self:center;margin-right:-5px;margin-left:5px;color:#444;font-size:10px;line-height:.8em}",e}}class c{language;notifier;apiKey=null;numbers;languages={"lt-LT":{units:["","vienas","du","trys","keturi","penki","šeši","septyni","aštuoni","devyni"],teens:["dešimt","vienuolika","dvylika","trylika","keturiolika","penkiolika","šešiolika","septyniolika","aštuoniolika","devyniolika"],tens:["","","dvidešimt","trisdešimt","keturiasdešimt","penkiasdešimt","šešiasdešimt","septyniasdešimt","aštuoniasdešimt","devyniasdešimt"],hundreds:["","šimtas","du šimtai","trys šimtai","keturi šimtai","penki šimtai","šeši šimtai","septyni šimtai","aštuoni šimtai","devyni šimtai"]},"en-GB":{units:["","one","two","three","four","five","six","seven","eight","nine"],teens:["ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],tens:["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],hundreds:["","one hundred","two hundred","three hundred","four hundred","five hundred","six hundred","seven hundred","eight hundred","nine hundred"]}};constructor(e){this.language=window.navigator.language.split("-")[0],"lt"==this.language?this.language="lt-LT":this.language="en-GB",this.numbers=this.languages[this.language],this.notifier=e,this.checkApiKey()}async checkApiKey(){this.apiKey=await GM.getValue("api-key",null),null!=this.apiKey&&this.apiKey.length<20&&(this.apiKey=null,this.notifier.error(n("invalidApiKey")))}async speak(e){new Audio(await this.getAudioUrl(e)).play()}async getAudioUrl(e){if(null==this.apiKey)return;const t=await fetch(`https://texttospeech.googleapis.com/v1/text:synthesize?key=${this.apiKey}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:{text:e},voice:{languageCode:this.language,ssmlGender:"MALE"},audioConfig:{audioEncoding:"MP3"}})}),i=await t.json();if(null==i.audioContent)return void this.notifier.error({title:n("error"),message:JSON.stringify(i)});const a=i.audioContent,o=new Blob([Uint8Array.from(atob(a),(e=>e.charCodeAt(0)))],{type:"audio/mp3"});return URL.createObjectURL(o)}numberToWords(e){let t=[];if(0===e)t.push(n("zero"));else{const i=e%10,a=Math.floor(e/10)%10,n=Math.floor(e/100);n>0&&t.push(this.numbers.hundreds[n]),a>1&&t.push(this.numbers.tens[a]),1===a?t.push(this.numbers.teens[i]):t.push(this.numbers.units[i])}return t=t.filter((e=>e)),t.join(" ")}digitsToPrice(e){const t=Math.floor(e),i=Math.round(100*(e-t));let a=[];return t>0&&a.push(this.numberToWords(t)),i>0&&(0!==t&&"lt-LT"==this.language?(1===t||t%10==1&&t%100!=11?a.push("euras"):t%10==0||t%10>=10||t%100>=10&&t%100<=20?a.push("eurų"):a.push("eurai"),a.push("ir")):t>1&&"en-GB"==this.language?a.push("euros"):1===t&&"en-GB"==this.language&&a.push("euro"),a.push(this.numberToWords(i)),"en-GB"==this.language&&1===i?a.push("cent"):"en-GB"==this.language?a.push("cents"):1===i||i%10==1&&i%100!=11?a.push("centas"):i%10==0||i%10>=10||i%100>=10&&i%100<=20?a.push("centų"):a.push("centai")),a=a.filter((e=>e)),a.join(" ")}}class d{request;$uibModal;modalScope;instances=[];constructor(e){this.request=e;const t=angular.element(document.body).injector(),i=t.get("$rootScope");this.$uibModal=t.get("$uibModal"),this.modalScope=i.$new(!0),this.initializeScope()}initializeScope(){this.modalScope.title=n("markdowns"),this.modalScope.tableData=[],this.modalScope.loadData=this.loadData.bind(this),this.modalScope.showSaleItems=this.showSaleItems.bind(this),this.modalScope.noDataMessage=n("loading"),this.modalScope.closeModal=this.closeModal.bind(this)}open(){const e=this.$uibModal.open({animation:!0,template:`\n        <div class="modal-header">\n        <button type="button" class="close" ng-click="closeModal()">\n          <span>&times;</span>\n        </button>\n          <h4 class="modal-title">${n("markdowns")}</h4>\n        </div>\n        <div class="modal-body">\n          <div ng-if="tableData.length === 0" class="alert alert-info">{{ noDataMessage }}</div>\n          <table class="table table-striped table-hover">\n            <thead>\n              <tr>\n                <th>${n("number")}</th>\n                <th>${n("date")}</th>\n                <th>${n("discount")}</th>\n                <th></th>\n              </tr>\n            </thead>\n            <tbody>\n              <tr ng-repeat="row in tableData">\n                <td>{{row.series}} {{row.number}}</td>\n                <td>{{row.saleDate}}</td>\n                <td>{{row.discount}}</td>\n                <td>\n                  <button class="btn btn-xs btn-block btn-primary" ng-click="showSaleItems(row.id, row.saleDate)">\n                    ${n("show")}\n                  </button>\n                </td>\n              </tr>\n            </tbody>\n          </table>\n        </div>\n      `,scope:this.modalScope,size:"lg"});this.instances.push(e),0===this.modalScope.tableData.length&&this.loadData()}async loadData(){const e=await this.request.getSales("nur");e?this.modalScope.tableData=e.data.map((e=>({id:e.id,series:e.series,number:e.number,saleDate:e.saleDate,discount:e.discount}))):(this.modalScope.tableData=[],this.modalScope.noDataMessage=n("noDataFound")),this.modalScope.$apply()}async showSaleItems(e,t){const i=await this.request.getSaleItems(e),a=this.$uibModal.open({animation:!0,template:`\n        <div class="modal-header">\n        <button type="button" class="close" ng-click="closeModal()">\n          <span>&times;</span>\n        </button>\n          <h4 class="modal-title">${n("markdowns")} <span class="text-primary">${t}</span></h4>\n        </div>\n        <div class="modal-body">\n          <table class="table table-striped table-hover">\n            <thead>\n              <tr>\n                <th>ID</th>\n                <th>${n("name")}</th>\n                <th>${n("quantity")}</th>\n                <th>${n("total")}</th>\n                <th>${n("discount")}</th>\n                <th>${n("discountRate")}</th>\n              </tr>\n            </thead>\n            <tbody>\n              <tr ng-repeat="item in saleItems">\n                <td>{{item.itemId}}</td>\n                <td>{{item.virtualName}}</td>\n                <td>{{item.quantity}} {{item.virtualUnit.measurementUnitName}}</td>\n                <td>{{item.total.toFixed(2)}}</td>\n                <td>{{item.discount}}</td>\n                <td>{{item.discountRate}}%</td>\n              </tr>\n            </tbody>\n          </table>\n        </div>\n        <div class="modal-footer">\n          <button class="btn btn-primary" ng-click="closeModal()">${n("close")}</button>\n        </div>\n      `,scope:this.modalScope,size:"lg"});this.modalScope.saleItems=i?.data.map((e=>({itemId:e.itemId,virtualName:e.virtualName,quantity:e.quantity,total:e.sumWithoutVat+e.vat,discount:e.discount,discountRate:e.discountRate,virtualUnit:e.virtualUnit})))||[],this.modalScope.saleItems=this.modalScope.saleItems.filter((e=>e.discount<0)),this.instances.push(a)}closeModal(){this.instances.length>0&&this.instances.pop().close()}}function h(e){return` <div class="modal-header"> <button type="button" class="close" ng-click="close()" aria-label="Close"> <span aria-hidden="true">&times;</span> </button> <h4 class="modal-title" id="weightLabelModalLabel">${e("weightLabel")}</h4> </div> <div class="modal-body {{ item.weight > 9999 ? 'background-white-red' : '' }}"> <div class="form"> <div class="form-group"> <label for="productName">${e("name")}</label> <input type="text" class="form-control" ng-model="item.name" readonly> </div> <div class="row"> <div class="form-group col-sm-4"> <label for="productWeight" >${e("weight")} (g)</label> <input type="text" class="form-control" ng-model="item.weight" ng-keyup="handleWeightChange(item.weight)" ng-keydown="hideVirtualKeyboard()"> </div> <div class="form-group col-sm-4"> <label for="totalPrice">${e("totalPrice")} (EUR)</label> <input type="number" step="0.01" class="form-control" readonly ng-model="item.totalPrice" > </div> <div class="form-group col-sm-4"> <label for="kgPrice">${e("pricePerKg")} (EUR)</label> <input type="number" step="0.01" class="form-control" readonly ng-model="item.priceWithVat"> </div> </div> <div class="row"> <div class="col-sm-6"> <div class="form-group"> <label for="expiryDate">${e("expiryDate")}</label> <input type="date" class="form-control" ng-model="item.expiryDate" ng-click="picker($event)"> </div> <div class="form-group"> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" ng-model="item.addManufacturer"> <span class="lbl display-inline">&nbsp;${e("addManufacturer")}&nbsp; {{ item.manufacturerName }}</span> </label> </div> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" ng-model="item.addPackageFee" checked> <span class="lbl display-inline">&nbsp;${e("addPackageFee")}</span> </label> </div> </div> <div class="alert-xs alert-info" > <i class="fa fa-info-circle"></i>&nbsp;${e("weightModalLabelInfo")} </div> </div> <div class="col-sm-6" ng-show="virtualKeyboardVisible"> <div class="keyboard"> <button class="key btn" ng-click="key('1')">1</button> <button class="key btn" ng-click="key('2')">2</button> <button class="key btn" ng-click="key('3')">3</button> <button class="key btn" ng-click="key('4')">4</button> <button class="key btn" ng-click="key('5')">5</button> <button class="key btn" ng-click="key('6')">6</button> <button class="key btn" ng-click="key('7')">7</button> <button class="key btn" ng-click="key('8')">8</button> <button class="key btn" ng-click="key('9')">9</button> <button class="key btn" ng-click="key('0')">0</button> <button class="key btn btn-grey" ng-click="key('c')">C</button> <button class="key btn btn-danger backspace" ng-click="key('d')">⌫</button> </div> </div> </div> </div> </div> <div class="modal-footer"> <button type="button" class="btn btn-secondary" ng-click="close()"> <i class="fa fa-times"></i>&nbsp;${e("close")}</button> <button type="button" class="btn btn-primary" ng-click="add()" > <i class="fa fa-plus"></i>&nbsp;${e("add")}</button> <button type="button" class="btn btn-purple" ng-click="print()" "> <i class="fa fa-print"></i>&nbsp;${e("print")}&nbsp;[${e("normal")}]</button> </div>`}class u{notifier;interface;$uibModal;modalScope;constructor(e,t){this.notifier=e,this.interface=t;const i=angular.element(document.body).injector(),a=i.get("$rootScope");this.$uibModal=i.get("$uibModal"),this.modalScope=Object.assign(a.$new(!0),{item:null,weight:"",virtualKeyboardVisible:!0,hideVirtualKeyboard:this.hideVirtualKeyboard.bind(this),handleWeightChange:this.handleWeightChange.bind(this),key:this.key.bind(this),add:this.add.bind(this),print:this.print.bind(this),picker:this.showPicker.bind(this)})}hideVirtualKeyboard(){this.modalScope.virtualKeyboardVisible=!1}key(e){"d"===e?this.modalScope.item.weight=this.modalScope.item.weight.slice(0,-1):"c"===e?this.modalScope.item.weight="":this.modalScope.item.weight+=e,this.modalScope.handleWeightChange()}openWeightModal(e){if(!e||!e.name||!e.priceWithVat)return void this.notifier.error(n("noData"));this.setupModalItem(e);const t=this.$uibModal.open({template:h(n),scope:this.modalScope,windowClass:"weight-label-modal"});this.modalScope.close=()=>{t.close()}}setupModalItem(e){this.modalScope.item={...e,weight:"",addManufacturer:!1,addPackageFee:!0},this.modalScope.packageWeight=0}getWeightItem(){const e={...this.modalScope.item};return e&&e.weight&&!isNaN(e.weight)?(e.weight=this.gToKg(parseFloat(e.weight)),e.weight>9.999?(this.notifier.error(n("maxWeight")),null):(e.addManufacturer=!!e.addManufacturer&&!!e.manufacturerName?.length,e)):(this.notifier.error(n("missingWeight")),null)}add(){const e=this.getWeightItem();e&&this.interface.proccessItem(e,!0)}print(){const e=this.getWeightItem();e&&(this.notifier.success({title:n("printJobIsSent"),message:`${e.weight}${e.measurementUnitName}`}),new l([e]))}handleWeightChange(){this.modalScope.item&&(this.modalScope.item.totalPrice=this.interface.calculateTotalPrice(this.modalScope.item.priceWithVat,this.gToKg(this.modalScope.item.weight)))}gToKg(e){return e/1e3}showPicker(e){const t=e.target;t?.showPicker&&t.showPicker()}}class m{items={};baseUrl="https://www.b1.lt";path="/reference-book/items/search";csrfToken;headers;notifier;constructor(e){const t=document.querySelector('meta[name="csrf-token"]');this.csrfToken=null!=t?t.content:"",this.notifier=e,this.headers={accept:"application/json, text/plain, */*","accept-language":"en-GB,en;q=0.9,lt-LT;q=0.8,lt;q=0.7,en-US;q=0.6","content-type":"application/json;charset=UTF-8",origin:this.baseUrl,referer:this.baseUrl,"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-origin","x-requested-with":"XMLHttpRequest","x-csrf-token":this.csrfToken,cookie:""}}async fetchData(e,t,i){if(""===this.csrfToken)return console.error("CSRF token is missing"),void this.notifier.error("CSRF token is missing");const a=t.split("/");a.pop(),this.headers.referer=`${this.baseUrl}${a.join("/")}`,this.getCookies();try{const a=await fetch(`${this.baseUrl}${t}`,{method:e,headers:this.headers,body:JSON.stringify(i)});if(a.ok){return await a.json()}console.error("Request failed with status:",a.status),this.notifier.error({title:n("error"),message:a.statusText})}catch(e){console.error("Error:",e),this.notifier.error("Error: "+e)}}getCookies(){document.cookie.split(";").map((e=>e.trim())).forEach((e=>{const[t,i]=e.split("=");["YII_CSRF_TOKEN","b1-device_id","b1-session_id","b1-use-cookies","b1-wss_srv","b1-ref_url","cf_clearance","_ga"].includes(t.trim())&&(this.headers.cookie=this.headers.cookie.length>0?`${this.headers.cookie}; ${t}=${i}`:`${t}=${i}`)}))}isItDigits(e){return/^\d+$/.test(e)}async getItem(e){if(!this.isItDigits(e))return this.notifier.error("Invalid barcode"),null;if(Object.keys(this.items).includes(e)){const t=this.items[e].retrievedAt;if(null!=t&&e.length>10&&(new Date).getTime()-t.getTime()<3e4)return{...this.items[e]};if(null!=t&&e.length<10&&(new Date).getTime()-t.getTime()<6e4)return{...this.items[e]}}const t={pageSize:20,filters:{groupOp:"AND",rules:{barcode:{data:e,field:"barcode",op:"0"===e[0]?"cn":"eq"}}},allSelected:!1,asString:"",page:1},i=await this.fetchData("POST",this.path,t);return null==i||null==i.data[0]?null:(i.data[0].retrievedAt=new Date,this.items[e]=i.data[0],i.data.length>1&&this.notifier.warning({title:n("multipleItemsFound"),delay:2e4,message:n("barcode")+" "+e+" "+n("found")+" "+i.data.length+" "+n("items")}),i.data[0])}async saveItem(e,t){if(!this.isItDigits(e))return this.notifier.error(n("invalidId")),!1;const i=await this.fetchData("POST",`/reference-book/items/update?id=${e}`,t);return 200===i.code?this.notifier.success({title:n("itemUpdated"),message:n("newPriceIs")+t.priceWithVat,delay:15e3}):this.notifier.error({title:n("failedToUpdateItem"),message:i.message}),200===i.code}async createItem(e){const t=await this.fetchData("POST","/reference-book/items/create",e);return 200===t.code?(this.notifier.success(n("itemCreated")),setTimeout((()=>{this.saveItem(t.data.id,{isActive:!0})}),400)):this.notifier.error({title:n("failedToCreateItem"),message:t.message}),200===t.code}async getSales(e){const t={sort:{saleDate:"desc"},page:1,pageSize:20,allSelected:!1,asString:"",filters:{rules:{operationTypeName:{data:e,field:"operationTypeName",op:"cn"}}}};return this.fetchData("POST","/warehouse/light-sales/search",t)}getSaleItems(e){const t={page:1,pageSize:-1,filters:{rules:{lightSaleId:{field:"lightSaleId",op:"eq",data:e}}}};return this.fetchData("POST","/warehouse/light-sale-items/search",t)}clearCache(){const e=Object.keys(this.items).length;this.items={},this.notifier.info({title:n("cacheCleared"),message:e+n("nItemsRemoved")})}}class p{$uibModal;$rootScope;modalInstance=null;constructor(){const e=angular.element(document.body).injector();this.$uibModal=e.get("$uibModal"),this.$rootScope=e.get("$rootScope")}async showModal(e){const t=this.$rootScope.$new(!0);e.scopeProperties&&Object.assign(t,e.scopeProperties),this.modalInstance=this.$uibModal.open({animation:!0,template:e.template,scope:t,size:e.size||"lg",backdrop:e.backdrop||"static"}),t.closeModal=()=>{this.modalInstance.close(),t.$destroy(),e.onClose?.()}}}class g{modal;lg;labeler;current;labelTypes=["normal","fridge","half","barcodeOnly"];fakeItems=[{name:"Whiskey BLACK RAM, 40%, 0,7 l",barcode:"3800032070302",measurementUnitName:"vnt.",measurementUnitCanBeWeighed:!1,priceWithVat:14.29,isActive:!0,isRefundable:!0},{name:"Cookies BARNI Milk, 30 g",barcode:"5906747318345",measurementUnitName:"vnt.",measurementUnitCanBeWeighed:!1,priceWithVat:.5,isActive:!0,isRefundable:!0},{name:"Coca-Cola, 0,5 l",barcode:"4779036770016",measurementUnitName:"vnt.",measurementUnitCanBeWeighed:!1,priceWithVat:1.99,isActive:!0,packageCode:"1100",isRefundable:!0}];constructor(e){this.modal=new p,this.lg=new l,this.labeler=e,this.current=this.labeler.settings.type}open(){this.current=this.labeler.settings.type,this.modal.showModal({template:this.lg.createStyleElement().outerHTML+'\n        <div class="modal-header">\n          <button type="button" class="close" ng-click="closeModal()">\n            <span>&times;</span>\n          </button>\n          <h4 class="modal-title">{{ i18n(\'chooseLabelType\') }}</h4>\n        </div>\n        <div class="modal-body">\n          <div class="alert-xs alert-info">{{ i18n(\'chooseLabelTypeDescription\') }}</div>\n          <div class="list-group">\n            <div class="list-group-item" \n            ng-repeat="labelType in labelTypes track by $index" \n            ng-init="labelPreviews[labelType] = getLabelPreview(labelType)" \n            ng-class="{active: current === labelType}" \n            ng-click="selectLabelType(labelType)" \n            style="cursor: pointer;">\n            <div class="list-group-item-heading">\n            <span class="glyphicon" ng-class="{\'glyphicon-check\': current === labelType, \'glyphicon-unchecked\': current !== labelType}"></span>\n               {{ i18n(labelType) }}\n               </div>\n              <div class="label-preview" ng-bind-html="labelPreviews[labelType]"></div>\n            </div>\n        </div>\n      ',scopeProperties:{labelTypes:this.labelTypes,current:this.current,fakeItems:this.fakeItems,selectLabelType:e=>{console.log(e),this.labeler.setLabelType(e),this.modal.modalInstance.close()},lg:this.lg,i18n:n,getLabelPreview:e=>this.lg.generateLabel(this.fakeItems[Math.floor(Math.random()*this.fakeItems.length)],e).outerHTML,closeModal:()=>{this.modal.modalInstance.close()}}})}}class b{notification=new o;req=new m(this.notification);textToVoice=new c(this.notification);modalService=new p;items=[];active=!1;settings={type:"normal",sayOutLoud:!0,showStock:!1};modals;loadingIndicator=null;mainInput=null;itemList=null;constructor(){this.modals={type:new g(this),weight:new u(this.notification,this),markdown:new d(this.req)}}isActive(){return this.active=null!==document.querySelector(".look-up-container"),this.active}init(){if(this.isActive())return!0;const e=document.querySelector(".main-container"),t=document.querySelector(".navbar-shortcuts"),i=document.querySelector(".footer");return null!=t&&null!=i&&null!=e&&(this.injectHtml(e),this.removeElements(i,e),this.simplifyPage(),this.cacheElements(),this.bindEvents(),!0)}simplifyPage(e=!0){return this.hideDropdownMenuItems(),this.changeDocumentTitle(),this.addNavItems(e),document.body.classList.add("labeler-interface"),!0}hideDropdownMenuItems(){document.querySelectorAll(".dropdown-menu li").forEach(((e,t)=>{t<9&&(e.style.display="none")}))}removeElements(...e){e.forEach((e=>{e.remove()}))}injectHtml(e){e.insertAdjacentHTML("beforebegin",function(e){return`<div class="container look-up-container"> <div class="row"> <div class="col-md-4 form-section"> <h4 class="header">${e("labelsAndPrices")}</h4> <div class="form-group input-group"> <input type="text" class="form-control" id="barcode" placeholder="${e("enterBarcode")}" autocomplete="off"> <div class="ready-for-scan pull-right text-success">${e("readyForScan")}</div> <button type="button" class="btn btn-info" id="searchButton">${e("code")}</button> </div> <div class="form-group"> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="sayOutLoud" checked> <span class="lbl display-inline">&nbsp;${e("sayOutLoud")}</span> </label> </div> <div class="checkbox-form"> <label> <input type="checkbox" class="ace" id="showStock"> <span class="lbl display-inline">&nbsp;${e("showStock")}</span> </label> </div> </div> <div class="clearfix margin-bottom-10"> <div class="pull-right"> \x3c!-- select for label type: normal, half, fridge, barcodeOnly --\x3e <button class="btn btn-white" id="labelType"> ${e("normal")} <i class="fa fa-caret-down"></i> </button> \x3c!-- <select class="form-control" id="labelType"> <option value="normal">${e("normal")}</option> <option value="half">${e("half")}</option> <option value="fridge">${e("fridge")}</option> <option value="barcode">${e("barcodeOnly")}</option> </select> --\x3e <button type="button" class="btn btn-purple" id="printButton"> <i class="fa fa-print"></i>&nbsp;${e("print")}</button> <button type="button" class="btn btn-danger" id="cleanAllButton">${e("cleanAll")}</button> </div> </div> </div> <div class="col-md-8 load-data"> <div class="load-overlay" style="display:none" id="loadingOverlay"> <div> <i class="fa fa-5x fa-b1-loader blue"></i> </div> </div> <div class="item-list"> <div class="alert alert-info text-center">${e("noItemsScanned")}</div> <div class="alert-xs grey text-center">${e("help")}</div> </div> </div> </div>\n</div>`}(n))}createNavItem(e,t,i){const a=document.createElement("li"),n=document.createElement("a");n.className="navbar-shortcut",n.href="#",n.addEventListener("click",t);const o=document.createElement("i");return o.className="fa fa-fw "+i,n.appendChild(o),n.appendChild(document.createTextNode(e)),a.appendChild(n),a}addNavItems(e=!0){const t=document.querySelector(".navbar-shortcuts"),i=null!=t&&null!=t.querySelector(".fa-upload");if(null==t)return;t.innerHTML="";const a=document.createElement("ul");if(t.appendChild(a),e){const e=this.createNavItem(n("markdowns"),(()=>{this.modals?.markdown.open()}),"fa-book");e.setAttribute("data-toggle","modal"),e.setAttribute("data-target","#markdownModal"),a.appendChild(e);const t=this.createNavItem(n("itemCatalog"),(()=>{this.showReferenceBookItemsModal()}),"fa-folder-open");a.appendChild(t)}else{const e=this.createNavItem(n("labelsAndPrices"),(()=>{window.location.href="/"}),"fa-arrow-left");a.appendChild(e)}const o=this.createNavItem(n("files"),(()=>{this.showTempFileListModal()}),"fa-files-o");a.appendChild(o);const s=document.querySelectorAll(".nav-user-dropdown__title");null==s||i||s.forEach((e=>{const t=document.createElement("i");t.className="fa fa-fw fa-power-off",e.appendChild(t);e.querySelector(".nav-user-company").style.display="none"}))}async showReferenceBookItemsModal(){await this.modalService.showModal({template:'\n        <div class="modal-body">\n          <div ng-controller="ReferenceBookItems as c" class="row">\n            <div class="col-xs-12">\n              <div class="margin-bottom-5 row sticky row-no-gutters">\n                <button ng-show="!c.grid.config.isLoading" \n                        ng-disabled="selected(c.grid) == 0" \n                        type="button" \n                        class="btn btn-sm btn-purple" \n                        ng-click="print(c.grid.provider.getSelected())">\n                  <i class="fa fa-fw fa-print"></i> '+n("print")+'\n                </button>\n                <button ng-show="!c.grid.config.isLoading" \n                        ng-disabled="!isWeighted(c.grid)" \n                        type="button" \n                        class="btn btn-sm btn-pink" \n                        ng-click="weightLabel(c.grid.provider.getSelected())">\n                  <i class="fa fa-fw fa-balance-scale"></i> '+n("weightLabel")+'\n                </button>\n                <button ng-show="!c.grid.config.isLoading" \n                        ng-disabled="selected(c.grid) == 0" \n                        type="button" \n                        class="btn btn-sm btn-primary" \n                        ng-click="proccessItem(c.grid.provider.getSelected())">\n                  <i class="fa fa-fw fa-plus"></i> '+n("add")+'\n                </button>\n                <button class="btn btn-sm pull-right" ng-click="closeModal()">\n                  <i class="fa fa-fw fa-times"></i> '+n("close")+'\n                </button>\n              </div>\n              <extd-grid\n                config="c.grid.config"\n                filter="c.grid.filter"\n                data="c.grid.data">\n              </extd-grid>\n            </div>\n          </div>\n        </div>',scopeProperties:{weightLabel:e=>{e&&1===e.length&&e[0].measurementUnitCanBeWeighed?this.modals?.weight.openWeightModal(e[0]):this.notification.error(n("weightedItem")+"?")},print:e=>this.print(e),selected:e=>e.provider.getSelected().length,isWeighted:e=>{const t=e.provider.getSelected();return 1===t.length&&t[0].measurementUnitCanBeWeighed},proccessItem:e=>{e.forEach((e=>{this.proccessItem(e,!0)}))}},size:"ext"}),await new Promise((e=>setTimeout(e,2e3)));const e=document.querySelector(".data-rows");if(!e)return!1;const t=angular.element(e).controller().grid;t.config.hideTopPager=!0,t.filter.addRule("isActive",1),t.filter.sort={id:"desc"},t.reload()}setLabelType(e){this.settings.type=e;const t=document.getElementById("labelType");t&&(t.textContent=n(e))}async showTempFileListModal(){await this.modalService.showModal({template:'\n        <div class="modal-body">\n          <temp-file-list type-id="{{typeId}}" open-for-select="openForSelect"></temp-file-list>\n        </div>\n        <div class="modal-footer">\n          <button class="btn" ng-click="closeModal()">\n            <i class="fa fa-times"></i> '+n("close")+"\n          </button>\n        </div>",scopeProperties:{typeId:null,openForSelect:!1}})}bindEvents(){document.getElementById("labelType")?.addEventListener("click",(()=>{this.modals?.type.open()})),document.getElementById("cleanAllButton")?.addEventListener("click",(()=>{this.cleanAll()})),document.getElementById("printButton")?.addEventListener("click",(()=>{this.print()})),null!=this.mainInput&&(this.mainInput.addEventListener("keypress",this.handleEnterPress(this.searchByBarcode.bind(this,this.mainInput))),document.getElementById("searchButton")?.addEventListener("click",this.searchByBarcode.bind(this,this.mainInput)),this.mainInput.focus(),document.addEventListener("click",(e=>{let t=!1;document.querySelectorAll(".modal.in").forEach((i=>{i.contains(e.target)&&(t=!0)})),t||null==this.mainInput||this.mainInput.focus()}))),this.bindCheckboxChange("sayOutLoud","sayOutLoud"),this.bindCheckboxChange("showStock","showStock")}handleEnterPress(e){return t=>{"Enter"==t.key&&e()}}bindCheckboxChange(e,t){document.getElementById(e)?.addEventListener("change",(e=>{e.target instanceof HTMLInputElement&&(this.settings[t]=e.target.checked)}))}cacheElements(){this.itemList=document.querySelector(".item-list"),this.mainInput=document.getElementById("barcode"),this.loadingIndicator=document.getElementById("loadingOverlay")}showLoading(){null!=this.loadingIndicator&&(this.loadingIndicator.style.display="flex")}hideLoading(){null!=this.loadingIndicator&&(this.loadingIndicator.style.display="none")}print(e=this.items.filter((e=>e))){if(0===e.length)return void this.notification.error(n("noData"));new l(e,this.settings.type).success&&this.cleanAll(!0)}cleanAll(e=!1){this.items=[],null!=this.itemList?this.itemList.innerHTML=e?`<div class="alert alert-success text-center">${n("printJobIsSent")}. ${n("noItemsScanned")}</div>`:`<div class="alert alert-info text-center">${n("noItemsScanned")}</div>`:console.error("itemList is not defined")}createItemElement(e){const t=document.createElement("div");t.className="item",t.id=e.id??"",t.innerHTML=this.getItemHtml(e,!0),null==e.barcode||0==e.isActive?t.classList.add("inactive"):null!=e.weight&&t.classList.add("mark");const i=this.createItemButton("btn-yellow","fa-trash",(()=>{this.removeItem(t,e.id)}));if(t.appendChild(i),e.measurementUnitCanBeWeighed&&e.priceWithVat>0){const i=this.createItemButton("btn-pink","fa-balance-scale",(()=>{this.modals?.weight.openWeightModal(e)}));t.appendChild(i)}if(e.priceWithVat>0)t.querySelector(".item-price")?.addEventListener("click",(()=>{this.showDetails(e)}));else if(null!=e.id){const i=this.createItemButton("btn-danger","fa-euro",(()=>{this.quickPriceChange(e)}));t.appendChild(i)}return t}getItemHtml(e,t){return`\n      <div class="item-main">\n        ${(e.priceWithVat>0?`<span class="item-price">${(e.totalPrice??e.priceWithVat).toFixed(2)}</span>`:"")+(this.settings.showStock?`<span class="item-stock text-primary"><i class="fa fa-home margin-right-5"></i>${e.stock||"0"}</span>`:"")}\n        <span class="item-name">${e.name}</span>\n      </div>`+(t?`<div class="item-labels">${this.getItemLabelsHtml(e)}</div>`:"")}getItemLabelsHtml(e){const t=this.getSeconds(e.retrievedAt??new Date);return["packageCode","weight","departmentNumber","packageQuantity"].map((t=>null!=e[t]?`<span>${n(t)}: ${e[t]}</span>`:"")).join("")+(null!=e.weight&&null!=e.priceWithVat?`<span>${n("kiloPrice")}: <b>${e.priceWithVat.toFixed(2)}</b></span>`:"")+(e.measurementUnitCanBeWeighed?`<span>${n("weightedItem")}</span>`:"")+`<span class="text-primary">${this.getAgoText(t)}</span>`}getSeconds(e){if(null==e)return 0;return Math.floor(((new Date).getTime()-new Date(e).getTime())/1e3)}getAgoText(e){return 0===e?"":n("checked")+" "+e+" s "+n("ago")}createItemButton(e,t,i){const a=document.createElement("button");a.addEventListener("click",i),a.className="btn btn-sm "+e,a.type="button";const n=document.createElement("i");return n.className="fa "+t,a.appendChild(n),a}removeItem(e,t){e.remove(),this.items=this.items.filter((e=>e.id!==t))}showDetails(e){const t=Object.fromEntries(Object.entries(e).filter((([e,t])=>null!==t&&!e.toString().toLowerCase().includes("id")&&!e.toString().toLowerCase().includes("account")))),i=Object.entries(t).map((([e,t])=>`\n        <div class="row col-xs-12">\n          <div class="col-sm-5" >${n(e)}:</div>\n          <div class="col-sm-7" ${e.includes("price")?'ng-click="change(item)"':""}>${t}</div>\n        </div>\n      `)).join(""),a=`\n      <div class="modal-header">\n        <h5 class="modal-title inline">${n("itemDetails")}</h5>\n        <button type="button" class="close" aria-label="Close" ng-click="closeModal()">\n          <span aria-hidden="true">&times;</span>\n        </button>\n      </div>\n      <div class="modal-body">\n        <div class="container width-auto">${i}</div>\n      </div>\n      <div class="modal-footer">\n        <button type="button" class="btn btn-sm" ng-click="closeModal()"\n        >${n("close")}</button>\n      </div>\n    `;this.modalService.showModal({template:a,scopeProperties:{item:e,change:e=>{this.quickPriceChange(e)}}})}async quickPriceChange(e){const t=prompt(n("enterNewPrice"),(e.priceWithVat??0).toString());if(null==t||null==e.id)return void this.notification.info(n("error"));const i=new Object;i.id=e.id.split("-")[0],i.isActive=!0,i.priceWithVat=parseFloat(t.replace(",",".")),i.priceWithVat<=0?this.notification.error(n("missingPrice")):(i.priceWithoutVat=i.priceWithVat/1.21,i.priceWithoutVat=Math.round(1e4*(i.priceWithoutVat+Number.EPSILON))/1e4,e.priceWithVat=i.priceWithVat,e.priceWithoutVat=i.priceWithoutVat,await this.req.saveItem(i.id,i),this.cleanAll())}addItemToView(e){const t=this.createItemElement(e);null!=this.itemList?(this.itemList.appendChild(t),t.scrollIntoView({behavior:"smooth",block:"end"})):this.notification.error(n("missingElements"))}proccessItem(e,t=!1){e.id=this.generateItemId(e.id),t?this.notification.success({title:n("itemAdded"),message:e.name,delay:2e3}):this.settings.sayOutLoud&&(this.settings.showStock&&this.settings.sayOutLoud&&null!=e.stock?(this.textToVoice.speak(e.stock.toString()),console.info("\t"+e.barcode+"\t"+e.stock)):this.items.length>0&&e.priceWithVat>0&&this.items[this.items.length-1].barcode==e.barcode&&e.weight==this.items[this.items.length-1].weight?this.textToVoice.speak(n("asMentioned")+", "+n("price")+" "+this.textToVoice.digitsToPrice(e.totalPrice??e.priceWithVat)+(void 0!==e.weight?". "+n("weight")+this.textToVoice.numberToWords(e.weight)+e.measurementUnitName:"")+" "+n("thisIs")+" "+e.name):e.priceWithVat>0?this.textToVoice.speak(n("price")+" "+this.textToVoice.digitsToPrice(e.totalPrice??e.priceWithVat)):this.textToVoice.speak(n("priceNotSet"))),0===this.items.length&&null!=this.itemList&&(this.itemList.innerHTML=""),this.items.push(e),this.addItemToView(e)}canItBePackaged(e){const t=parseInt(e.slice(0,2),10);return(13===e.toString().length||21===e.toString().length)&&t>20&&t<30}searchByBarcode(e){const t=function(e){return e.replace(/ą/g,"1").replace(/č/g,"2").replace(/ę/g,"3").replace(/ė/g,"4").replace(/į/g,"5").replace(/š/g,"6").replace(/ų/g,"7").replace(/ū/g,"8").replace(/ž/g,"9")}(e.value);e.value="",e.focus(),0!=t.length?this.canItBePackaged(t)?this.searchforAPackagedItem(t):this.searchItem(t):this.notification.error(n("missingBarcode"))}async searchforAPackagedItem(e){let t=null,i=e;13===e.length&&"23"===e.slice(0,2)||"24"===e.slice(0,2)?i=e.slice(0,8):13===e.length&&"25"===e.slice(0,2)||"29"===e.slice(0,2)?i=e.slice(0,7):21===e.length&&(i=e.slice(4,17)),t=await this.req.getItem(i),this.hideLoading(),null!=t?(t.weight=parseInt(e.length>13?e.slice(17,21):e.slice(8,12),10)/1e3,t.totalPrice=this.calculateTotalPrice(t.priceWithVat,t.weight),this.proccessItem(t)):this.notFound(e)}async searchItem(e){this.showLoading();const t=await this.req.getItem(e);this.hideLoading(),null!=t?this.proccessItem(t):this.notFound(e)}notFound(e){const t=new Object;t.name=n("itemNotFound")+" ("+n("barcode")+": "+e+")",t.barcode=e,t.isActive=!1,this.addItemToView(t)}calculateTotalPrice(e,t){if(null==e||null==t)return 0;const i=e*t;return Math.round(100*(i+Number.EPSILON))/100}addActivateButton(){const e=document.querySelector(".breadcrumbs");if(null!=e){const t=document.createElement("button");t.textContent=n("labelsAndPrices"),t.className="btn btn-sm",t.addEventListener("click",this.init.bind(this)),e.appendChild(t)}return null!=e}generateItemId(e){return e+"-"+Math.random().toString(36).substring(7)}changeDocumentTitle(){document.title=n("labelsAndPrices")}}class f{wereButtonsAdded=!1;pageReady=!1;notification=new o;user=new s;interface=new b;currentUrl;constructor(){this.currentUrl=window.location.pathname,this.init(),this.handleUrlChange(null,this.currentUrl),console.debug("LabelsUserscript initialized")}init(){this.overrideHistoryMethods(),this.setupPopStateListener(),this.addStyles()}overrideHistoryMethods(){const e=history.pushState;history.pushState=(t,i,a)=>{const n=this.currentUrl,o=e.apply(history,[t,i,a]);return this.currentUrl=window.location.pathname,this.handleUrlChange(n,this.currentUrl),o};const t=history.replaceState;history.replaceState=(e,i,a)=>{const n=this.currentUrl,o=t.apply(history,[e,i,a]);return this.currentUrl=window.location.pathname,this.handleUrlChange(n,this.currentUrl),o}}setupPopStateListener(){window.addEventListener("popstate",(()=>{const e=this.currentUrl;this.currentUrl=window.location.pathname,this.handleUrlChange(e,this.currentUrl)}))}async handleUrlChange(e,t,i=0){if(console.info("Url has changed"),this.pageReady=!1,this.user.isLoggedIn&&this.user.admin&&!this.interface.isActive()){!this.wereButtonsAdded&&this.interface.addActivateButton()&&(this.wereButtonsAdded=!0),new Promise((e=>setTimeout(e,200)));let e=!1;switch(this.currentUrl){case"/en/reference-book/items":case"/en/warehouse/purchases/edit":case"/reference-book/items":case"/warehouse/purchases/edit":e=await this.addPrintButton(),e&&setTimeout((()=>{null==document.querySelector(".print")&&this.addPrintButton()}),1e3);break;case"/en/reference-book/items/edit":case"/reference-book/items/edit":e=await this.addPrintButton(".btn-ctrl",!0);break;default:e=!0}e&&(this.pageReady=!0)}else if(!this.user.isLoggedIn||this.user.admin||this.interface.isActive())this.user.isLoggedIn||"/login"!==this.currentUrl?this.pageReady=!0:this.pageReady=this.user.addLoginOptions();else switch(this.currentUrl){case"/en/warehouse/light-sales/edit":case"/warehouse/light-sales/edit":this.pageReady=this.interface.simplifyPage(!1);break;case"/en/reference-book/items":case"/en/warehouse/purchases/edit":case"/reference-book/items":case"/en/reference-book/items/edit":case"/reference-book/items/edit":this.pageReady=this.interface.simplifyPage(!1)&&await this.addPrintButton(".buttons-left",!0);break;default:this.pageReady=this.interface.init()}!this.pageReady&&i<5&&setTimeout((()=>{this.handleUrlChange(null,this.currentUrl,i+1)}),600)}getDataRows(){const e=document.querySelector(".data-rows");if(null==e)throw this.notification.error(n("error")),new Error("Data rows not found");return e}extractDataFromAngularItemList(){const e=this.getDataRows();return angular.element(e).controller().grid.data.filter((e=>e._select))}async extractDataFromAngularPurchaseView(){const e=this.getDataRows(),t=angular.element(e).controller().data.filter((e=>e._select)),i=[];return t.forEach((e=>{i.push({name:e.itemName,barcode:e.itemBarcode,code:e.itemCode,id:e.itemId,priceWithVat:e.itemPriceWithVat,priceWithoutVat:e.itemPriceWithoutVat,measurementUnitName:e.measurementUnitName,isActive:!0})})),i}extractDataFromAngularItemView(){const e=document.querySelector("ng-form");if(null==e)return this.notification.error(n("error")),[];return[angular.element(e).controller().model]}async getViewItems(){let e=[];switch(window.location.pathname){case"/en/reference-book/items":case"/reference-book/items":e=this.extractDataFromAngularItemList();break;case"/en/warehouse/purchases/edit":case"/warehouse/purchases/edit":e=await this.extractDataFromAngularPurchaseView();break;case"/en/reference-book/items/edit":case"/reference-book/items/edit":e=this.extractDataFromAngularItemView()}return e}async addPrintButton(e=".buttons-left",t=!1){const i=document.querySelector(e);if(null==i)return!1;const a=document.querySelector("i.fa-cloud-upload");if(null!=a){const e=a.parentElement?.parentElement;null!=e&&e.remove()}let o=document.createElement("div");o.className="print";let s=document.createElement("button");s.title=n("print"),s.type="button",s.className="btn btn-sm btn-purple";let r=document.createElement("i");if(r.className="fa fa-fw fa-print",s.appendChild(r),t){const e=document.createElement("span");e.className="margin-left-5",e.textContent=n("print"),s.appendChild(e)}if(s.addEventListener("click",(()=>{this.printLabels()})),o.appendChild(s),i.appendChild(o),s=document.createElement("button"),s.title=n("weightLabel"),s.type="button",s.className="btn btn-sm btn-pink",r=document.createElement("i"),r.className="fa fa-fw fa-balance-scale",s.appendChild(r),t){const e=document.createElement("span");e.className="margin-left-5",e.textContent=n("weightLabel"),s.appendChild(e)}return s.addEventListener("click",(()=>{this.goToWeightLabelModal()})),o=document.createElement("div"),o.appendChild(s),i.appendChild(o),!0}async goToWeightLabelModal(){const e=await this.getViewItems();this.interface.modals?.weight.openWeightModal(e[0])}async printLabels(){const e=await this.getViewItems();e.length<1?this.notification.error(n("noItemsSelected")):new l(e)}addStyles(){const e=document.createElement("style");e.innerHTML='body.labeler-interface{background-color:#eee}body.labeler-interface tr.sub-grid-row,body.labeler-interface td.sub-grid,body.labeler-interface [ng-if="config.subGrid"],body.labeler-interface [ng-if="!config.hideTopPager"],body.labeler-interface .sidebar{display:none !important;pointer-events:none}body.labeler-interface .input-group{display:flex}body.labeler-interface .modal h5.header.blue.header-temp-files-list{margin-top:0}body.labeler-interface .modal .btn,body.labeler-interface .modal select,body.labeler-interface .modal input[type=text]{border-radius:4px !important}body.labeler-interface .main-content *{border-radius:4px !important}body.labeler-interface .main-content table.table.table-bordered *{border-radius:unset !important}body.labeler-interface .main-content .btn-ctrl:has(.fa-print) button.btn.btn-sm:has(.fa-print),body.labeler-interface .main-content span.resizer,body.labeler-interface .main-content .extd-grid-control select{pointer-events:none;opacity:.3}body.labeler-interface .main-content .breadcrumbs,body.labeler-interface .main-content .no-border,body.labeler-interface .main-content .form-group:has(.fa-star),body.labeler-interface .main-content .table-responsive thead tr>:nth-child(4),body.labeler-interface .main-content .table-responsive thead tr>:nth-child(6),body.labeler-interface .main-content .table-responsive thead tr>:nth-child(7),body.labeler-interface .main-content .table-responsive tbody tr>:nth-child(4),body.labeler-interface .main-content .table-responsive tbody tr>:nth-child(6),body.labeler-interface .main-content .table-responsive tbody tr>:nth-child(7),body.labeler-interface .main-content .uib-typeahead-match .tt-suggestion>:nth-child(2),body.labeler-interface .main-content .uib-typeahead-match .tt-suggestion>:nth-child(3),body.labeler-interface .main-content .uib-typeahead-match .tt-suggestion>:nth-child(4),body.labeler-interface .main-content .uib-typeahead-match .tt-suggestion>:nth-child(5),body.labeler-interface .main-content .form-horizontal:nth-child(3)>:nth-child(2)>:nth-child(2),body.labeler-interface .main-content .form-horizontal:nth-child(3)>:nth-child(2)>:nth-child(3),body.labeler-interface .main-content .form-horizontal:nth-child(3)>:nth-child(5),body.labeler-interface .main-content .form-horizontal:nth-child(1)>:nth-child(2)>:nth-child(1)>:nth-child(2)>:nth-child(2),body.labeler-interface .main-content .form-horizontal:nth-child(1)>:nth-child(2)>:nth-child(3)>:nth-child(2)>:nth-child(2),body.labeler-interface .main-content .extd-grid-control .extd-grid-buttons.buttons-right,body.labeler-interface .main-content .extd-grid-title,body.labeler-interface .main-content td[ng-if="config.subGrid"]{display:none !important;pointer-events:none}body.labeler-interface .main-content td[extd-touch-resize],body.labeler-interface .main-content a{-webkit-user-drag:none;user-drag:none}body.labeler-interface .main-content .input-group-addon,body.labeler-interface .main-content .input-group-btn{display:table-column}body.labeler-interface .main-content .sticky{background:rgba(0,0,0,0)}body.labeler-interface .main-content .sticky .btn-ctrl>div{border:unset;padding:unset}body.labeler-interface .main-content input[ng-model="filter.page"]{width:30px}body.labeler-interface .main-content .pagination-wrap button.btn.btn-sm.btn-transparent{background:#fff !important}body.labeler-interface.dark,body.labeler-interface.dark .navbar{background-color:#000}body.labeler-interface .navbar{background-color:var(--theme-blue--dark-bg)}body.labeler-interface .navbar .navbar-header .navbar-brand{padding-left:1em;filter:brightness(0) invert(1)}body.labeler-interface .navbar .navbar-header .navbar-toggle{display:none}body.labeler-interface .navbar a.navbar-shortcut{color:#eee}body.labeler-interface .navbar a.navbar-shortcut i{font-size:1.2em;margin:0 2px;text-align:center}body.labeler-interface .navbar li:has(.navbar-shortcut):hover{background:rgba(0,0,0,.3607843137)}body.labeler-interface .navbar .navbar-nav>*:not(:last-child){display:none}body.labeler-interface .navbar .navbar-nav>*:nth-last-child(2),body.labeler-interface .navbar .navbar-nav>*:nth-last-child(4),body.labeler-interface .navbar .navbar-nav>*:nth-last-child(5),body.labeler-interface .navbar .navbar-nav>*:nth-last-child(7){display:block}body.labeler-interface .navbar .navbar-collapse-2 img,body.labeler-interface .navbar .navbar-collapse-2 .divider{display:none}body.labeler-interface .navbar .navbar-collapse-2 .nav-user-shortcut{height:100%}body.labeler-interface .navbar .navbar-nav li.nav-user-dropdown img,body.labeler-interface .navbar .navbar-nav li.nav-user-dropdown .divider{display:none}body.labeler-interface .navbar .navbar-nav li.nav-user-dropdown a .nav-user-company{font-size:unset !important;line-height:unset !important}body.labeler-interface .navbar .navbar-nav li.nav-user-dropdown a{padding:15px 10px}body.labeler-interface .navbar .nav-user-dropdown__title{color:#d9d9d9;padding-right:10px;font-size:15px;max-width:unset}body.labeler-interface .navbar .nav-user-dropdown__title .caret{color:#d9d9d9}body.labeler-interface .navbar .nav-user-dropdown__title *:first-child{display:none}.look-up-container *:not(.header){border-radius:4px}.look-up-container .load-data{padding:10px}@media screen and (max-width: 992px){.look-up-container .load-data{padding:10px 0 !important}}.look-up-container .load-overlay{background-color:rgba(238,238,238,.7490196078)}.look-up-container .form-section{border:1px solid #ddd;margin-top:10px;background-color:#fcfcfc}.look-up-container .item-list{max-height:calc(100vh - 70px);overflow:auto}.look-up-container .item-list .item:not(.mark):not(.inactive){background-color:#fff}.look-up-container .item-list .item{transition:.5s;animation:highlight .5s ease-out;display:grid;grid-template-columns:auto min-content min-content;column-gap:5px;font-size:1.1em;border:1px solid #ddd;padding:10px;margin-bottom:4px;cursor:pointer;position:relative}.look-up-container .item-list .item .item-price,.look-up-container .item-list .item .item-stock{font-weight:bold;background-color:var(--theme-blue--dark-bg);color:#fff;padding:2px 8px;margin-right:4px}.look-up-container .item-list .item.inactive span.item-price{filter:blur(1px);background-color:red}.look-up-container .item-list .item .item-stock{background-color:#777}.look-up-container .item-list .item .item-main{grid-row:1;grid-column:1}.look-up-container .item-list .item .item-labels{grid-column:1;grid-row:2;align-self:center}.look-up-container .item-list .item .btn{grid-row:1/span 2;border:none}.look-up-container .item-list .item .btn-yellow{grid-column:3}.look-up-container .item-list .item:last-child{margin-bottom:30px;animation:highlight .5s ease-out,emphasizeItem .5s ease-in-out 5s backwards}.look-up-container .item-list .item.inactive{background-color:#f8d7da !important}.look-up-container .item-list .item.mark{background-color:#fcf8e3 !important}.look-up-container .item-list .item:hover{background-color:#f1f1f1 !important}.look-up-container .item-list .item *:empty:not(i){display:none}.look-up-container .item-list .item .item-price{margin-right:4px;border-radius:4px;transition:.5s}.look-up-container .item-list .item:last-child .item-price{animation:emphasizePrice .5s ease-in-out 5s backwards}.look-up-container .item-labels{font-size:.8em;color:#666}.look-up-container .item-labels span{margin-right:10px}.look-up-container .form-group{position:relative}.look-up-container .ready-for-scan{opacity:0;transition:.5s;position:absolute;right:0%;width:80px;text-align:right;color:var(--theme-orange--base-bg);padding-top:35px;text-transform:lowercase}.look-up-container #barcode:focus:placeholder-shown+.ready-for-scan{opacity:1}.container.width-auto>.row{padding:5px 0px;border-bottom:1px solid #eee}.keyboard{display:grid;background-color:#f5f5f5;padding:10px;grid-template-columns:repeat(3, 1fr);gap:10px;width:200px;margin:0px auto}.keyboard>*{padding:10px;font-size:18px}.list-group{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-top:15px}.list-group .label p:empty:nth-of-type(1)::before{content:" ";display:block;background:#999;position:static;height:15px;width:120px}.list-group .label.barcodeOnly p:empty:nth-of-type(1)::before{height:50px}.list-group .label .barcode.dm{background:#999}.list-group .label.fridge::after{content:"";height:20px;width:100%;background-image:url("https://one-pro-public-bucket.s3.eu-central-1.amazonaws.com/ONE/css/scissors-icon.png");background-size:15% 100%;background-repeat:no-repeat;background-position:94% 50%;position:absolute;bottom:4.6mm;opacity:.7}.list-group .label{border:1px solid #ff9b79}.list-group .label-preview:has(.half){position:relative;display:inline-flex}.list-group .label-preview:has(.half)::after{content:"";height:100%;width:20px;background-image:url(https://one-pro-public-bucket.s3.eu-central-1.amazonaws.com/ONE/css/scissors-icon-v.png);background-size:100% 25%;background-repeat:no-repeat;background-position:50% 86%;position:absolute;left:calc(100% - 10px);margin-right:-10px;z-index:1;opacity:.7}@keyframes emphasizeItem{from{font-size:1.2em}}@keyframes emphasizePrice{from{margin-left:-10px;padding-left:10px;border-radius:0px 5px 5px 0px;background-color:#000}}@keyframes highlight{from{background-color:#1b6aaa;color:#fff;filter:opacity(0.5)}}',document.head.appendChild(e)}}window.addEventListener("load",(()=>{new f,setTimeout((()=>{null!=window.clarity&&window.clarity("stop")}),500)}))}();
