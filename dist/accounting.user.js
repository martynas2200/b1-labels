// ==UserScript==
// @name              B1 Accounting Tools
// @namespace         http://tampermonkey.net/
// @homepage          https://github.com/martynas2200/b1-labels
// @version           2.0.0
// @description       Additional accounting and inventory management tools
// @author            Martynas Miliauskas
// @match             https://www.b1.lt/*
// @icon              https://b1.lt/favicon.ico
// @connect           b1.lt
// @connect           raw.githubusercontent.com
// @downloadURL       https://raw.githubusercontent.com/martynas2200/b1-labels/main/dist/accounting.user.js
// @updateURL         https://raw.githubusercontent.com/martynas2200/b1-labels/main/dist/accounting.user.js
// @grant             GM.setValue
// @grant             GM.getValue
// @grant             unsafeWindow
// @grant             GM_xmlhttpRequest
// @license           GNU GPLv3
// ==/UserScript==

!function(){"use strict";class e{$uibModal;$rootScope;modalInstance=null;constructor(){const e=angular.element(document.body).injector();this.$uibModal=e.get("$uibModal"),this.$rootScope=e.get("$rootScope")}async showModal(e){const t=this.$rootScope.$new(!0);return e.scopeProperties&&Object.defineProperties(t,Object.entries(e.scopeProperties).reduce(((t,[i,a])=>({...t,[i]:{get:()=>e.scopeProperties[i],set:t=>e.scopeProperties[i]=t,enumerable:!0,configurable:!0}})),{})),this.modalInstance=this.$uibModal.open({animation:!0,template:e.template,scope:t,size:e.size||"lg",backdrop:e.backdrop||"static",windowClass:e.windowClass||""}),t.closeModal=()=>{this.modalInstance.close(),t.$destroy(),e.onClose?.()},this.modalInstance.result}}const t={en:{barcode:"Barcode",error:"Error",failed:"Failed",found:"found",invalidId:"Invalid ID",itemCreated:"Item created",itemNotFound:"Item not found!",items:"items",itemUpdated:"Item updated",loading:"Loading...",multipleItemsFound:"Multiple items found",newPriceIs:"New price is",nlabelsToBePrinted:"labels to be printed",noData:"No data to print!",notAllItemsActive:"Not all items are active; Do you want to proceed?",oddNumberOfItems:"Odd number of items; Do you want to proceed?"},lt:{barcode:"Barkodas",error:"Įvyko klaida",failed:"Nepavyko",found:"rasta",invalidId:"Neteisingas ID",itemCreated:"Prekė sukurta",itemNotFound:"Prekė nerasta!",items:"prekės",itemUpdated:"Prekė atnaujinta",loading:"Kraunama...",multipleItemsFound:"Rasta daugiau negu viena prekė!",newPriceIs:"Nauja kaina yra",nlabelsToBePrinted:"etiketės spausdinimui",noData:"Nepakanka duomenų spausdinimui!",notAllItemsActive:"Ne visos prekės aktyvios, ar norite tęsti?",oddNumberOfItems:"Nelyginis prekių skaičius, ar norite tęsti?"}},i="lt"===navigator.language.split("-")[0]?"lt":"en",a=e=>t[i]?.[e]??t.en[e]??e;class n{static injector=null;static getInjector(){if(this.injector)return this.injector;const e=document.querySelector("[ng-app]");if(!e)throw new Error("Angular app not found");return this.injector=angular.element(e).injector(),this.injector}static getService(e){return this.getInjector().get(e)}}class r{notifier;items={};baseUrl="https://www.b1.lt";path="/reference-book/items/search";csrfToken;headers;turnstileService;constructor(e){this.notifier=e,this.turnstileService=n.getService("turnstileService");const t=document.querySelector('meta[name="csrf-token"]');this.csrfToken=null!=t?t.content:"",this.headers={accept:"application/json, text/plain, */*","accept-language":"en-GB,en;q=0.9,lt-LT;q=0.8,lt;q=0.7,en-US;q=0.6","content-type":"application/json;charset=UTF-8",origin:this.baseUrl,referer:this.baseUrl,"sec-fetch-dest":"empty","sec-fetch-mode":"cors","sec-fetch-site":"same-origin","x-requested-with":"XMLHttpRequest","x-csrf-token":this.csrfToken,cookie:""}}buildRequestBody(e,t=20){return{pageSize:t,filters:{groupOp:"AND",rules:e},allSelected:!1,asString:"",page:1}}async fetchData(e,t,i){if(""===this.csrfToken)return console.error("CSRF token is missing"),void this.notifier.error("CSRF token is missing");const n=t.split("/");n.pop(),this.headers.referer=`${this.baseUrl}${n.join("/")}`,this.getCookies();try{const n=await fetch(`${this.baseUrl}${t}`,{method:e,headers:this.headers,body:JSON.stringify(i)});if(n.ok)return await n.json();if("challenge"===n.headers.get("cf-mitigated")||403===n.status){if(await this.handleChallenge())return console.info("Challenge handled, repeat the request"),await this.fetchData(e,t,i)}else console.error("Request failed with status:",n.status),this.notifier.error({title:a("error"),message:n.statusText})}catch(e){console.error("Error:",e),this.notifier.error("Error: "+e)}}getCookies(){document.cookie.split(";").map((e=>e.trim())).forEach((e=>{const[t,i]=e.split("=");["YII_CSRF_TOKEN","b1-device_id","b1-session_id","b1-use-cookies","b1-wss_srv","b1-ref_url","cf_clearance","_ga"].includes(t.trim())&&(this.headers.cookie=this.headers.cookie.length>0?`${this.headers.cookie}; ${t}=${i}`:`${t}=${i}`)}))}isItDigits(e){return/^\d+$/.test(e)}async getItem(e){if(!this.isItDigits(e))return this.notifier.error("Invalid barcode"),null;if(Object.keys(this.items).includes(e)){const t=this.items[e].retrievedAt;if(null!=t&&e.length>10&&(new Date).getTime()-t.getTime()<3e4)return{...this.items[e]};if(null!=t&&e.length<10&&(new Date).getTime()-t.getTime()<6e4)return{...this.items[e]}}const t={barcode:{data:e,field:"barcode",op:"0"===e[0]?"cn":"eq"}},i=this.buildRequestBody(t),n=await this.fetchData("POST",this.path,i);return null==n||null==n.data[0]?null:(n.data[0].retrievedAt=new Date,this.items[e]=n.data[0],n.data.length>1&&this.notifier.warning({title:a("multipleItemsFound"),delay:2e4,message:a("barcode")+" "+e+" "+a("found")+" "+n.data.length+" "+a("items")}),n.data[0])}async getRecentItems(){const e=this.buildRequestBody({isActive:{data:!0,field:"isActive",op:"eq"}},20);e.sort={id:"desc"};const t=await this.fetchData("POST",this.path,e);return t&&t.data&&t.data.forEach((e=>{e.retrievedAt=new Date,this.items[e.barcode]=e})),t.data||[]}async getItemsByIds(e){const t={id:{data:e,field:"id",op:"in"}},i=this.buildRequestBody(t,20),a=await this.fetchData("POST",this.path,i);return a&&a.data&&a.data.forEach((e=>{e.retrievedAt=new Date,this.items[e.barcode]=e})),a.data||[]}async saveItem(e,t){if(!this.isItDigits(e))return this.notifier.error(a("invalidId")),!1;const i=await this.fetchData("POST",`/reference-book/items/update?id=${e}`,t);return 200===i.code?this.notifier.success({title:a("itemUpdated"),message:a("newPriceIs")+" "+t.priceWithVat,delay:15e3}):this.notifier.error({title:a("failedToUpdateItem"),message:i.message}),200===i.code}async createItem(e){const t=await this.fetchData("POST","/reference-book/items/create",e);return 200===t.code?(this.notifier.success(a("itemCreated")),setTimeout((()=>{this.saveItem(t.data.id,{isActive:!0})}),400)):this.notifier.error({title:a("failedToCreateItem"),message:t.message}),200===t.code}async getSales(e){const t={operationTypeName:{data:e,field:"operationTypeName",op:"cn"}},i=this.buildRequestBody(t,20);i.sort={saleDate:"desc"};return this.fetchData("POST","/warehouse/light-sales/search",i)}getSaleItems(e){const t={lightSaleId:{field:"lightSaleId",op:"eq",data:e}},i=this.buildRequestBody(t,-1);return this.fetchData("POST","/warehouse/light-sale-items/search",i)}async handleChallenge(){try{return await this.turnstileService.render(),console.info("Turnstile challenge passed!"),!0}catch(e){return console.error("Turnstile challenge failed.",e),!1}}}class s{notificationService;constructor(){try{this.notificationService=n.getService("Notification")}catch(e){console.error("Failed to get Notification service",e),this.notificationService={info:e=>alert(e),error:e=>alert(e),success:e=>alert(e),warning:e=>alert(e),primary:e=>alert(e)}}}info(e){this.notificationService.info(e)}error(e){this.notificationService.error(e)}success(e){this.notificationService.success(e)}warning(e){this.notificationService.warning(e)}primary(e){this.notificationService.primary(e)}}class o{wereButtonsAdded=!1;notification=new s;currentUrl;constructor(){this.currentUrl=window.location.pathname,this.init(),this.handleUrlChange(null,this.currentUrl)}init(){this.handleUrlChange(null,this.currentUrl),this.addStyles()}async handleUrlChange(e,t,i=0){"/login"==this.currentUrl||this.wereButtonsAdded||(this.wereButtonsAdded=this.addButton("Rodyti antkainius",this.listMarkup.bind(this))&&this.addButton("Peržiūrėti prekės judėjimą",this.goToItemMovement.bind(this)),!this.wereButtonsAdded&&i<5&&setTimeout((()=>{this.handleUrlChange(null,this.currentUrl,i+1)}),600))}getDataRows(){const e=document.querySelector(".data-rows");if(null==e)throw this.notification.error("Įvyko klaida: nepavyko rasti duomenų eilučių"),new Error("Data rows not found");return e}goToItemMovement(){const e=this.getDataRows(),t=angular.element(e).controller(),i=(t.data??t.grid.data).filter((e=>e._select)).pop();if(null==i)return void this.notification.error("Pasirinkite prekę");if(null==i.id&&null==i.itemId)return void this.notification.error("Prekės ID nerastas");const a=new URL("/warehouse/item-movement",window.location.origin);a.searchParams.append("itemId",i.itemId??i.id),a.searchParams.append("itemName",i.name??i.itemName),a.searchParams.append("warehouseId","1"),a.searchParams.append("warehouseName","Pagrindinis"),window.open(a.toString(),"_blank")}calculateMarkup(e,t){return(e-t)/t*100}async listMarkup(){if("/en/warehouse/purchases/edit"!==window.location.pathname&&"/warehouse/purchases/edit"!==window.location.pathname)return void this.notification.error("Įvyko klaida: ši funkcija veikia tik pirkimo sąskaitų peržiūros lange");const t=angular.element(this.getDataRows()).controller();(new e).showModal({template:'\n      <div class="modal-header">\n        <button type="button" class="close" ng-click="closeModal()">&times;</button>\n        <h4 class="modal-title">Antkainių sąrašas</h4>\n      </div>\n      <div class="modal-body extd-grid">\n        <table class="table table-bordered">\n          <thead>\n            <tr>\n              <th>Pavadinimas</th>\n              <th class="width-100-strict">Kaina be PVM</th>\n              <th class="width-100-strict">Antkainis</th>\n              <th class="width-130-strict">Pardavimo kaina su PVM</th>\n              <th class="width-100-strict">Min. kaina 20%</th>\n            </tr>\n          </thead>\n          <tbody>\n            <tr ng-repeat="item in data">\n              <td>{{ item.itemName }}</td>\n              <td>{{ item.priceWithoutVatWithDiscount.toFixed(3) }}</td>\n              <td ng-class="{ \'background-white-red\': calculateMarkup(item.itemPriceWithVat, item.priceWithoutVatWithDiscount * (1 + (item.vatRate / 100))) < 19.5 }">{{ calculateMarkup(item.itemPriceWithVat, item.priceWithoutVatWithDiscount * (1 + (item.vatRate / 100))).toFixed(2) }}%</td>\n              <td>\n                <span>{{ item.itemPriceWithVat == null ? "-" : item.itemPriceWithVat }}</span>\n                <button class="btn btn-xs btn-primary pull-right" style="margin-left: 10px;" ng-click="editPrice(item)">Keisti</button>\n              </td>\n              <td>{{ (item.priceWithoutVatWithDiscount * (1 + (item.vatRate / 100)) * 1.2).toFixed(3) }}</td>\n            </tr>\n          </tbody>\n        </table>\n      </div>\n      <div class="modal-footer">\n        <button type="button" class="btn btn-default" ng-click="closeModal()">Uždaryti</button>\n      </div>\n      ',scopeProperties:{data:t.data,calculateMarkup:this.calculateMarkup,editPrice:this.editPrice.bind(this)},size:"lg",backdrop:"static",onClose:()=>{console.log("Modal closed")}})}addButton(e,t){const i=document.querySelector(".breadcrumbs");if(null!=i){const a=document.createElement("button");a.textContent=e,a.className="btn btn-sm",a.addEventListener("click",t),i.appendChild(a)}return null!=i}async editPrice(e){const t=window.prompt("Įveskite naują kainą",e.itemPriceWithVat?.toString()??"");if(null==t)return;const i=parseFloat(t.replace(",","."));if(i<=0)this.notification.error("Neteisinga kaina");else{e.itemPriceWithVat=i;let t=i/1.21;t=Math.round(1e4*(t+Number.EPSILON))/1e4;const a={isActive:!0,priceWithVat:i,priceWithoutVat:t};new r(this.notification).saveItem(e.itemId.toString(),a)}}addStyles(){const e=document.createElement("style");e.innerHTML='ng-form textarea.form-control.input-sm.ng-pristine.ng-untouched.ng-valid{height:50px}ng-form label:has(input[name=isActive]){margin-left:-0.5em}ng-form input[name=isActive].ace+span{background-color:#b74635;color:#fff;padding:.75em 5em .75em .5em;border-radius:4px}ng-form input[name=isActive].ace:checked+span{background-color:#fff;color:inherit}ng-form.simplified-form h5.header.blue,ng-form .alert.alert-warning{display:none}.row[ng-controller="CashRegisterSaleEdit as c"] .row .row .col-lg-6{display:none}',document.head.appendChild(e)}}window.addEventListener("load",(()=>{new o}))}();
